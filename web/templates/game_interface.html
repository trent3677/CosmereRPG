<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeverEndingQuest</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #2c2c2c;
            padding: 10px 20px;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-family: 'Cinzel', Georgia, serif;
            font-weight: 600;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #50C878, #00A86B, #2E8B57, #50C878);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmerEmerald 3.5s ease infinite;
            filter: drop-shadow(0 0 15px rgba(80, 200, 120, 0.5));
            text-shadow: none;
        }
        
        @keyframes shimmerEmerald {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .header h1 span {
            background: inherit;
            background-size: inherit;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .location-info {
            color: #FFA500;
            font-size: 14px;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .location-name {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .location-details {
            color: #888;
            font-size: 12px;
            margin-top: 2px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #555;
        }
        
        .status-indicator.connected {
            background-color: #4CAF50;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }
        
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
            margin: 10px;
            background-color: #2c2c2c;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .panel-header {
            background-color: #333;
            padding: 5px 10px 8px 10px; /* Moderate bottom padding */
            font-weight: bold;
            border-bottom: none; /* Removed since we're adding a custom divider */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap; /* CHANGE: This is the key fix to prevent wrapping */
            gap: 15px;
            overflow: hidden; /* Prevent content from extending outside */
        }
        
        /* Header Divider Line with Fading Edges */
        .header-divider-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(100, 180, 255, 0.3) 10%,
                rgba(100, 180, 255, 0.6) 30%,
                #64B4FF 50%,
                rgba(100, 180, 255, 0.6) 70%,
                rgba(100, 180, 255, 0.3) 90%,
                transparent 100%
            );
            position: relative;
            box-shadow: 0 0 8px rgba(100, 180, 255, 0.4);
            margin-top: 4px; /* Reduced from 8px */
            margin-bottom: 2px; /* Reduced from 4px */
        }
        
        /* New Combat Round Box Styles */
        .combat-round-box {
            flex-shrink: 0; /* Prevent it from shrinking */
            width: 85px;
            height: 60px;
            background-color: #1e1e1e; /* Dark, recessed color */
            border: 2px solid #555;
            border-radius: 6px;
            padding: 4px;
            margin-right: 15px; /* Space between it and the initiative tracker */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.6); /* Inset shadow for recessed look */
        }

        .combat-round-title {
            font-family: 'Cinzel', Georgia, serif;
            font-size: 13px;
            font-weight: bold;
            color: #FFA500; /* Orange/gold color for emphasis */
            letter-spacing: 1px;
            line-height: 1;
        }

        .combat-round-separator {
            width: 80%;
            height: 1px;
            background-color: #444;
            margin: 2px 0;
        }

        .combat-round-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            line-height: 1;
        }

        .combat-round-number {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50; /* Green to match other positive stats */
            line-height: 1.1;
        }
        
        /* Adventure/Exploration Box Styles (non-combat) */
        .adventure-box {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            background-color: #1e1e1e;
            border: 2px solid #555;
            position: relative;
            overflow: hidden;
            border-radius: 6px;
            padding: 0;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.6);
        }
        
        .adventure-box-title {
            font-family: 'Cinzel', Georgia, serif;
            font-size: 12px;
            font-weight: bold;
            color: #4CAF50; /* Green for exploration */
            letter-spacing: 1px;
            line-height: 1;
        }
        
        .adventure-box-separator {
            width: 80%;
            height: 1px;
            background-color: #444;
            margin: 2px 0;
        }
        
        .adventure-box-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            position: relative;
        }
        
        .time-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        
        .adventure-box-overlay {
            display: none; /* Removed overlay */
        }
        
        .adventure-box-title, .adventure-box-separator, .adventure-icon {
            position: relative;
            z-index: 2;
        }
        
        .adventure-icon {
            font-size: 24px;
            line-height: 1;
        }
        
        /* Party Display Styles (non-combat) */
        .party-display-container {
            display: flex;
            align-items: center;
            gap: 6px;  /* Small gap between boxes for visual separation */
            flex: 1;
            min-width: 0; /* Critical for flexbox to allow shrinking */
            justify-content: flex-start;
            margin: 0 10px 0 0;
            overflow-x: scroll; /* Allow programmatic scrolling */
            overflow-y: hidden; /* Prevent vertical overflow */
            padding-bottom: 0;
            max-height: 60px; /* Match the box height */
            
            /* Hide the default scrollbar */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        
        .party-display-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        
        /* --- START: Styles for Custom Scroller Arrows --- */
        .scroller-wrapper {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .scroller-content {
            flex: 1;
            min-width: 0;
            overflow: hidden; /* This is crucial to hide the overflowing content */
            display: flex;
        }

        .scroll-arrow {
            background-color: rgba(44, 44, 44, 0.8);
            border: 1px solid #666;
            color: #e0e0e0;
            cursor: pointer;
            width: 20px; /* Narrow as requested */
            height: 60px; /* Match the item height */
            font-size: 16px;
            font-weight: bold;
            z-index: 10;
            transition: background-color 0.2s;
            flex-shrink: 0;
            padding: 0;
            line-height: 58px; /* Center the arrow vertically */
        }

        .scroll-arrow:hover {
            background-color: #555;
        }
        /* --- END: Styles for Custom Scroller Arrows --- */
        
        /* Initiative Tracker Styles (combat) */
        .initiative-tracker-container {
            display: flex;
            align-items: center;
            gap: 6px;  /* Small gap between boxes for visual separation */
            flex: 1;
            min-width: 0; /* Critical for flexbox to allow shrinking */
            justify-content: flex-start;
            margin: 0 10px 0 0;
            overflow-x: scroll; /* Allow programmatic scrolling */
            overflow-y: hidden; /* Prevent vertical overflow */
            padding-bottom: 0;  /* Removed bottom padding */
            max-height: 60px; /* Match the box height */
            
            /* Hide the default scrollbar */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        
        .initiative-tracker-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        
        #panel-header-label {
            flex-shrink: 0; /* Prevents the label from shrinking */
            white-space: nowrap; /* Prevents text wrapping */
            margin-right: 15px; /* Space between label and other elements */
        }

        /* Party member boxes (non-combat) */
        .party-member-item {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            border: 2px solid #555;
            background-color: #1e1e1e;
            color: #ccc;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            padding: 2px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .party-member-item.player {
            border-color: #ff9800;  /* Orange for player */
            box-shadow: 0 0 5px rgba(255, 152, 0, 0.3);
        }
        
        .party-member-item.npc {
            border-color: #4CAF50;  /* Green for NPCs */
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        
        .party-member-item {
            transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }
        
        .party-member-item:hover, .party-member-item.preserve-hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }

        /* Location NPC boxes (non-combat) */
        .location-npc-item {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            border: 2px solid #9C27B0;  /* Distinct purple border */
            background-color: #1e1e1e;
            color: white;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            padding: 2px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 0.8; /* Slightly faded to show they aren't party members */
        }

        .location-npc-item {
            transition: transform 0.15s ease-in-out, opacity 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .location-npc-item:hover, .location-npc-item.preserve-hover {
            transform: scale(1.05);
            opacity: 1;
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.5);
        }
        
        /* Initiative boxes (combat) */
        .initiative-item {
            flex-shrink: 0;
            width: 60px;  /* Increased from 55px (10% increase rounded) */
            height: 60px; /* Increased from 55px (10% increase rounded) */
            border: 2px solid #555;
            background-color: #1e1e1e;
            color: #ccc;
            display: flex;
            align-items: flex-end;  /* Align to bottom */
            justify-content: center;
            font-size: 11px;  /* Increased from 10px (10% increase) */
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            padding: 2px;  /* Small padding */
            transition: all 0.3s ease;
            cursor: default;
            position: relative;
            overflow: hidden;
        }
        
        .initiative-item-text {
            width: 100%;
            word-wrap: break-word;
            line-height: 1.1;
            margin-bottom: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8), -1px -1px 2px rgba(0,0,0,0.8);
        }

        /* Color-coding for different types of combatants */
        .initiative-item.player { 
            border-color: #4a90e2; 
            background-color: rgba(74, 144, 226, 0.1); 
        }
        
        .initiative-item.npc { 
            border-color: #4CAF50; 
            background-color: rgba(76, 175, 80, 0.1); 
        }
        
        .initiative-item.enemy { 
            border-color: #f44336; 
            background-color: rgba(244, 67, 54, 0.1); 
        }

        /* The "glow" style for the active turn */
        .initiative-item.active {
            border-color: #FFA500;
            background-color: #3a3a3a;
            color: #FFA500;
            transform: scale(1.08);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.7);
            z-index: 5;
        }
        
        /* Skeleton-specific initiative item */
        .initiative-item.skeleton {
            background-image: url('/static/media/videos/skeleton_thumb.jpg');
            background-size: cover;
            background-position: center;
            cursor: pointer;
            color: white;
            text-shadow: 1px 1px 2px black, -1px -1px 2px black;
        }
        
        .initiative-item.skeleton:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        /* Video popup styles - hover-activated preview */
        .video-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            
            /* Control visibility with opacity and a transition */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0s 0.2s;
        }

        .video-popup.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease-in-out;
        }

        .video-popup-content {
            position: absolute; /* This will be positioned by JavaScript */
            width: 350px;
            border: 3px solid #FFA500;
            border-radius: 8px;
            background: #1a1a1a;
            padding: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.7);
            pointer-events: auto; /* Ensure clicks on content don't close popup */
        }

        #popup-video {
            width: 100%;
            height: auto;
            display: block; /* Removes any extra space below the video */
            border-radius: 5px;
        }
        
        /* Dice Rolling Strip - Inline with header */
        .dice-strip-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0; /* ADD THIS: Prevents the dice container from shrinking */
        }
        
        .dice-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 0;  /* Removed negative margin to prevent layout issues */
        }
        
        .dice-label {
            position: relative;
            text-align: center;
            margin-bottom: 2px;  /* Further reduced from 4px */
            padding: 3px 0;  /* Further reduced from 5px */
            width: 100%;  /* Ensure full width */
        }
        
        .dice-label::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, 
                transparent 0%, 
                #FFA500 10%, 
                #FFA500 40%, 
                transparent 40%, 
                transparent 60%, 
                #FFA500 60%, 
                #FFA500 90%, 
                transparent 100%);
            z-index: 0;  /* Ensure it's behind the text */
        }
        
        .dice-label-text {
            position: relative;
            background: #333;  /* Must match panel-header background */
            padding: 2px 20px;
            color: #FFA500;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid #FFA500;
            border-radius: 3px;
            z-index: 1;  /* Ensure it's above the line */
            display: inline-block;  /* Ensure proper inline display */
        }
        
        .dice-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .dice-button {
            background: linear-gradient(145deg, 
                rgba(38, 97, 156, 0.4), 
                rgba(25, 118, 210, 0.5), 
                rgba(13, 71, 161, 0.6));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 50px;
            box-shadow: 
                0 4px 6px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.6),
                inset 0 -1px 0 rgba(25, 118, 210, 0.3);
            text-shadow: 
                -1px -1px 1px rgba(255, 255, 255, 0.5),
                1px 1px 2px rgba(0, 0, 0, 0.8),
                0 0 3px rgba(0, 0, 0, 0.5) inset;
            position: relative;
            overflow: hidden;
        }
        
        .dice-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            transition: left 0.5s;
        }
        
        .dice-button:hover {
            background: linear-gradient(145deg, 
                rgba(38, 97, 156, 0.6), 
                rgba(25, 118, 210, 0.7), 
                rgba(13, 71, 161, 0.8));
            transform: translateY(-1px);
            box-shadow: 
                0 6px 12px rgba(25, 118, 210, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.7),
                inset 0 -1px 0 rgba(25, 118, 210, 0.4);
        }
        
        .dice-button:hover:before {
            left: 100%;
        }
        
        .dice-button:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(25, 118, 210, 0.3);
        }
        
        .dice-clear-button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        
        .dice-clear-button:hover {
            background-color: #da190b;
        }
        
        /* Module Toolkit Button - Themed with metallic grey */
        .toolkit-button {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            margin-right: 0;
            padding: 8px 12px;
            background: linear-gradient(135deg, #555 0%, #333 100%); /* Metallic grey gradient */
            color: #e0e0e0;
            border: 1px solid #777;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .toolkit-button:hover {
            transform: translateY(-2px);
            border-color: #FFA500; /* Orange border on hover */
            background: linear-gradient(135deg, #666 0%, #444 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 10px rgba(255, 165, 0, 0.5); /* Orange glow */
        }
        
        .toolkit-button svg {
            width: 20px;
            height: 20px;
        }
        
        .dice-results {
            background-color: #1a1a1a;
            border-bottom: 1px solid #444;
            padding: 8px 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            color: #e0e0e0;
        }
        
        .dice-result-item {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 3px;
        }
        
        .dice-total {
            color: #FFA500;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            width: 100%;
        }
        
        /* Token usage header - fixed at top of debug panel */
        .token-usage-header {
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, #1a1a1a, #0f0f0f);
            border-bottom: 2px solid #444;
            padding: 8px 12px;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .token-stats {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #e0e0e0;
        }
        
        .token-label {
            color: #888;
            font-weight: bold;
        }
        
        #tpm-value, #rpm-value, #total-tokens {
            color: #4CAF50;
            font-weight: bold;
            min-width: 60px;
            text-align: left;
        }
        
        .token-separator {
            color: #555;
        }
        
        /* Make debug output scrollable below the header */
        .debug-scrollable {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            width: 100%;
            height: calc(100% - 50px); /* Account for header height */
        }
        
        #debug-tab {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Inventory Tab - Simplified Layout */
        #inventory-tab {
            padding: 10px;
            overflow-y: hidden; /* Prevents the whole tab from scrolling */
        }
        
        /* Debug Panel Content - Auto-scroll to bottom */
        
        .game-panel {
            flex: 2;
        }
        
        .debug-panel {
            flex: 1;
            max-width: 500px;
            position: relative; /* Container for absolutely positioned tabs */
            display: flex;
            flex-direction: column;
        }
        
        .input-container {
            display: flex;
            padding: 10px;
            background-color: #333;
            border-top: 1px solid #444;
        }
        
        .input-field {
            flex: 1;
            padding: 8px 12px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .send-button {
            margin-left: 10px;
            padding: 8px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .send-button:hover {
            background-color: #45a049;
        }
        
        .send-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .start-button {
            padding: 8px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .start-button:hover {
            background-color: #1976D2;
        }
        
        .save-load-buttons {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .save-button, .load-button, .reset-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .save-button {
            background-color: #FF9800;
        }
        
        .save-button:hover {
            background-color: #F57C00;
        }
        
        .load-button {
            background-color: #9C27B0;
        }
        
        .load-button:hover {
            background-color: #7B1FA2;
        }

        .reset-button {
            background-color: #f44336; /* Red */
        }

        .reset-button:hover {
            background-color: #d32f2f; /* Darker Red */
        }
        
        .exit-button {
            background-color: #8B0000; /* Dark Red/Maroon */
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 15px;
        }
        
        .exit-button:hover {
            background-color: #660000; /* Darker shade on hover */
        }
        
        /* Image Generation Toggle Styles */
        .image-generation-toggle {
            margin-left: 15px;
            display: flex;
            align-items: center;
        }

        .toggle-label {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-label input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 40px;
            height: 20px;
            background-color: #666;
            border-radius: 20px;
            transition: background-color 0.3s;
            margin-right: 8px;
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-label input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        .toggle-label input:checked + .toggle-slider::after {
            transform: translateX(20px);
        }

        .toggle-text {
            color: #ccc;
            font-size: 13px;
            font-weight: bold;
        }
        
        .save-load-buttons button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        /* Save/Restore Dialog Styles */
        .save-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .save-dialog {
            background-color: #2c2c2c;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            min-width: 500px;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .save-dialog h3 {
            color: #4CAF50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .save-form {
            margin-bottom: 20px;
        }
        
        .save-form label {
            display: block;
            margin-bottom: 5px;
            color: #e0e0e0;
        }
        
        .save-form input, .save-form select, .save-form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background-color: #333;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 4px;
        }
        
        .save-form textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .save-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #1a1a1a;
            padding: 8px;
        }
        
        .save-item {
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #444;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #2c2c2c;
            position: relative;
            overflow: hidden;
        }
        
        .save-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .save-item:hover::before {
            left: 100%;
        }
        
        .save-item:last-child {
            margin-bottom: 0;
        }
        
        .save-item:hover {
            background-color: #3a3a3a;
            border-color: #666;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .save-item.selected {
            background-color: #2d5a2d;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        
        .save-item.selected:hover {
            background-color: #346834;
        }
        
        .save-item-header {
            font-weight: bold;
            color: #4CAF50;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .save-detail-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 5px; /* Spacing between each row */
        }

        .save-detail-row:last-child {
            margin-bottom: 0; /* No margin on the last row for consistent padding */
        }
        
        .save-detail-label {
            color: #aaa; /* Brighter gray for readability */
            font-weight: 600;
            width: 75px; /* Fixed width for perfect alignment */
            flex-shrink: 0;
        }
        
        .save-detail-value {
            color: #e0e0e0;
            word-wrap: break-word;
            flex: 1;
            min-width: 0; /* Prevents long text from breaking the flex layout */
        }
        
        .save-detail-value.date {
            color: #FFA500;
        }
        
        .save-detail-value.module {
            color: #4CAF50;
            font-weight: 600;
        }
        
        .save-detail-value.location {
            color: #87CEEB;
        }
        
        .save-detail-value.mode {
            text-transform: capitalize;
            color: #9C27B0;
        }
        
        .save-detail-value.description {
            font-style: italic;
            color: #ccc;
        }
        
        .save-mode-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: auto;
        }
        
        .save-mode-badge.essential {
            background-color: #2196F3;
            color: white;
        }
        
        .save-mode-badge.full {
            background-color: #FF9800;
            color: white;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        
        .dialog-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .dialog-button.primary {
            background-color: #4CAF50;
        }
        
        .dialog-button.primary:hover {
            background-color: #45a049;
        }
        
        .dialog-button.secondary {
            background-color: #666;
        }
        
        .dialog-button.secondary:hover {
            background-color: #555;
        }
        
        .dialog-button.danger {
            background-color: #f44336;
        }
        
        .dialog-button.danger:hover {
            background-color: #da190b;
        }
        
        .dialog-button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Enhanced Save Dialog Styles */
        .enhanced-save-dialog {
            min-width: 600px;
            max-width: 800px;
        }

        .save-mode-container {
            margin-top: 10px;
        }

        .save-mode-info {
            margin-top: 15px;
            padding: 15px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
        }

        .save-mode-details {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .save-mode-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .save-icon {
            font-size: 18px;
        }

        .recommended-badge {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
            margin-left: auto;
            animation: pulse 2s infinite;
        }

        .archive-badge {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
            margin-left: auto;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        .save-mode-description ul {
            margin: 10px 0;
            padding-left: 0;
            list-style: none;
        }

        .save-mode-description li {
            padding: 4px 0;
            color: #e0e0e0;
            font-size: 14px;
        }

        .save-note {
            margin-top: 12px;
            padding: 8px 12px;
            background-color: #2d4a2d;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
            font-size: 13px;
            color: #c8e6c9;
            font-style: italic;
        }

        .button-icon {
            margin-right: 6px;
        }

        /* Load dialog improvements */
        .save-mode-badge.essential {
            background-color: #2196F3;
            color: white;
        }

        .save-mode-badge.full {
            background-color: #FF9800;
            color: white;
        }

        /* Enhanced Reset Dialog Styles */
        .reset-dialog {
            min-width: 650px;
            max-width: 750px;
        }

        .reset-warning-container {
            margin-bottom: 20px;
        }

        .reset-warning-box {
            background-color: #4a1515;
            border: 2px solid #f44336;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .reset-warning-box strong {
            color: #f44336;
            font-size: 16px;
            display: block;
            margin-bottom: 8px;
        }

        .reset-warning-box p {
            color: #ffcdd2;
            margin: 0;
            font-size: 14px;
        }

        .reset-info-box {
            background-color: #1a2a1a;
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .reset-info-box h4 {
            color: #4CAF50;
            margin: 0 0 10px 0;
            font-size: 15px;
        }

        .reset-action-list {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }

        .reset-action-list li {
            padding: 3px 0;
            color: #e0e0e0;
            font-size: 13px;
        }

        .reset-note-box {
            background-color: #2d4a2d;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
            padding: 12px;
            color: #c8e6c9;
            font-size: 13px;
        }

        .reset-note-box strong {
            color: #4CAF50;
        }

        .reset-note-box code {
            background-color: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #FFD54F;
        }
        
        /* Clean Tavern AI Style Messages */
        .message {
            display: flex;
            align-items: flex-start;
            margin: 25px 0;
            max-width: 100%;
            width: 100%;
            word-wrap: break-word;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            overflow: hidden;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            flex: 1;
            min-width: 0;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .message-author {
            font-weight: bold;
            font-size: 16px;
            margin-right: 8px;
        }
        
        .message-badge {
            background: #4a90e2;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .message-text {
            line-height: 1.4;
            white-space: pre-wrap;
            font-size: 17px;
        }

        /* --- FIX: Ensure consistent font in the main game panel --- */
        .game-panel .message-text {
            font-family: 'Courier New', Courier, monospace;
        }
        
        /* DM Messages */
        .message.narration {
            display: flex;
            align-items: flex-start;
            margin: 25px 0;
        }
        
        .message.narration .message-avatar {
            background: #8b4513;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .message.narration .message-author {
            color: #ffb347;
        }
        
        .message.narration .message-text {
            color: #ffa500;
        }
        
        /* Player Messages */
        .message.user-input {
            display: flex;
            align-items: flex-start;
            margin: 25px 0;
        }
        
        .message.user-input .message-avatar {
            background: #4a90e2;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .message.user-input .message-author {
            color: #4a90e2;
        }
        
        .message.user-input .message-text {
            color: #e8e8e8;
        }
        
        /* System Messages */
        .message.system {
            justify-content: center;
            margin: 20px 0;
            width: 100%;
        }
        
        .message.system .message-content {
            background: #2a2a2a;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #444;
            text-align: center;
            max-width: 500px;
        }
        
        .message.system .message-text {
            color: #aaa;
            font-style: italic;
            font-size: 13px;
        }
        
        /* Error Messages */
        .message.error {
            justify-content: center;
            margin: 20px 0;
        }
        
        .message.error .message-content {
            background: #5a2d2d;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #8b3333;
            text-align: center;
            max-width: 500px;
        }
        
        .message.error .message-text {
            color: #ffaaaa;
            font-size: 13px;
        }
        
        /* Debug Messages (only in debug panel) */
        .message.debug {
            margin: 5px 0;
            font-size: 12px;
        }
        
        .message.debug .message-content {
            background: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        
        .message.debug .message-text {
            color: #888;
            font-size: 12px;
        }
        
        .message.debug.error .message-text {
            color: #ff6b6b;
        }
        
        .timestamp {
            color: #666;
            font-size: 0.8em;
            margin-right: 10px;
        }
        
        /* Image Generation Button Styles */
        .image-generation-button {
            margin: 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            transition: background-color 0.3s;
            box-sizing: border-box;
        }
        
        .image-generation-button:hover {
            background-color: #45a049;
        }
        
        .image-generation-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        .image-generation-button.loading-image {
            background-color: #FFA500;
        }
        
        /* Generated Image Styles */
        .generated-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid #444;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .image-container {
            margin-top: 10px;
            text-align: left;
        }
        
        .image-prompt {
            font-size: 8px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        /* Custom scrollbar for save list */
        .save-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .save-list::-webkit-scrollbar-track {
            background: #222;
            border-radius: 4px;
        }
        
        .save-list::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .save-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Tab styling */
        .tabs {
            display: flex;
            background-color: #333;
            border-bottom: 1px solid #444;
            height: 40px; /* Fixed height to prevent shift */
            flex-shrink: 0; /* Don't allow shrinking */
        }
        
        .tab-button {
            flex: 1;
            padding: 10px;
            background-color: #333;
            color: #888;
            border: none;
            border-right: 1px solid #444;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-button:last-child {
            border-right: none;
        }
        
        .tab-button:hover {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        
        .tab-button.active {
            background-color: #2c2c2c;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        
        .tab-content-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden; /* Prevent wrapper from scrolling */
            min-height: 0; /* Important for flex */
        }

        .tab-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto; /* Default to scrollable */
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
        }
        
        /* --- ADD THIS NEW CSS RULE --- */
        #npcs-tab .panel-content {
            overflow-y: auto; /* Ensure vertical scrolling is enabled */
            height: 100%;     /* Make sure it tries to fill the parent's height */
            padding: 10px;    /* Add some padding for better spacing */
        }
        
        /* MODIFIED */
        #stats-content {
            padding: 0 !important; /* Ensure no top padding */
            background-color: #0a0a0a;
            display: block; /* Ensure block display to prevent flex centering of child */
        }
        
        /* MODIFIED */
        .character-sheet-wrapper {
            transform-origin: top left;
            transition: transform 0.3s ease;
            display: block; /* Explicitly set display type */
            margin: 0;      /* Remove any potential default margins */
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }
        
        /* Inventory styling - modern design matching character sheet */
        .inventory-sheet {
            padding: 8px;
            margin: 0;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.01) 10px,
                    rgba(255, 255, 255, 0.01) 20px
                );
        }
        
        .inventory-header {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #666;
        }
        
        .currency-display {
            text-align: center;
        }
        
        .currency-title {
            font-size: 24px;
            font-weight: 600;
            color: #FFA500;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Cinzel', Georgia, serif;
            margin-bottom: 8px;
        }
        
        .currency-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .currency-item {
            background-color: #2c2c2c;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 4px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .currency-amount {
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
            line-height: 1;
        }
        
        .currency-type {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .currency-total {
            font-size: 16px;
            color: #FFA500;
            font-style: italic;
            margin-top: 4px;
        }
        
        .equipment-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px;
            /* margin-bottom has been removed */
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Storage view button in inventory tab */
        .storage-view-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #4CAF50; /* Cyan color from the old button */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .storage-view-button:hover {
            background-color: #45a049;
        }
        
        .equipment-section h3 {
            margin: 0 0 8px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
            position: sticky;
            top: 0;
            background-color: #2c2c2c;
            z-index: 1;
        }
        
        .inventory-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: auto;
            flex-shrink: 0;
        }
        
        .inventory-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px;
            margin: 0;
        }
        
        .inventory-section h3, .inventory-section h4 {
            margin: 0 0 6px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 3px;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
            position: sticky;
            top: 0;
            background-color: #2c2c2c;
            z-index: 1;
        }
        
        .inventory-item {
            padding: 3px 0;
            border-bottom: 1px solid #222;
            font-size: 12px; /* Was 13px */
            display: flex;
            align-items: baseline;
        }
        
        .inventory-item:last-child {
            border-bottom: none;
        }
        
        .inventory-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .item-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px; /* Was 15px */
        }
        
        .item-qty {
            color: #999;
            font-size: 14px;
            font-style: italic;
        }
        
        .weapon-bonus {
            color: #ff8c00;
            font-weight: bold;
            font-size: 16px;
        }
        
        .item-details {
            font-size: 12px;
            color: #bbb;
            line-height: 1.3;
        }
        
        .item-type {
            color: #777;
            font-style: italic;
            text-transform: capitalize;
            margin-left: 8px;
            font-size: 12px; /* ADD THIS LINE */
        }
        
        .weapon-damage {
            color: #ff8c00;
            font-weight: bold;
            font-size: 15px;
        }
        
        .item-desc {
            color: #ccc;
            margin-top: 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Inventory Controls - Compact Single Line */
        .inventory-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            padding: 6px 12px;
            background-color: #333;
            border-radius: 4px;
            border: 1px solid #444;
            font-size: 13px;
        }
        
        .search-btn, .inventory-sort, .filter-dropdown {
            padding: 4px 8px;
            background-color: #2c2c2c;
            border: 1px solid #555;
            border-radius: 3px;
            color: #e0e0e0;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-btn:hover, .inventory-sort:hover, .filter-dropdown:hover {
            background-color: #3a3a3a;
            border-color: #666;
        }
        
        
        /* Search Popup Modal */
        .search-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .search-popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .search-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-popup-title {
            color: #4CAF50;
            font-size: 16px;
            font-weight: bold;
        }
        
        .search-popup-close {
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .search-popup-close:hover {
            color: #e0e0e0;
        }
        
        .search-popup-input {
            width: 300px;
            padding: 8px 12px;
            background-color: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        .search-popup-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        /* Spells & Magic Items styling */
        .spells-magic-sheet {
            padding: 8px;
            margin: 0;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.01) 10px,
                    rgba(255, 255, 255, 0.01) 20px
                );
        }
        
        .spellcasting-section {
            margin-bottom: 10px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
        }
        
        .spellcasting-section h3 {
            margin: 0 0 8px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
            text-transform: uppercase;
            font-size: 18px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .spell-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            padding: 6px;
            background-color: #1a1a1a;
            border-radius: 4px;
        }
        
        .spell-stats span {
            color: #FFA500;
            font-weight: bold;
            font-size: 14px;
        }
        
        .spell-level-group {
            margin-bottom: 8px;
            background-color: #1a1a1a;
            border-radius: 4px;
            padding: 6px;
        }
        
        .spell-level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            border-bottom: 1px solid #444;
            padding-bottom: 2px;
        }
        
        .spell-level-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .spell-slots {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #333;
        }
        
        .spell-slots.available {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .spell-slots.low {
            color: #FF9800;
            background-color: rgba(255, 152, 0, 0.2);
        }
        
        .spell-slots.exhausted {
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.2);
        }
        
        .spell-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .spell-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2px 4px;
            background-color: #333;
            border-radius: 3px;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .spell-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .spell-name {
            color: #e0e0e0;
            flex: 1;
        }
        
        .spell-badges {
            display: flex;
            gap: 2px;
            margin-left: 4px;
        }
        
        .spell-badge {
            font-size: 9px;
            padding: 1px 3px;
            border-radius: 2px;
            color: white;
            font-weight: bold;
        }
        
        .spell-badge.ritual {
            background-color: #2196F3;
        }
        
        .spell-badge.concentration {
            background-color: #FF9800;
        }
        
        .spell-badge.prepared {
            background-color: #4CAF50;
        }
        
        .magic-items-section {
            margin-top: 10px;
        }
        
        .magic-items-category {
            margin-bottom: 8px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px;
        }
        
        .magic-items-category h4 {
            margin: 0 0 6px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 3px;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .magic-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 3px 4px;
            margin: 2px 0;
            background-color: #1a1a1a;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .magic-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .magic-item-name {
            color: #4CAF50;
            font-weight: bold;
            flex: 1;
        }
        
        .magic-item-charges {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        
        .magic-item-charges.available {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .magic-item-charges.low {
            color: #FF9800;
            background-color: rgba(255, 152, 0, 0.2);
        }
        
        .magic-item-charges.exhausted {
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.2);
        }
        
        .magic-item-charges.consumable {
            color: #fff;
            background-color: #666;
        }
        
        .no-spellcasting-message {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        /* Character Sheet Portrait and Top Section */
        .character-sheet-top {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #666;
            align-items: center;
            width: 100%;
        }

        .character-portrait {
            position: relative;
            width: 150px;
            height: 150px;
            flex-shrink: 0;
            border: 2px solid #444;
            border-radius: 4px;
            background-color: #111;
            overflow: hidden;
            padding: 0; /* Ensure no padding */
            margin: 0; /* Ensure no margin */
            display: block; /* Block display to prevent inline spacing */
        }

        .character-portrait img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            z-index: 1;
        }

        .character-portrait .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            z-index: 2; /* Above the image */
        }

        .character-portrait:hover .upload-overlay {
            opacity: 1;
        }

        #portrait-upload-input {
            display: none;
        }
        
        .character-header-info {
            flex-grow: 1;
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 150px; /* Match portrait height */
        }
        
        .character-sheet {
            padding: 8px;
            margin: 0;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.01) 10px,
                    rgba(255, 255, 255, 0.01) 20px
                );
        }
        
        .character-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: #ccc;
            font-size: 16px;
            line-height: 1.2;
        }
        
        .orange {
            color: #FFA500;
            font-weight: bold;
        }
        
        .character-name {
            font-size: 24px;
            font-weight: 600;
            color: #FFA500;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Cinzel', Georgia, serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1;
            margin: 0 0 6px 0;
            padding-bottom: 6px;
            border-bottom: 1px solid #666;
        }
        
        /* Ability Scores */
        /* MODIFIED */
        .abilities-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin-top: 3px; /* Ensure it's not too far from details */
            margin-bottom: 3px; /* Reduced */
        }
        
        .ability-score {
            background-color: #2c2c2c;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 2px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .ability-score:hover {
            border-color: #FFA500;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 165, 0, 0.2);
        }
        
        .ability-name {
            font-size: 18px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
            line-height: 1;
        }
        
        .ability-value {
            font-size: 36px;
            font-weight: bold;
            color: #e0e0e0;
            margin: 0;
            line-height: 0.9;
        }
        
        .ability-modifier {
            font-size: 20px;
            color: #FFA500;
            border: 1px solid #FFA500;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            background-color: rgba(255, 165, 0, 0.1);
            font-weight: bold;
        }
        
        /* Combat Stats */
        .combat-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin-bottom: 0;
        }
        
        .combat-stat {
            background-color: #2c2c2c;
            border: 1px solid #4CAF50; /* MODIFIED: Green border by default */
            border-radius: 5px;
            padding: 3px;
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s; /* MODIFIED: Added transition */
        }
        
        /* MODIFIED: Added hover effect */
        .combat-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 165, 0, 0.2);
            border-color: #FFA500;
        }

        /* MODIFIED: New class for currency boxes */
        .combat-stat.currency {
            border-color: #FFA500; /* Orange/gold border by default */
        }
        
        .combat-stat-label {
            font-size: 12px; /* MODIFIED: Reduced size */
            color: #888;
            text-transform: uppercase;
            margin: 0;
            line-height: 1;
        }
        
        .combat-stat-value {
            font-size: 24px; /* MODIFIED: Reduced size */
            font-weight: bold;
            color: #4CAF50;
            line-height: 1.1; /* MODIFIED: Adjusted line height */
            margin: 2px 0;
        }
        
        .hp-bar {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            height: 6px;
            margin-top: 1px;
            overflow: hidden;
            width: 90%; /* ADDED: To prevent bar from touching edges */
        }
        
        .hp-fill {
            background-color: #4CAF50;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .hp-fill.low {
            background-color: #f44336;
        }
        
        .hp-fill.medium {
            background-color: #ff9800;
        }
        
        /* Skills and Saves */
        .skills-saves-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 3px; /* MODIFIED: Added margin */
            margin-bottom: 3px;
        }

        /* Skill Tooltip System */
        .skill-tooltip {
            position: fixed;
            z-index: 1000;
            background-color: #1f1f1f;
            border: 1px solid #FFA500;
            border-radius: 6px;
            padding: 10px;
            width: 220px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            color: #e0e0e0;
            font-family: 'Crimson Text', Georgia, serif;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            visibility: hidden;
        }

        .skill-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .skill-tooltip-header {
            font-family: 'Cinzel', Georgia, serif;
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #444;
            text-transform: uppercase;
        }

        .skill-tooltip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 2px;
            font-size: 15px;
        }

        .skill-tooltip-name {
            color: #ccc;
        }

        .skill-tooltip-value {
            color: #e0e0e0;
            font-weight: bold;
        }

        /* Make ability scores hoverable */
        .ability-score:hover {
            border-color: #FFA500;
            cursor: pointer;
            transform: scale(1.05);
        }
        
        .stat-group {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 2px;
            margin: 0;
        }
        
        /* Two-column layout for saving throws */
        .saving-throws-group .stat-group-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 15px;
        }
        
        .stat-group h4 {
            margin: 0 0 2px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding: 2px 4px 2px 4px; /* MODIFIED: Added padding */
            text-transform: uppercase;
            font-size: 18px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .save-item, .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 4px; /* MODIFIED: Adjusted padding */
            margin: 0;
            font-size: 16px; /* MODIFIED: Reduced font size */
            line-height: 1.2; /* MODIFIED: Adjusted line height */
            border-bottom: none; /* MODIFIED: Removed line under items */
        }
        
        .save-item:hover, .skill-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .save-name, .skill-name {
            color: #aaa;
            font-size: 16px; /* MODIFIED: Reduced font size */
        }
        
        .save-value, .skill-value {
            color: #e0e0e0;
            font-weight: bold;
            font-size: 16px; /* MODIFIED: Reduced font size */
        }
        
        .stat-group-content {
            padding-right: 0;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        
        
        /* Features and Abilities */
        .features-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 3px;
            margin-bottom: 3px;
        }
        
        .features-section h4 {
            margin: 0 0 2px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 2px;
            text-transform: uppercase;
            font-size: 24px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .features-abilities-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 3px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            padding: 2px 4px;
            margin: 0;
            font-size: 16px;
            line-height: 1.2;
            cursor: help;
            transition: background-color 0.2s;
        }
        
        .feature-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        /* New Abilities Grid Layout */
        .abilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 5px;
            margin-top: 3px;
        }
        
        /* ADDED: Container for weapons/ammo on character sheet */
        .character-weapons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 3px;
        }

        /* Usage Tracking Styles */
        .feature-item.with-usage {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .feature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .usage-counter {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .usage-counter.exhausted {
            background-color: #f44336;
        }
        
        .feature-refresh {
            font-size: 16px;
            color: #888;
            font-style: italic;
            margin-left: 8px;
        }
        
        /* Effect Item Styles */
        .effect-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 3px 4px;
            margin: 1px 0;
            font-size: 14px;
            line-height: 1.2;
            cursor: help;
            transition: background-color 0.2s;
        }
        
        .effect-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .effect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .effect-duration {
            font-size: 16px;
            color: #FFA500;
            font-style: italic;
            margin-left: 8px;
        }
        
        .effect-duration.expired {
            color: #f44336;
        }
        
        .effect-type {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Effect Badges */
        .effect-badge {
            font-size: 10px;
            padding: 2px 4px;
            margin: 1px;
            border-radius: 3px;
            background-color: #666;
            color: white;
            font-weight: bold;
        }
        
        .effect-badge.resistance {
            background-color: #2196F3;
        }
        
        .effect-badge.bonus {
            background-color: #4CAF50;
        }
        
        /* Health & Conditions Section */
        .health-status-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
        }
        
        .health-status-section h4 {
            margin: 0 0 8px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
            text-transform: uppercase;
            font-size: 18px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .conditions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .condition-category h5 {
            margin: 0 0 4px 0;
            color: #ccc;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .condition-item {
            display: flex;
            align-items: center;
            padding: 3px 4px;
            margin: 1px 0;
            font-size: 13px;
            line-height: 1.2;
            cursor: help;
            transition: background-color 0.2s;
        }
        
        .condition-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .condition-badge {
            font-size: 9px;
            padding: 1px 3px;
            margin-right: 4px;
            border-radius: 2px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .condition-badge.resistance {
            background-color: #2196F3;
        }
        
        .condition-badge.immunity {
            background-color: #4CAF50;
        }
        
        .condition-badge.vulnerability {
            background-color: #f44336;
        }
        
        .healing-requirement {
            font-size: 10px;
            color: #FFA500;
            font-style: italic;
            margin-left: 4px;
        }
        
        .condition-item.injury {
            border-left: 3px solid #f44336;
            padding-left: 6px;
        }
        
        /* Equipment Effects Styling */
        .feature-item.equipment-effect {
            padding: 2px 0;
        }
        
        .feature-bullet {
            color: #FFA500;
            margin-right: 6px;
            font-size: 11px; /* Was 12px */
        }
        
        .feature-name {
            color: #aaa; /* MODIFIED: Matched to skill/save name color */
            font-size: 16px;
        }
        
        /* --- NPC STYLING REFINEMENTS --- */
        .npc-character-sheet {
            margin-bottom: 20px;
            padding: 8px;
            background-color: #2c2c2c;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
        }
        
        .npc-header {
            display: flex;
            justify-content: flex-start; /* MODIFIED: Keeps items together */
            align-items: center;       /* MODIFIED: Vertically aligns items */
            gap: 10px;                 /* MODIFIED: Adds space between boxes */
            margin: 0;
            padding: 0 0 8px 0;
            border-bottom: 2px solid #444;
        }

        .npc-header-main {
            flex-grow: 1; /* MODIFIED: Takes up available space */
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 6px 10px;
        }
        
        .npc-header-xp {
            flex-shrink: 0;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 4px 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .xp-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1;
        }

        .xp-value {
            font-size: 14px;
            color: #FFA500;
            font-weight: bold;
            line-height: 1.2;
        }
        
        .npc-header-currency {
            flex-shrink: 0; /* MODIFIED: Prevents currency box from shrinking */
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 4px;
        }
        
        .npc-header-currency .currency-grid {
            gap: 5px;
        }

        .npc-header-currency .currency-item {
            padding: 2px 4px;
            background-color: #2c2c2c;
            border: 1px solid #444;
        }

        .npc-header-currency .currency-amount {
            font-size: 16px;
        }

        .npc-header-currency .currency-type {
            font-size: 10px;
        }
        
        .npc-name {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin: 0;
            font-family: 'Cinzel', Georgia, serif;
            line-height: 1;
        }
        
        .npc-details {
            font-size: 13px;
            color: #ccc;
            font-style: italic;
            line-height: 1.1;
            margin: 0;
        }
        
        .npc-abilities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 4px;
            margin: 8px 0;
            background-color: #1a1a1a;
            border-radius: 5px;
            padding: 6px;
        }
        
        .npc-abilities .ability-score {
            text-align: center;
            background-color: #333;
            border-radius: 5px;
            padding: 4px 2px;
            min-width: 40px;
            font-size: 12px;
        }
        
        .npc-abilities .ability-name {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
            line-height: 1;
        }
        
        .npc-abilities .ability-value {
            font-size: 18px;
            font-weight: bold;
            color: #e0e0e0;
            margin: 1px 0;
            line-height: 0.9;
        }
        
        .npc-abilities .ability-modifier {
            font-size: 12px;
            color: #FFA500;
            border: 1px solid #FFA500;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px auto 0;
            background-color: rgba(255, 165, 0, 0.1);
            font-weight: bold;
        }
        
        .npc-abilities .npc-combat-stat {
            background-color: #2c2c2c;
            border: 1px solid #4CAF50;
        }
        
        .npc-abilities .npc-combat-stat .ability-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .npc-abilities .npc-combat-stat .ability-value {
            font-size: 14px;
            color: #4CAF50;
        }
        
        .npc-abilities .npc-combat-stat.npc-no-circle .ability-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .npc-abilities .hp-bar {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 2px;
            height: 4px;
            margin: 2px auto 0 auto;
            overflow: hidden;
            width: 90%;
        }
        
        .npc-abilities .hp-fill {
            background-color: #4CAF50;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .npc-abilities .hp-fill.healthy {
            background-color: #4CAF50;
        }
        
        .npc-abilities .hp-fill.injured {
            background-color: #ff9800;
        }
        
        .npc-abilities .hp-fill.bloodied {
            background-color: #ff5722;
        }
        
        .npc-abilities .hp-fill.critical {
            background-color: #f44336;
        }
        
        .npc-abilities .npc-no-circle .ability-modifier {
            display: none;
        }
        
        .npc-skills-saves-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .npc-detail-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        .npc-detail-button:hover {
            background-color: #45a049;
        }
        
        .npc-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .npc-details-modal-content {
            position: relative;
            background-color: #2c2c2c;
            margin: 10% auto;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            max-height: 70%;
            overflow: hidden;
        }
        
        .npc-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        
        .npc-details-title {
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
        }
        
        .npc-details-close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .npc-details-close:hover {
            color: #fff;
        }
        
        .npc-details-body {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .npc-details-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background-color: #1a1a1a;
            border-radius: 4px;
            cursor: help;
        }
        
        .npc-details-name {
            color: #e0e0e0;
            font-weight: bold;
        }
        
        .npc-details-bonus {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .npc-details-proficient {
            color: #FFA500;
            margin-left: 8px;
        }
        
        .npc-spellcasting {
            margin: 10px 0;
            background-color: #1a1a1a;
            border-radius: 5px;
            padding: 8px;
        }
        
        .npc-spellcasting h4 {
            color: #4CAF50;
            font-size: 16px;
            margin-bottom: 6px;
            border-bottom: 1px solid #444;
            padding-bottom: 3px;
        }
        
        .npc-status {
            margin-top: 10px;
            padding: 8px;
            background-color: #1a1a1a;
            border-radius: 5px;
            text-align: center;
        }
        
        .status-item {
            display: inline-block;
            margin: 0 10px;
            font-size: 14px;
            color: #ccc;
        }
        
        .status-value.alive {
            color: #4CAF50;
        }
        
        .status-value.unconscious {
            color: #FF9800;
        }
        
        .status-value.dead {
            color: #f44336;
        }
        
        .npc-inventory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .npc-inventory-modal-content {
            position: relative;
            background-color: #2c2c2c;
            margin: 5% auto;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
        }
        
        .large-modal-content {
            width: 80%;
            max-width: 90vw;
            height: 85%;
            max-height: 90vh;
        }
        
        .npc-inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        
        .npc-inventory-title {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
        }
        
        .npc-inventory-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .npc-inventory-close:hover {
            color: #fff;
        }
        
        .npc-inventory-body {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }
        
        .npc-inventory-item {
            background-color: #1a1a1a;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #4CAF50;
        }
        
        .npc-inventory-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .npc-inventory-item-name {
            color: #e0e0e0;
            font-weight: bold;
            font-size: 14px;
        }
        
        .npc-inventory-item-quantity {
            color: #4CAF50;
            font-size: 12px;
            background-color: #333;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .npc-inventory-item-details {
            color: #aaa;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .npc-inventory-item-description {
            color: #ccc;
            font-size: 11px;
            font-style: italic;
            margin-top: 2px;
        }
        
        .condition-value {
            color: #FFA500;
            font-weight: bold;
        }
        
        .npc-spell-info {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 8px;
            background-color: #1a1a1a;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }
        
        .npc-spell-stat {
            color: #FFA500;
            font-weight: bold;
            font-size: 14px;
        }
        
        .npc-spell-level {
            margin-bottom: 12px;
            background-color: #1a1a1a;
            border-radius: 4px;
            padding: 8px;
        }
        
        .npc-spell-level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
        }
        
        .npc-spell-level-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .npc-spell-slots {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #333;
        }
        
        .npc-spell-slots.available {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .npc-spell-slots.low {
            color: #FF9800;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .npc-spell-slots.exhausted {
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.1);
        }
        
        .npc-spell-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .npc-spell-item {
            color: #e0e0e0;
            font-size: 13px;
            padding: 2px 4px;
            background-color: #333;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .npc-spell-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        /* Styles for the new NPC Spell Modal */
        #npc-spells-modal-body .spellcasting-section {
            margin-bottom: 10px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
        }
        #npc-spells-modal-body .spellcasting-section h3 {
            margin: 0 0 8px 0; color: #FFA500; border-bottom: 1px solid #444;
            padding-bottom: 4px; text-transform: uppercase; font-size: 18px;
            letter-spacing: 1px; font-family: 'Cinzel', Georgia, serif;
        }
        #npc-spells-modal-body .spell-stats {
            display: flex; gap: 15px; margin-bottom: 10px; padding: 6px;
            background-color: #1a1a1a; border-radius: 4px;
        }
        #npc-spells-modal-body .spell-stats span {
            color: #FFA500; font-weight: bold; font-size: 14px;
        }
        #npc-spells-modal-body .spell-level-group {
            margin-bottom: 8px; background-color: #1a1a1a;
            border-radius: 4px; padding: 6px;
        }
        #npc-spells-modal-body .spell-level-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px;
        }
        #npc-spells-modal-body .spell-level-name {
            color: #4CAF50; font-weight: bold; font-size: 14px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        #npc-spells-modal-body .spell-slots {
            font-size: 12px; font-weight: bold; padding: 2px 6px;
            border-radius: 3px; background-color: #333;
        }
        #npc-spells-modal-body .spell-slots.available { color: #4CAF50; background-color: rgba(76, 175, 80, 0.2); }
        #npc-spells-modal-body .spell-slots.low { color: #FF9800; background-color: rgba(255, 152, 0, 0.2); }
        #npc-spells-modal-body .spell-slots.exhausted { color: #f44336; background-color: rgba(244, 67, 54, 0.2); }
        #npc-spells-modal-body .spell-list {
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px;
        }
        #npc-spells-modal-body .spell-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 2px 4px; background-color: #333; border-radius: 3px;
            font-size: 13px; color: #e0e0e0;
        }
        #npc-spells-modal-body .no-spellcasting-message {
            text-align: center; padding: 20px; color: #888; font-style: italic;
        }
        
        .character-tabs {
            margin-top: 10px;
        }
        
        .tab-nav {
            display: flex;
            background-color: #1a1a1a;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            border: 1px solid #555;
            border-bottom: none;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }

        /* Model Toggle Tooltip */
        .model-tooltip {
            position: fixed;
            z-index: 1000;
            background-color: #2c2c2c;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 12px;
            max-width: 350px;
            color: #d4d4d4;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
        }
        
        .model-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .model-tooltip-header {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #3a3a3a;
            padding-bottom: 5px;
        }
        
        .model-tooltip-content {
            margin-bottom: 8px;
        }
        
        .model-tooltip-warning {
            color: #FFA500;
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #3a3a3a;
        }
        
        /* Spell Tooltip Styles */
        .spell-tooltip {
            position: fixed; /* Takes the tooltip out of the document flow, FIXING THE SHUDDER */
            z-index: 2000;   /* Ensures it appears on top of everything */
            background-color: #1f1f1f;
            border: 1px solid #FFA500;
            border-radius: 6px;
            padding: 12px;
            width: 350px;
            max-width: 90vw;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            color: #e0e0e0;
            font-family: 'Crimson Text', Georgia, serif;
            font-size: 15px;
            line-height: 1.5;
            pointer-events: none; /* Prevents the tooltip from interfering with mouse events */
            transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out;
            opacity: 0; /* Initially invisible */
            transform: translateY(10px); /* Start slightly lower for a nice pop-up effect */
        }

        .spell-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .spell-tooltip-header {
            font-family: 'Cinzel', Georgia, serif;
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin: -4px 0 8px 0;
            padding-bottom: 6px;
            border-bottom: 1px solid #444;
        }

        .spell-tooltip-meta {
            font-size: 13px;
            color: #999;
            font-style: italic;
            margin-bottom: 10px;
        }

        .spell-tooltip-description {
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .spell-tooltip-classes {
            font-size: 12px;
            color: #aaa;
            border-top: 1px solid #444;
            padding-top: 6px;
            margin-top: 10px;
        }
        
        /* --- START: Styles for New Stats Tooltip --- */
        .stats-tooltip {
            position: fixed;
            z-index: 2000;
            background-color: #1f1f1f;
            border: 1px solid #4a90e2; /* Blue border to differentiate from spell tooltips */
            border-radius: 6px;
            padding: 10px;
            width: 220px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            color: #e0e0e0;
            font-family: 'Crimson Text', Georgia, serif;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out;
            transform: translateY(2px);
            visibility: hidden;
        }

        .stats-tooltip.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .stats-tooltip-header {
            font-family: 'Cinzel', Georgia, serif;
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #444;
            text-transform: capitalize;
        }

        .stats-tooltip-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 2px;
            font-size: 15px;
        }

        .stats-tooltip-label {
            color: #aaa;
        }

        .stats-tooltip-value {
            color: #e0e0e0;
            font-weight: bold;
        }
        /* --- END: Styles for New Stats Tooltip --- */
        
        /* --- NEW STORAGE BUTTON AND MODAL STYLES --- */
        .storage-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #00BCD4; /* Cyan */
        }

        .storage-button:hover {
            background-color: #0097A7;
        }

        .storage-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .storage-container {
            background-color: #1a1a1a;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 12px;
            border-left: 3px solid #00BCD4; /* Match button color */
        }

        .storage-container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }

        .storage-name {
            color: #00BCD4;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Cinzel', Georgia, serif;
        }

        .storage-location {
            font-size: 12px;
            color: #888;
            font-style: italic;
        }

        .storage-item-list {
            list-style: none;
            padding-left: 5px;
        }

        .storage-item-entry {
            color: #ccc;
            font-size: 14px;
            padding: 3px 0;
            border-bottom: 1px solid #282828;
        }
        .storage-item-entry:last-child {
            border-bottom: none;
        }

        .storage-item-name {
            color: #4CAF50;
            font-weight: bold;
        }

        .storage-item-quantity {
            color: #999;
        }
        
        /* --- STYLES FOR THE NEW QUEST JOURNAL --- */

        /* The Modal Background (the dark overlay) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px); /* Adds a cool blur effect to the background */
        }

        /* The Book Container */
        .journal-book {
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            width: 90%;
            max-width: 1200px; /* Wide layout */
            height: 80vh;
            max-height: 700px;
            background-color: #3a2e24; /* Dark leather color for the book cover/spine */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(0,0,0,0.4);
            border: 2px solid #5a4e44;
            border-radius: 5px;
        }

        /* The Pages */
        .journal-page {
            flex: 1; /* Each page takes up half the space */
            background-color: #f3e9d2; /* Parchment paper color */
            padding: 25px 35px;
            overflow-y: auto; /* Add scrollbar if content overflows */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.15); /* Inner shadow for depth */
        }

        /* Create a visual spine between the pages */
        #journal-left-page {
            border-right: 2px solid #5c4b3a;
        }

        .page-content {
            color: #4a3a2a;
            font-family: 'Georgia', serif;
        }

        /* The Close Button (top right corner) */
        .close-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1010;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .close-btn:hover {
            color: #ccc;
        }

        /* Typography inside the journal */
        .page-content h2 {
            text-align: center;
            border-bottom: 2px solid #c8bda8;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: normal;
            color: #5c4b3a;
        }

        .quest-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #d8cdaa;
        }

        .quest-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #6a4f3a;
            display: flex;
            align-items: center;
        }

        .quest-title::before {
            content: '○'; /* Open circle for active quests */
            margin-right: 10px;
            font-size: 1.1em;
            color: #b98900;
        }

        .quest-item.completed .quest-title {
            color: #8a7a6a;
            text-decoration: line-through;
        }

        .quest-item.completed .quest-title::before {
            content: '✓'; /* Checkmark for completed quests */
            color: #5cb85c;
        }

        .quest-description {
            font-size: 0.95em;
            line-height: 1.5;
            margin-top: 5px;
            padding-left: 25px; /* Indent description under the title */
        }

        .side-quest-item {
            margin-top: 15px;
            padding: 10px;
            margin-left: 25px;
            border-left: 3px solid #d8cdaa;
            background: rgba(0,0,0,0.03);
        }
        
        /* --- NEW STYLES for Header Control Refactor --- */
        
        /* New container to stack the toggles vertically */
        .toggle-stack {
            display: flex;
            flex-direction: column;
            gap: 4px; /* Creates a small space between the two toggles */
            justify-content: center;
        }
        
        /* Remove the default left margin from toggles now that they are stacked */
        .toggle-stack .image-generation-toggle {
            margin-left: 0;
        }
        
        /* Shrink the toggle slider */
        .toggle-stack .toggle-slider {
            width: 34px;
            height: 18px;
        }
        
        /* Shrink the sliding circle inside the toggle */
        .toggle-stack .toggle-slider::after {
            width: 14px;
            height: 14px;
        }
        
        /* Adjust the sliding distance for the smaller toggle */
        .toggle-stack input:checked + .toggle-slider::after {
            transform: translateX(16px);
        }
        
        /* Shrink the text next to the toggle */
        .toggle-stack .toggle-text {
            font-size: 12px;
        }
        
        /* Remove duplicate style - now handled in main .toolkit-button definition above */
        
        /* Compression Progress Bar Styles */
        .compression-progress-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1e1e1e;
            border: 3px solid #FFA500;
            border-radius: 8px;
            padding: 20px;
            z-index: 10000;
            min-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            display: none;
        }
        
        .compression-progress-container.active {
            display: block;
        }
        
        .compression-progress-title {
            color: #FFA500;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-family: 'Cinzel', serif;
        }
        
        .compression-progress-text {
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            font-style: italic;
            line-height: 1.4;
        }
        
        .compression-progress-bar-container {
            width: 100%;
            height: 24px;
            background-color: #2a2a2a;
            border: 2px solid #444;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .compression-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2d7a2d, #4CAF50, #5cbf5c);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .compression-progress-status {
            color: #b0b0b0;
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
        }
        
        .compression-progress-bar.complete {
            animation: pulse-glow 0.5s ease;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8); }
        }
    </style>
</head>
<body>
    <!-- Compression Progress Bar -->
    <div class="compression-progress-container" id="compression-progress">
        <div class="compression-progress-title">Chronicle Compression</div>
        <div class="compression-progress-text" id="compression-text">
            The Dungeon Master weaves your tales into the grand tapestry...
        </div>
        <div class="compression-progress-bar-container">
            <div class="compression-progress-bar" id="compression-bar"></div>
        </div>
        <div class="compression-progress-status" id="compression-status">
            Preparing compression...
        </div>
    </div>
    
    <div class="header">
        <h1>Never<span>Ending</span>Quest</h1>
        <div class="location-info" id="location-info">
            <div class="location-name" id="location-name">Loading location...</div>
            <div class="location-details" id="location-details"></div>
        </div>
        <div class="status">
            <span id="status-text">Disconnected</span>
            <div class="status-indicator" id="status-indicator"></div>
            <button class="start-button" id="start-button" onclick="startGame()">Start Game</button>
            <div class="save-load-buttons">
                <button class="save-button" id="save-button" onclick="openSaveDialog()" disabled title="Save Game">Save</button>
                <button class="load-button" id="load-button" onclick="openLoadDialog()" disabled title="Load Game">Load</button>
                <button class="reset-button" id="reset-button" onclick="openResetDialog()" disabled title="Reset Campaign">Reset</button>
            </div>
            <div class="toggle-stack">
                <div class="image-generation-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="image-generation-toggle" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">AI Images</span>
                    </label>
                </div>
                <div class="image-generation-toggle">
                    <label class="toggle-label" id="model-toggle-label">
                        <input type="checkbox" id="model-toggle" unchecked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-text" id="model-toggle-text">GPT-4.1</span>
                    </label>
                </div>
            </div>
            
            <!-- The relocated and modified Toolkit Button with anvil icon -->
            <button class="toolkit-button" onclick="openToolkit()" title="Open Module Toolkit">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22,2V8H20V4H17V2H22M2,8V2H7V4H4V8H2M20,13.09A2.5,2.5 0 0,0 22.5,15.59C22.5,16.9 21.4,18 20,18H4C2.6,18 1.5,16.9 1.5,15.59C1.5,14.09 2.59,12.83 4,12.5V10H20V13.09M20,16H4A1,1 0 0,1 3,15A1,1 0 0,1 4,14H20A1,1 0 0,1 21,15A1,1 0 0,1 20,16Z" />
                </svg>
                <span>Toolkit</span>
            </button>
            
            <button class="exit-button" id="exit-button" onclick="exitGame()" title="Exit Game">× Exit</button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="panel game-panel">
            <div class="panel-header">
                <span id="panel-header-label">Game Output</span>
                <div id="combat-round-box" class="combat-round-box" style="display: none;">
                    <div class="combat-round-title">COMBAT</div>
                    <div class="combat-round-separator"></div>
                    <div class="combat-round-label">ROUND</div>
                    <div id="combat-round-number" class="combat-round-number">1</div>
                </div>
                
                <!-- Adventure/Exploration Box (shown when not in combat) -->
                <div id="adventure-box" class="adventure-box" style="display: flex;">
                    <img id="time-background" class="time-image" src="/static/media/environment/midday.jpg" alt="">
                </div>
                
                <!-- START: New Scroller Structure -->
                <div class="scroller-wrapper">
                    <button class="scroll-arrow left-arrow" id="scroll-left-btn" style="display: none;">&lt;</button>
                    <div class="scroller-content">
                        <!-- Party Display Container (now inside the wrapper) -->
                        <div id="party-display-container" class="party-display-container"></div>
                        <!-- Initiative Tracker Container (now inside the wrapper) -->
                        <div id="initiative-tracker-container" class="initiative-tracker-container" style="display: none;"></div>
                    </div>
                    <button class="scroll-arrow right-arrow" id="scroll-right-btn" style="display: none;">&gt;</button>
                </div>
                <!-- END: New Scroller Structure -->
                
                <!-- Dice Rolling Strip -->
                <div class="dice-strip-inline">
                    <div class="dice-container">
                        <div class="dice-label">
                            <span class="dice-label-text">Quick Rolls</span>
                        </div>
                        <div class="dice-buttons">
                            <button class="dice-button" onclick="rollDice(20)" title="Roll D20">D20</button>
                            <button class="dice-button" onclick="rollDice(12)" title="Roll D12">D12</button>
                            <button class="dice-button" onclick="rollDice(10)" title="Roll D10">D10</button>
                            <button class="dice-button" onclick="rollDice(8)" title="Roll D8">D8</button>
                            <button class="dice-button" onclick="rollDice(6)" title="Roll D6">D6</button>
                            <button class="dice-button" onclick="rollDice(4)" title="Roll D4">D4</button>
                            <button class="dice-clear-button" onclick="clearDiceResults()" title="Clear results">Clear</button>
                        </div>
                    </div>
                    <!-- Module Toolkit Button moved to main header -->
                </div>
            </div>
            
            <!-- Header Divider Line with Fading Edges -->
            <div class="header-divider-line"></div>
            
            <!-- Dice Results Area -->
            <div class="dice-results" id="dice-results" style="display: none;"></div>
            
            <div class="panel-content" id="game-output"></div>
            <div class="input-container">
                <input 
                    type="text" 
                    class="input-field" 
                    id="user-input" 
                    placeholder="Enter your command..."
                    disabled
                    onkeypress="handleKeyPress(event)"
                />
                <button class="send-button" id="send-button" onclick="sendInput()" disabled>Send</button>
            </div>
        </div>
        
        <div class="panel debug-panel">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('stats')">Character</button>
                <button class="tab-button" onclick="switchTab('inventory')">Inventory</button>
                <button class="tab-button" onclick="switchTab('spells')">Spells & Magic</button>
                <button class="tab-button" onclick="switchTab('npcs')">NPCs</button>
                <button id="journal-btn" class="tab-button">Journal</button>
                <button class="tab-button" onclick="switchTab('debug')">Debug</button>
            </div>
            <div class="tab-content-wrapper">
            <div class="tab-content" id="debug-tab" style="display: none;">
                <div class="token-usage-header" id="token-usage">
                    <div class="token-stats">
                        <span class="token-label">TPM:</span> <span id="tpm-value">0</span>
                        <span class="token-separator">|</span>
                        <span class="token-label">RPM:</span> <span id="rpm-value">0</span>
                        <span class="token-separator">|</span>
                        <span class="token-label">Total:</span> <span id="total-tokens">0</span>
                    </div>
                </div>
                <div class="panel-content debug-scrollable" id="debug-output"></div>
            </div>
            <div class="tab-content" id="inventory-tab" style="display: none;">
                <div class="loading">Loading inventory...</div>
            </div>
            <div class="tab-content" id="stats-tab" style="display: flex;">
                <div class="panel-content" id="stats-content">
                    <div class="loading">Loading character stats...</div>
                </div>
            </div>
            <div class="tab-content" id="spells-tab" style="display: none;">
                <div class="panel-content" id="spells-content">
                    <div class="loading">Loading spells and magic items...</div>
                </div>
            </div>
            <div class="tab-content" id="npcs-tab" style="display: none;">
                <div class="panel-content" id="npcs-content">
                    <div class="loading">Loading NPC information...</div>
                </div>
            </div>
            </div> <!-- End tab-content-wrapper -->
        </div>
    </div>
    
    <!-- Add this entire block just before your <script> tag -->
    <div id="journal-modal" class="modal">
        <div class="journal-book">
            <!-- Left Page -->
            <div class="journal-page" id="journal-left-page">
                <div class="page-content">
                    <!-- Active quests will be populated here by JavaScript -->
                </div>
            </div>
            <!-- Right Page -->
            <div class="journal-page" id="journal-right-page">
                <div class="page-content">
                    <!-- Completed quests will be populated here by JavaScript -->
                </div>
            </div>
        </div>
        <span class="close-btn">×</span>
    </div>
    
    <script>
        const socket = io();
        let connected = false;
        let gameStarted = false;
        let initiativeOrder = []; // Store the ordered list of combatants
        let playerName = '';      // Store the player's name for highlighting
        let hoverTimer = null;    // For managing hover delay on video preview
        let isHoveringInitiative = false; // Track if we're hovering over an initiative item
        
        // Capitalize first letter of each word function
        function capitalizeWords(str) {
            if (!str) return str;
            return str.replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Helper function to highlight the current turn in initiative tracker
        function highlightCurrentTurn() {
            const items = document.querySelectorAll('.initiative-item');
            items.forEach(item => item.classList.remove('active'));

            // The input field being enabled is our signal that it's the player's turn.
            const isPlayerTurn = !document.getElementById('user-input').disabled;

            if (isPlayerTurn && playerName && initiativeOrder.length > 0) {
                const playerItem = document.querySelector(`.initiative-item[data-name="${playerName}"]`);
                if (playerItem) {
                    playerItem.classList.add('active');
                }
            }
        }
        
        // Create a persistent file input that survives DOM refreshes
        let persistentPortraitInput = null;
        
        function getOrCreatePortraitInput() {
            if (!persistentPortraitInput || !document.body.contains(persistentPortraitInput)) {
                persistentPortraitInput = document.createElement('input');
                persistentPortraitInput.type = 'file';
                persistentPortraitInput.accept = 'image/*';
                persistentPortraitInput.style.display = 'none';
                persistentPortraitInput.id = 'persistent-portrait-input';
                document.body.appendChild(persistentPortraitInput);
            }
            return persistentPortraitInput;
        }
        
        // Handle portrait upload - make global for inline event handlers
        window.uploadPortrait = function(characterName) {
            console.log('uploadPortrait triggered for:', characterName);
            
            // Use the persistent input instead
            const input = getOrCreatePortraitInput();
            
            // Set up the change handler
            input.onchange = function() {
                const file = input.files[0];
                if (!file) {
                    console.log("No file selected.");
                    return;
                }
                processPortraitUpload(file, characterName);
            };
            
            // Trigger the file dialog
            input.click();
        }
        
        function processPortraitUpload(file, characterName) {

            console.log(`Processing upload for ${characterName}: ${file.name}`);
            
            const formData = new FormData();
            formData.append('portrait', file);
            formData.append('characterName', characterName);

            addMessage('game-output', { type: 'system', content: 'Uploading and processing portrait...' });

            fetch('/upload-portrait', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage('game-output', { type: 'system', content: 'Portrait updated successfully!' });
                    
                    // Force the image to update by adding a unique timestamp to its URL.
                    const portraitImg = document.getElementById('char-portrait-img');
                    if (portraitImg) {
                        const baseUrl = `/static/portraits/${characterName}.png`;
                        // Add timestamp only for the upload, not regular refreshes
                        portraitImg.src = `${baseUrl}?v=${Date.now()}`;
                    }
                    
                    // Reset the persistent input
                    if (persistentPortraitInput) {
                        persistentPortraitInput.value = '';
                    }
                } else {
                    addMessage('game-output', { type: 'error', content: `Upload failed: ${data.message}` });
                }
            })
            .catch(error => {
                console.error('Error uploading portrait:', error);
                addMessage('game-output', { type: 'error', content: 'An error occurred during upload.' });
            });
        }
        
        // Also keep as regular function for backwards compatibility
        const uploadPortrait = window.uploadPortrait;
        
        // Function to request initiative data
        function requestInitiativeData() {
            socket.emit('request_initiative_data');
        }
        
        // Function to request party data
        function requestPartyData() {
            socket.emit('request_party_data');
        }
        
        // Video popup functions - hover-activated with requestAnimationFrame
        function showVideoPopup(targetElement, videoSrc) {
            const popup = document.getElementById('media-popup');
            const popupContent = popup.querySelector('.video-popup-content');
            const video = document.getElementById('popup-video');
            const image = document.getElementById('popup-image');
            
            // Hide image, show video
            image.style.display = 'none';
            video.style.display = 'block';
            video.src = videoSrc;
            popup.classList.add('visible');

            // Use requestAnimationFrame to ensure the element is measurable before positioning.
            // This is a robust way to wait for the browser to be ready.
            requestAnimationFrame(() => {
                const targetRect = targetElement.getBoundingClientRect();
                const popupRect = popupContent.getBoundingClientRect();

                let top, left;

                // Try to position the popup ABOVE the icon
                top = targetRect.top - popupRect.height - 10; // 10px margin

                // If it goes off the top of the screen, position it BELOW instead
                if (top < 10) {
                    top = targetRect.bottom + 10;
                }

                // Center it horizontally with the icon
                left = targetRect.left + (targetRect.width / 2) - (popupRect.width / 2);

                // If it goes off the left or right edges, push it back into view
                if (left < 10) {
                    left = 10;
                } else if (left + popupRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - popupRect.width - 10;
                }

                // Apply the final, calculated positions
                popupContent.style.top = `${top}px`;
                popupContent.style.left = `${left}px`;
                
                video.play().catch(e => console.error("Video autoplay was prevented:", e));
            });
        }

        function hideVideoPopup() {
            clearTimeout(hoverTimer);
            const popup = document.getElementById('media-popup');
            const video = document.getElementById('popup-video');
            const image = document.getElementById('popup-image');
            
            popup.classList.remove('visible');
            
            // Stop the video after a short delay to prevent it from playing while invisible
            setTimeout(() => {
                video.pause();
                video.src = '';
                video.style.display = 'none';
                image.src = '';
                image.style.display = 'none';
            }, 200); // This duration matches the CSS transition
        }
        
        // New unified function to show images in the popup
        function showImagePopup(targetElement, imageSrc) {
            const popup = document.getElementById('media-popup');
            const popupContent = popup.querySelector('.video-popup-content');
            const video = document.getElementById('popup-video');
            const image = document.getElementById('popup-image');
            
            // Hide video, show image
            video.style.display = 'none';
            image.style.display = 'block';
            image.src = imageSrc;
            popup.classList.add('visible');
            
            // Position the popup (same as video)
            requestAnimationFrame(() => {
                const targetRect = targetElement.getBoundingClientRect();
                const popupRect = popupContent.getBoundingClientRect();
                let top = targetRect.top - popupRect.height - 10;
                if (top < 10) {
                    top = targetRect.bottom + 10;
                }
                let left = targetRect.left + (targetRect.width / 2) - (popupRect.width / 2);
                if (left < 10) {
                    left = 10;
                } else if (left + popupRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - popupRect.width - 10;
                }
                popupContent.style.top = `${top}px`;
                popupContent.style.left = `${left}px`;
            });
        }
        
        // --- START: Stats Tooltip Functions ---
        let currentStatsTooltip = null;
        let tooltipHideTimer = null; // Timer to manage tooltip hide delay
        let tooltipShowTimer = null; // Timer for debouncing tooltip show
        let lastHoveredElement = null; // Track last hovered element to avoid recalculation
        const elementListenerMap = new WeakMap(); // Track which elements have listeners
        let currentlyHoveredName = null; // Track the name of currently hovered character to preserve hover state

        function createStatsTooltip(stats) {
            const tooltip = document.createElement('div');
            tooltip.className = 'stats-tooltip';
            
            // Compact header with level and class
            let headerText = '';
            if (stats.level && stats.class) {
                headerText = `Lvl ${stats.level} ${stats.class}`;
            } else {
                headerText = stats.name.replace(/_/g, ' ');
            }
            let html = `<div class="stats-tooltip-header">${headerText}</div>`;
            
            // First line: HP | AC | Speed
            html += '<div class="stats-tooltip-row" style="font-size: 12px;">';
            if (stats.currentHp !== undefined && stats.maxHp !== undefined) {
                html += `<span>${stats.currentHp}/${stats.maxHp} HP</span>`;
            }
            if (stats.ac !== undefined) {
                html += `<span style="margin-left: 8px;">AC ${stats.ac}</span>`;
            }
            if (stats.speed !== undefined) {
                html += `<span style="margin-left: 8px;">${stats.speed}ft</span>`;
            }
            html += '</div>';
            
            // Second line: Attack | Init
            if (stats.primaryAttack || stats.initiative !== undefined) {
                html += '<div class="stats-tooltip-row" style="font-size: 12px;">';
                if (stats.primaryAttack) {
                    const bonus = stats.primaryAttack.bonus >= 0 ? '+' + stats.primaryAttack.bonus : stats.primaryAttack.bonus;
                    html += `<span>Atk: ${bonus} (${stats.primaryAttack.damage})</span>`;
                }
                if (stats.initiative !== undefined) {
                    const init = stats.initiative >= 0 ? '+' + stats.initiative : stats.initiative;
                    html += `<span style="margin-left: 8px;">Init: ${init}</span>`;
                }
                html += '</div>';
            }
            
            // Spell slots if any (only show non-zero)
            if (stats.spellSlots && Object.keys(stats.spellSlots).length > 0) {
                const slotInfo = [];
                for (let level in stats.spellSlots) {
                    if (stats.spellSlots[level]) {
                        const current = stats.spellSlots[level].current || 0;
                        const max = stats.spellSlots[level].max !== undefined ? stats.spellSlots[level].max : stats.spellSlots[level];
                        // Only show slots that have a max greater than 0
                        if (max > 0) {
                            // Clean up level display
                            let levelDisplay = level.replace('level', 'L');
                            slotInfo.push(`${levelDisplay}: ${current}/${max}`);
                        }
                    }
                }
                // Only show the row if there are actual spell slots
                if (slotInfo.length > 0) {
                    html += '<div class="stats-tooltip-row" style="font-size: 11px; margin-top: 4px; border-top: 1px solid #444; padding-top: 3px;">';
                    html += '<span style="color: #87CEEB;">Spell Slots: </span>';
                    html += '<span style="color: #ddd;">' + slotInfo.join(' • ') + '</span>';
                    html += '</div>';
                }
            }
            
            // Spells organized by level
            if (stats.spells && Object.keys(stats.spells).length > 0) {
                html += '<div class="stats-tooltip-spells" style="margin-top: 4px; padding-top: 3px; border-top: 1px solid #444;">';
                html += '<div style="font-size: 11px; color: #87CEEB; margin-bottom: 2px;">Spells Known:</div>';
                // Sort levels numerically
                const sortedLevels = Object.keys(stats.spells).sort((a, b) => parseInt(a) - parseInt(b));
                for (let level of sortedLevels) {
                    let levelName;
                    if (level == 0) levelName = 'Cantrips';
                    else if (level == 1) levelName = '1st Level';
                    else if (level == 2) levelName = '2nd Level';
                    else if (level == 3) levelName = '3rd Level';
                    else levelName = `${level}th Level`;
                    
                    // Format spell list nicely
                    const spellList = stats.spells[level];
                    if (spellList && spellList.length > 0) {
                        html += `<div style="margin-top: 3px;">`;
                        html += `<span style="font-size: 10px; color: #FFA500; font-weight: bold;">${levelName}:</span> `;
                        html += `<span style="font-size: 10px; color: #f0f0f0;">${spellList.join(', ')}</span>`;
                        html += `</div>`;
                    }
                }
                html += '</div>';
            }
            
            // Class Features & Abilities
            if (stats.classFeatures && stats.classFeatures.length > 0) {
                html += '<div class="stats-tooltip-features" style="margin-top: 4px; padding-top: 3px; border-top: 1px solid #444;">';
                html += '<div style="font-size: 11px; color: #FFD700; margin-bottom: 2px;">Class Features:</div>';
                for (let feature of stats.classFeatures) {
                    html += '<div style="font-size: 10px; color: #f0f0f0; margin-top: 2px;">';
                    html += `• ${feature.name}`;
                    if (feature.usage) {
                        html += ` <span style="color: #87CEEB;">(${feature.usage})</span>`;
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Conditions/Status
            if (stats.conditions && stats.conditions.length > 0) {
                html += '<div class="stats-tooltip-row" style="font-size: 11px; margin-top: 4px; padding-top: 3px; border-top: 1px solid #444;">';
                html += '<span style="color: #ff6666; font-weight: bold;">Conditions: </span>';
                html += `<span style="color: #ffaaaa;">${stats.conditions.join(', ')}</span>`;
                html += '</div>';
            }

            tooltip.innerHTML = html;
            return tooltip;
        }

        function updateStatsTooltipContent(tooltip, stats) {
            // Use the same logic as createStatsTooltip to keep consistent
            const newTooltip = createStatsTooltip(stats);
            tooltip.innerHTML = newTooltip.innerHTML;
        }

        function showStatsTooltip(event) {
            clearTimeout(tooltipShowTimer);
            clearTimeout(tooltipHideTimer);
            
            const target = event.currentTarget;
            const stats = JSON.parse(target.dataset.stats || '{}');
            
            // Store the currently hovered character name
            currentlyHoveredName = stats.name || null;
            
            // Debounce - wait 50ms before showing to prevent flicker
            tooltipShowTimer = setTimeout(() => {
                if (!stats.name) return;
                
                // Reuse existing tooltip or create new one
                if (!currentStatsTooltip) {
                    currentStatsTooltip = createStatsTooltip(stats);
                    document.body.appendChild(currentStatsTooltip);
                    positionTooltip(target, currentStatsTooltip);
                } else {
                    // Just update content if hovering over different element
                    if (lastHoveredElement !== target) {
                        updateStatsTooltipContent(currentStatsTooltip, stats);
                        positionTooltip(target, currentStatsTooltip);
                    }
                }
                
                lastHoveredElement = target;
                currentStatsTooltip.classList.add('visible');
            }, 50);
        }

        function hideStatsTooltip(event) {
            const immediate = typeof event === 'boolean' ? event : false;
            
            clearTimeout(tooltipShowTimer); // Cancel any pending show action
            clearTimeout(tooltipHideTimer); // Always clear any previous timer
            
            // Remove preserve-hover from all elements when hiding tooltip
            document.querySelectorAll('.preserve-hover').forEach(el => {
                el.classList.remove('preserve-hover');
            });
            
            // Reset the last hovered element and name when hiding
            lastHoveredElement = null;
            currentlyHoveredName = null;

            if (immediate) {
                if (currentStatsTooltip) {
                    currentStatsTooltip.classList.remove('visible');
                    // Keep the tooltip element but hide it instead of removing
                    // This allows for reuse and prevents recreation
                }
            } else {
                // Set a timer to hide the tooltip after a short delay
                tooltipHideTimer = setTimeout(() => {
                    if (currentStatsTooltip) {
                        currentStatsTooltip.classList.remove('visible');
                        // Don't remove the element, just hide it for reuse
                    }
                    currentlyHoveredName = null;
                }, 100);
            }
        }
        
        // Smart event listener attachment to prevent duplicates
        function attachTooltipListeners(element) {
            if (!elementListenerMap.has(element)) {
                element.addEventListener('mouseenter', (e) => {
                    // Remove preserve-hover class when actually hovering
                    e.currentTarget.classList.remove('preserve-hover');
                    showStatsTooltip(e);
                });
                element.addEventListener('mouseleave', (e) => {
                    // Ensure preserve-hover is removed on mouse leave
                    e.currentTarget.classList.remove('preserve-hover');
                    hideStatsTooltip(e);
                });
                elementListenerMap.set(element, true);
            }
        }
        // --- END: Stats Tooltip Functions ---
        
        // Auto-scroll to bottom function
        function scrollToBottom(contentElementId) {
            const contentElement = document.getElementById(contentElementId);
            if (!contentElement) return;

            // The element with the ID is now always the correct scrollable container.
            // The special case for 'debug-output' is no longer needed.
            const scrollableElement = contentElement;

            if (scrollableElement) {
                // A slight delay ensures the DOM has updated with the new message before we scroll.
                setTimeout(() => {
                    scrollableElement.scrollTop = scrollableElement.scrollHeight;
                }, 50);
            }
        }
        
        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }
        
        // Add message to output with Tavern AI style
        function addMessage(outputId, message) {
            const output = document.getElementById(outputId);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            
            // Handle different message types
            if (message.type === 'narration') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                const avatarImg = document.createElement('img');
                avatarImg.src = '/static/dm_logo.png';
                avatarImg.alt = 'DM';
                avatar.appendChild(avatarImg);
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                const header = document.createElement('div');
                header.className = 'message-header';
                const author = document.createElement('span');
                author.className = 'message-author';
                author.textContent = 'Dungeon Master';
                const badge = document.createElement('span');
                badge.className = 'message-badge';
                badge.textContent = 'DM';
                
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                header.appendChild(author);
                header.appendChild(badge);
                
                // Add image generation button (only if enabled)
                const isImageGenEnabled = document.getElementById('image-generation-toggle').checked;
                if (isImageGenEnabled) {
                    const imageButton = document.createElement('button');
                    imageButton.className = 'image-generation-button';
                    imageButton.textContent = 'Generate Image';
                    imageButton.onclick = function() {
                        generateImageForMessage(message.content, messageDiv);
                    };
                    header.appendChild(imageButton);
                }
                contentDiv.appendChild(header);
                contentDiv.appendChild(text);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
                
            } else if (message.type === 'user-input') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = '⚔️';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                const header = document.createElement('div');
                header.className = 'message-header';
                const author = document.createElement('span');
                author.className = 'message-author';
                author.textContent = 'You';
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                header.appendChild(author);
                contentDiv.appendChild(header);
                contentDiv.appendChild(text);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
                
            } else if (message.type === 'system' || message.type === 'error') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                contentDiv.appendChild(text);
                messageDiv.appendChild(contentDiv);
                
            } else if (message.type === 'debug') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                if (message.timestamp && outputId === 'debug-output') {
                    const timestamp = document.createElement('span');
                    timestamp.className = 'timestamp';
                    timestamp.textContent = formatTimestamp(message.timestamp);
                    contentDiv.appendChild(timestamp);
                }
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                contentDiv.appendChild(text);
                messageDiv.appendChild(contentDiv);
            }
            
            output.appendChild(messageDiv);
            scrollToBottom(outputId);
        }
        
        // Image generation function
        function generateImageForMessage(messageContent, messageDiv) {
            // Find the button in this message and disable it
            const button = messageDiv.querySelector('.image-generation-button');
            if (button) {
                button.disabled = true;
                button.classList.add('loading-image');
                button.textContent = 'Generating...';
                
                // Store the message div reference in the button for later retrieval
                button.dataset.messageDiv = 'true';
            }
            
            // Create a high-quality prompt based on the message content
            const prompt = `Epic fantasy RPG scene: ${messageContent}. Medieval style, darker lighting, highly detailed fantasy art style, professional digital painting, atmospheric depth.`;
            
            // Send the image generation request
            socket.emit('generate_image', { prompt: prompt });
        }
        

        // --- START: Custom Scroller Logic ---
        function setupScrollers() {
            const leftBtn = document.getElementById('scroll-left-btn');
            const rightBtn = document.getElementById('scroll-right-btn');
            const partyScroller = document.getElementById('party-display-container');
            const combatScroller = document.getElementById('initiative-tracker-container');

            // Determine which scroller is currently visible
            const activeScroller = combatScroller.style.display !== 'none' ? combatScroller : partyScroller;

            const updateArrowVisibility = () => {
                if (!activeScroller) return;
                const hasOverflow = activeScroller.scrollWidth > activeScroller.clientWidth;
                
                if (!hasOverflow) {
                    leftBtn.style.display = 'none';
                    rightBtn.style.display = 'none';
                    return;
                }

                // Show/hide left arrow
                leftBtn.style.display = activeScroller.scrollLeft > 0 ? 'block' : 'none';

                // Show/hide right arrow
                const maxScrollLeft = activeScroller.scrollWidth - activeScroller.clientWidth;
                rightBtn.style.display = activeScroller.scrollLeft < (maxScrollLeft - 1) ? 'block' : 'none';
            };

            // Attach event listeners
            leftBtn.onclick = () => {
                activeScroller.scrollBy({ left: -200, behavior: 'smooth' });
            };
            rightBtn.onclick = () => {
                activeScroller.scrollBy({ left: 200, behavior: 'smooth' });
            };

            // Update arrows when scrolling (e.g., with a trackpad)
            partyScroller.onscroll = updateArrowVisibility;
            combatScroller.onscroll = updateArrowVisibility;

            // Set initial state
            // Use a small timeout to ensure the DOM has rendered the new items
            setTimeout(updateArrowVisibility, 100);
        }
        // --- END: Custom Scroller Logic ---
        
        // Socket event handlers
        socket.on('connect', () => {
            connected = true;
            document.getElementById('status-text').textContent = 'Connected';
            document.getElementById('status-indicator').classList.add('connected');
            loadCharacterStats();
            requestPlotData(); // <--- ADD THIS
            requestPartyData(); // Load party display on connect
        });
        
        socket.on('disconnect', () => {
            connected = false;
            gameStarted = false;
            document.getElementById('status-text').textContent = 'Disconnected';
            document.getElementById('status-indicator').classList.remove('connected');
            document.getElementById('user-input').disabled = true;
            document.getElementById('send-button').disabled = true;
        });
        
        socket.on('game_started', (data) => {
            gameStarted = true;
            document.getElementById('start-button').textContent = 'Game Running';
            document.getElementById('start-button').disabled = true;
            document.getElementById('user-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            document.getElementById('save-button').disabled = false;
            document.getElementById('load-button').disabled = false;
            document.getElementById('reset-button').disabled = false;
            document.getElementById('user-input').focus();
            addMessage('game-output', { type: 'system', content: 'Game started! You can now enter commands.' });
            loadCharacterStats();
            loadLocationData();
            requestInitiativeData(); // Check for combat on game start
        });
        
        socket.on('game_output', (message) => { 
            addMessage('game-output', message); 
            // Check for combat immediately after any game output
            requestInitiativeData();
            // After any game output, refresh plot data with a slight delay
            setTimeout(() => {
                requestPlotData();
            }, 1500);
        });
        socket.on('debug_output', (message) => { addMessage('debug-output', message); });
        socket.on('error', (error) => { addMessage('game-output', { type: 'error', content: error.message }); });
        
        // Token usage updates
        socket.on('token_update', (data) => {
            if (data.tpm !== undefined) document.getElementById('tpm-value').textContent = data.tpm.toLocaleString();
            if (data.rpm !== undefined) document.getElementById('rpm-value').textContent = data.rpm;
            if (data.total_tokens !== undefined) document.getElementById('total-tokens').textContent = data.total_tokens.toLocaleString();
        });
        
        // Compression progress updates
        socket.on('compression_start', (data) => {
            const container = document.getElementById('compression-progress');
            const textElement = document.getElementById('compression-text');
            const statusElement = document.getElementById('compression-status');
            const barElement = document.getElementById('compression-bar');
            
            container.classList.add('active');
            
            // DM-themed messages
            const messages = [
                "The Dungeon Master carefully inscribes your deeds into the eternal chronicle...",
                "Ancient magics compress your adventures into mystical runes...",
                "The scribes work tirelessly to record your legendary journey...",
                "Your tales are being woven into the tapestry of heroes...",
                "The chronicler's quill dances across enchanted parchment..."
            ];
            textElement.textContent = messages[Math.floor(Math.random() * messages.length)];
            
            statusElement.textContent = `Compressing ${data.total_sections} chronicle sections...`;
            barElement.style.width = '0%';
            barElement.classList.remove('complete');
        });
        
        socket.on('compression_progress', (data) => {
            const statusElement = document.getElementById('compression-status');
            const barElement = document.getElementById('compression-bar');
            
            const percentage = Math.round((data.completed / data.total) * 100);
            barElement.style.width = percentage + '%';
            
            if (data.from_cache) {
                statusElement.textContent = `Section ${data.completed} of ${data.total} (retrieved from memory)`;
            } else {
                statusElement.textContent = `Compressing section ${data.completed} of ${data.total}...`;
            }
        });
        
        socket.on('compression_complete', (data) => {
            const container = document.getElementById('compression-progress');
            const statusElement = document.getElementById('compression-status');
            const barElement = document.getElementById('compression-bar');
            
            barElement.style.width = '100%';
            barElement.classList.add('complete');
            statusElement.textContent = `Chronicle compression complete! Reduced by ${data.reduction_percentage}%`;
            
            setTimeout(() => {
                container.classList.remove('active');
            }, 2000);
        });
        
        // Image generation event handlers
        socket.on('image_generated', (data) => {
            // Find the button that was marked as loading and re-enable it
            const loadingButton = document.querySelector('.image-generation-button.loading-image');
            if (loadingButton) {
                loadingButton.disabled = false;
                loadingButton.classList.remove('loading-image');
                loadingButton.textContent = 'Generate Image';
                
                // Find the message that contains this button
                const messageDiv = loadingButton.closest('.message.narration');
                if (messageDiv) {
                    const contentDiv = messageDiv.querySelector('.message-content');
                    
                    // Check if image already exists
                    let imageContainer = messageDiv.querySelector('.image-container');
                    if (!imageContainer) {
                        imageContainer = document.createElement('div');
                        imageContainer.className = 'image-container';
                        contentDiv.appendChild(imageContainer);
                    }
                    
                    // Create and add the image
                    const img = document.createElement('img');
                    img.className = 'generated-image';
                    img.src = data.image_url;
                    img.alt = 'Generated fantasy scene';
                    
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(img);
                    
                    // Scroll to show the new image
                    scrollToBottom('game-output');
                }
            }
        });
        
        socket.on('image_generation_error', (data) => {
            // Re-enable the button that was marked as loading
            const loadingButton = document.querySelector('.image-generation-button.loading');
            if (loadingButton) {
                loadingButton.disabled = false;
                loadingButton.classList.remove('loading');
                loadingButton.textContent = 'Generate Image';
            }
            
            // Show error message
            addMessage('game-output', { type: 'error', content: data.message });
        });
        
        socket.on('status_update', (data) => {
            const input = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            if (data.is_processing) {
                input.placeholder = data.message;
                input.disabled = true;
                sendButton.disabled = true;
            } else {
                input.placeholder = "Enter your command...";
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
            }
            // This single call now handles all highlighting logic.
            highlightCurrentTurn();
        });
        
        // User interaction functions
        function startGame() {
            if (connected && !gameStarted) {
                socket.emit('start_game');
            }
        }
        
        function sendInput() {
            const input = document.getElementById('user-input');
            const value = input.value.trim();
            if (value && connected && gameStarted) {
                socket.emit('user_input', { input: value });
                input.value = '';
                input.focus();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendInput();
            }
        }
        
        // Tab switching function
        function switchTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => { tab.style.display = 'none'; });
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => { button.classList.remove('active'); });
            
            document.getElementById(`${tabName}-tab`).style.display = 'flex';
            event.target.classList.add('active');
            
            if (tabName === 'inventory') loadInventory();
            else if (tabName === 'stats') loadCharacterStats();
            else if (tabName === 'spells') loadSpellsAndMagic();
            else if (tabName === 'npcs') loadNPCs();
        }
        
        function loadInventory() { socket.emit('request_player_data', { dataType: 'inventory' }); }
        function loadCharacterStats() { socket.emit('request_player_data', { dataType: 'stats' }); }
        function loadSpellsAndMagic() { socket.emit('request_player_data', { dataType: 'inventory' }); }
        function loadNPCs() { socket.emit('request_player_data', { dataType: 'npcs' }); }
        function loadLocationData() { socket.emit('request_location_data'); }
        
        // Display inventory data
        let originalInventoryData = null;
        function displayInventory(data, preserveOriginal = false) {
            // Save scroll position before updating (special selector for inventory)
            const equipmentSection = document.querySelector('#inventory-tab .equipment-section'); // CHANGED
            const scrollPosition = equipmentSection ? equipmentSection.scrollTop : 0;
            
            const container = document.getElementById('inventory-tab'); // CHANGED
            if (!data) {
                container.innerHTML = '<div class="loading">No inventory data available</div>';
                return;
            }
            const hasCustomSort = currentSort !== 'name-asc';
            if (!preserveOriginal && originalInventoryData && (filtersActive || hasCustomSort)) {
                originalInventoryData = data;
                applyFiltersAndSort();
                return;
            }
            if (!preserveOriginal) {
                originalInventoryData = data;
            }

            // --- START OF REFACTORED HTML STRUCTURE ---

            // No longer wrapped in an outer 'inventory-sheet' div.
            // The parent 'inventory-content' is now our main container.
            let html = '';

            // 1. Add the new, wide storage button at the very top.
            html += `<button class="storage-view-button" onclick="openStorageView()">View Player Storage</button>`;

            // 2. Add the inventory controls. This part is unchanged.
            html += `<div class="inventory-controls">
                        <button class="search-btn" onclick="openSearchPopup()">Search</button>
                        <select class="inventory-sort" id="inventory-sort" onchange="sortInventory()">
                            <option value="name-asc">Sort: Name A-Z</option>
                            <option value="name-desc">Sort: Name Z-A</option>
                            <option value="type">Sort: Type</option>
                            <option value="quantity">Sort: Quantity</option>
                        </select>
                        <select class="filter-dropdown" id="filter-dropdown" onchange="changeFilter()">
                            <option value="">Filter</option>
                            <option value="weapon">Weapons</option>
                            <option value="armor">Armor</option>
                            <option value="consumable">Consumables</option>
                            <option value="magical">Magical</option>
                            <option value="equipped">Equipped</option>
                        </select>
                        <button class="search-btn" onclick="clearAllFilters()">Clear</button>
                    </div>`;

            // 3. Add the equipment section, which will be our scrollable list.
            html += '<div class="equipment-section"><h4>Equipment</h4>';
            if (data.equipment && data.equipment.length > 0) {
                data.equipment.forEach(item => {
                    const description = (item.description || 'No description available.').replace(/"/g, '&quot;');
                    html += `<div class="inventory-item" data-tooltip-title="${item.item_name}" data-tooltip-content="${description}">
                                <span class="feature-bullet">●</span>
                                <span class="item-name">${item.item_name}${(item.quantity||1) > 1 ? ` ×${item.quantity}` : ''}</span>
                                <span class="item-type"> (${(item.item_type || 'misc').toLowerCase()})</span>
                             </div>`;
                });
            } else {
                html += '<div class="inventory-item"><span class="feature-bullet">●</span><span class="item-name">No equipment</span></div>';
            }
            html += '</div>'; // Close equipment-section

            // --- END OF REFACTORED HTML STRUCTURE ---

            container.innerHTML = html;

            // Restore scroll position after updating (special selector for inventory)
            const newEquipmentSection = document.querySelector('#inventory-tab .equipment-section'); // CHANGED
            if (newEquipmentSection) {
                newEquipmentSection.scrollTop = scrollPosition;
            }

            // The rest of the function remains the same.
            const sortDropdown = document.getElementById('inventory-sort');
            const filterDropdown = document.getElementById('filter-dropdown');
            if (sortDropdown && currentSort) sortDropdown.value = currentSort;
            if (filterDropdown && currentFilter) filterDropdown.value = currentFilter;
            initializeAllTooltips();
        }
        
        // Skill Tooltip System (Backward-Compatible)
        let skillTooltip = null;

        const SKILL_MAP = {
            'Strength': ['Athletics'],
            'Dexterity': ['Acrobatics', 'Sleight of Hand', 'Stealth'],
            'Intelligence': ['Arcana', 'History', 'Investigation', 'Nature', 'Religion'],
            'Wisdom': ['Animal Handling', 'Insight', 'Medicine', 'Perception', 'Survival'],
            'Charisma': ['Deception', 'Intimidation', 'Performance', 'Persuasion']
        };

        function createSkillTooltip(abilityName, characterData, proficientSkills) {
            const tooltip = document.createElement('div');
            tooltip.className = 'skill-tooltip';
            
            let content = `<div class="skill-tooltip-header">${abilityName} Skills</div>`;
            const associatedSkills = SKILL_MAP[abilityName];
            const proficientSkillsLower = proficientSkills.map(s => s.toLowerCase());

            associatedSkills.forEach(skill => {
                const isProficient = proficientSkillsLower.includes(skill.toLowerCase());
                const abilityMod = characterData.abilities[abilityName.toLowerCase()] ? 
                    Math.floor((characterData.abilities[abilityName.toLowerCase()] - 10) / 2) : 0;
                const bonus = isProficient ? 
                    abilityMod + (characterData.proficiencyBonus || 2) : abilityMod;

                content += `<div class="skill-tooltip-item">
                    <span class="skill-tooltip-name">${isProficient ? '●' : '○'} ${skill}</span>
                    <span class="skill-tooltip-value">${bonus >= 0 ? '+' : ''}${bonus}</span>
                </div>`;
            });

            tooltip.innerHTML = content;
            return tooltip;
        }

        function showSkillTooltip(event, characterData, proficientSkills) {
            hideSkillTooltip();
            
            const target = event.currentTarget;
            const abilityName = target.dataset.ability;
            
            skillTooltip = createSkillTooltip(abilityName, characterData, proficientSkills);
            document.body.appendChild(skillTooltip);
            
            const rect = target.getBoundingClientRect();
            const tooltipRect = skillTooltip.getBoundingClientRect();
            let top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
            let left = rect.right + 10;
            
            if (left + tooltipRect.width > window.innerWidth) {
                left = rect.left - tooltipRect.width - 10;
            }
            if (top < 0) {
                top = 10;
            } else if (top + tooltipRect.height > window.innerHeight) {
                top = window.innerHeight - tooltipRect.height - 10;
            }
            
            skillTooltip.style.left = `${left}px`;
            skillTooltip.style.top = `${top}px`;
            skillTooltip.classList.add('visible');
        }

        function hideSkillTooltip() {
            if (skillTooltip) {
                skillTooltip.remove();
                skillTooltip = null;
            }
        }

        // Display character stats
        function displayCharacterStats(data) {
            // Save scroll position before updating
            const scrollableContainer = document.getElementById('stats-tab');
            const scrollPosition = scrollableContainer ? scrollableContainer.scrollTop : 0;
            
            // Preserve portrait to prevent flickering
            const existingPortrait = document.querySelector('.character-portrait');
            let shouldPreservePortrait = !!existingPortrait;
            
            const container = document.getElementById('stats-content');
            if (!data) {
                container.innerHTML = '<div class="loading">No character data available</div>';
                return;
            }
            
            // Data Normalization for Skills (Backward-Compatible)
            let proficientSkills = [];
            if (data.skills) {
                if (Array.isArray(data.skills)) {
                    // NEW FORMAT: Already an array of proficient skills
                    proficientSkills = data.skills;
                } else if (typeof data.skills === 'object') {
                    // OLD FORMAT: Object mapping skills to bonuses
                    // Infer proficiency by checking if bonus > ability modifier
                    Object.keys(SKILL_MAP).forEach(abilityName => {
                        const ability = abilityName.toLowerCase();
                        SKILL_MAP[abilityName].forEach(skill => {
                            const skillLower = skill.toLowerCase().replace(' ', '');
                            // Check various formats (lowercase, no spaces, etc.)
                            const skillValue = data.skills[skillLower] || 
                                               data.skills[skill.toLowerCase()] || 
                                               data.skills[skill];
                            if (skillValue !== undefined) {
                                const abilityMod = data.abilities[ability] ? 
                                    Math.floor((data.abilities[ability] - 10) / 2) : 0;
                                // If skill bonus > ability modifier, assume proficiency
                                if (skillValue > abilityMod) {
                                    proficientSkills.push(skill);
                                }
                            }
                        });
                    });
                }
            }
            
            function getModifier(score) { const mod = Math.floor((score - 10) / 2); return mod >= 0 ? `+${mod}` : `${mod}`; }
            const hpPercent = (data.hitPoints / data.maxHitPoints) * 100;
            let hpClass = '';
            if (hpPercent <= 25) hpClass = 'low'; else if (hpPercent <= 50) hpClass = 'medium';
            const normalizedName = data.name.toLowerCase().replace(/\s+/g, '_');
            let html = '<div class="character-sheet">';
            
            // --- NEW TWO-COLUMN TOP SECTION ---
            html += `<div class="character-sheet-top">
                        
                        <!-- COLUMN 1: PORTRAIT -->
                        <div class="character-portrait">
                            <img id="char-portrait-img" src="/static/portraits/${normalizedName}.png" onerror="this.onerror=null;this.src='/static/icons/default_portrait.png';">
                            <div class="upload-overlay" onclick="uploadPortrait('${normalizedName}')">
                                <span>Upload Portrait</span>
                            </div>
                            <!-- Hidden input removed - using persistent input instead -->
                        </div>
                        
                        <!-- COLUMN 2: HEADER INFO BOX -->
                        <div class="character-header-info">
                            <div class="character-name">${data.name}</div>
                            <div class="character-details">
                                <div><span class="orange">Level ${data.level}</span> ${data.race} ${data.class}</div>
                                <div><span class="orange">XP:</span> ${data.experience_points} / ${data.exp_required_for_next_level}</div>
                                <div><span class="orange">Profession:</span> ${data.background || 'Adventurer'}</div>
                                <div><span class="orange">Alignment:</span> ${capitalizeWords(data.alignment) || 'Neutral'}</div>
                            </div>
                        </div>
                    </div>`;
            if (data.abilities) {
                html += '<div class="abilities-row">';
                ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'].forEach(ability => {
                    const score = data.abilities[ability] || 10;
                    const capitalizedAbility = ability.charAt(0).toUpperCase() + ability.slice(1);
                    
                    // Pass data and proficientSkills to hover handlers
                    const dataString = JSON.stringify(data).replace(/"/g, '&quot;');
                    const skillsString = JSON.stringify(proficientSkills).replace(/"/g, '&quot;');
                    
                    html += `<div class="ability-score" 
                                  data-ability="${capitalizedAbility}"
                                  onmouseenter="showSkillTooltip(event, ${dataString}, ${skillsString})"
                                  onmouseleave="hideSkillTooltip()">
                                <div class="ability-name">${ability.substr(0, 3).toUpperCase()}</div>
                                <div class="ability-value">${score}</div>
                                <div class="ability-modifier">${getModifier(score)}</div>
                             </div>`;
                });
                html += '</div>';
            }
            
            // MODIFIED: Added 'currency' class to currency boxes
            html += `<div class="combat-stats">
                        <div class="combat-stat">
                            <div class="combat-stat-label">HP</div>
                            <div class="combat-stat-value">${data.hitPoints}/${data.maxHitPoints}</div>
                            <div class="hp-bar"><div class="hp-fill ${hpClass}" style="width: ${hpPercent}%"></div></div>
                        </div>
                        <div class="combat-stat">
                            <div class="combat-stat-label">AC</div>
                            <div class="combat-stat-value">${data.armorClass}</div>
                        </div>
                        <div class="combat-stat">
                            <div class="combat-stat-label">INIT</div>
                            <div class="combat-stat-value">${data.initiative >= 0 ? '+' : ''}${data.initiative}</div>
                        </div>
                        <div class="combat-stat currency">
                            <div class="combat-stat-label">GP</div>
                            <div class="combat-stat-value">${data.currency?.gold || 0}</div>
                        </div>
                        <div class="combat-stat currency">
                            <div class="combat-stat-label">SP</div>
                            <div class="combat-stat-value">${data.currency?.silver || 0}</div>
                        </div>
                        <div class="combat-stat currency">
                            <div class="combat-stat-label">CP</div>
                            <div class="combat-stat-value">${data.currency?.copper || 0}</div>
                        </div>
                    </div>`;

            // ADDED: Weapons and Ammunition sections
            html += '<div class="character-weapons-container">';
            
            // --- START OF WEAPONS & ATTACKS FIX ---
            if (data.attacksAndSpellcasting && data.attacksAndSpellcasting.length > 0) {
                html += '<div class="stat-group"><h4>Weapons & Attacks</h4><div class="stat-group-content">';
                data.attacksAndSpellcasting.forEach(weapon => { 
                    const description = (weapon.description || 'No description available.').replace(/"/g, '&quot;');
                    const damageString = weapon.damage || `${weapon.damageDice}+${weapon.damageBonus}`;
                    html += `<div class="feature-item" data-tooltip-title="${weapon.name}" data-tooltip-content="${description}">
                                <span class="feature-name" style="color: #4CAF50;">${weapon.name} (${damageString})</span>
                             </div>`; 
                });
                html += '</div></div>';
            } else {
                html += '<div class="stat-group"><h4>Weapons & Attacks</h4><div class="stat-group-content"><div class="inventory-item"><span class="item-name">No weapons defined.</span></div></div></div>';
            }
            // --- END OF WEAPONS & ATTACKS FIX ---

            if (data.ammunition && Array.isArray(data.ammunition) && data.ammunition.length > 0) {
                html += '<div class="stat-group"><h4>Ammunition</h4><div class="stat-group-content">';
                data.ammunition.forEach(ammo => {
                    html += `<div class="inventory-item" style="border-bottom: none; padding: 2px 4px;"><div class="item-main" style="margin-bottom: 0;"><span class="item-name" style="font-size: 16px;">${ammo.name}</span><span class="item-qty" style="font-size: 16px;">×${ammo.quantity}</span></div></div>`;
                });
                html += '</div></div>';
            } else {
                html += '<div class="stat-group"><h4>Ammunition</h4><div class="stat-group-content"><div class="inventory-item" style="border-bottom: none; padding: 2px 4px;"><span class="item-name" style="font-size: 16px;">No ammunition.</span></div></div></div>';
            }
            
            html += '</div>';

            // Saving Throws (Full-width with 2-column internal layout)
            if (data.savingThrows && data.savingThrows.length > 0) {
                html += '<div class="stat-group saving-throws-group" style="margin-top: 3px;"><h4>Saving Throws</h4><div class="stat-group-content">';
                ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'].forEach(save => {
                    const isProficient = data.savingThrows.includes(save);
                    const abilityMod = data.abilities ? Math.floor((data.abilities[save.toLowerCase()] - 10) / 2) : 0;
                    const bonus = isProficient ? abilityMod + (data.proficiencyBonus || 2) : abilityMod;
                    html += `<div class="save-item"><span class="save-name">${save} ${isProficient ? '●' : '○'}</span><span class="save-value">${bonus >= 0 ? '+' : ''}${bonus}</span></div>`;
                });
                html += '</div></div>';
            }
            // Skills section removed - now shown via ability score tooltips
            
            // Features and other sections (in abilities-grid for better layout)
            html += '<div class="abilities-grid">';
            if (data.classFeatures && data.classFeatures.length > 0) {
                html += '<div class="stat-group"><h4>Class Features</h4><div class="stat-group-content">';
                data.classFeatures.forEach(feature => {
                    let usageDisplay = '';
                    if (feature.usage && feature.usage.current !== undefined && feature.usage.max > 0) {
                        usageDisplay = ` <span class="usage-counter ${feature.usage.current === 0 ? 'exhausted' : ''}">${feature.usage.current}/${feature.usage.max}</span>`;
                    }
                    const description = (feature.description || 'No description available.').replace(/"/g, '&quot;');
                    html += `<div class="feature-item" data-tooltip-title="${feature.name}" data-tooltip-content="${description}"><span class="feature-name">${feature.name}</span>${usageDisplay}${(feature.usage && feature.usage.refreshOn) ? ` <span class="feature-refresh">(${feature.usage.refreshOn})</span>` : ''}</div>`;
                });
                html += '</div></div>';
            }
            if (data.temporaryEffects && data.temporaryEffects.length > 0) {
                html += '<div class="stat-group"><h4>Active Effects</h4><div class="stat-group-content">';
                data.temporaryEffects.forEach(effect => {
                    let durationDisplay = effect.duration ? ` <span class="effect-duration">${effect.duration}</span>` : '';
                    const description = (effect.description || 'No description available.').replace(/"/g, '&quot;');
                    html += `<div class="feature-item" data-tooltip-title="${effect.name}" data-tooltip-content="${description}"><div class="feature-header"><span class="feature-name">${effect.name}</span>${durationDisplay}</div></div>`;
                });
                html += '</div></div>';
            }
            if (data.racialTraits && data.racialTraits.length > 0) {
                const specialTraits = data.racialTraits.filter(trait => !['Ability Score Increase', 'Languages', 'Extra Language'].includes(trait.name));
                if (specialTraits.length > 0) {
                    html += '<div class="stat-group"><h4>Racial Traits</h4><div class="stat-group-content">';
                    specialTraits.forEach(trait => { 
                        const description = (trait.description || 'No description available.').replace(/"/g, '&quot;');
                        html += `<div class="feature-item" data-tooltip-title="${trait.name}" data-tooltip-content="${description}"><span class="feature-name">${trait.name}</span></div>`; 
                    });
                    html += '</div></div>';
                }
            }
            if (data.backgroundFeature && data.backgroundFeature.name) {
                const description = (data.backgroundFeature.description || 'No description available.').replace(/"/g, '&quot;');
                html += `<div class="stat-group"><h4>Background</h4><div class="stat-group-content"><div class="feature-item" data-tooltip-title="${data.backgroundFeature.name}" data-tooltip-content="${description}"><span class="feature-name">${data.backgroundFeature.name}</span></div></div></div>`;
            }
            if (data.feats && data.feats.length > 0) {
                html += '<div class="stat-group"><h4>Feats</h4><div class="stat-group-content">';
                data.feats.forEach(feat => { 
                    const description = (feat.description || 'No description available.').replace(/"/g, '&quot;');
                    html += `<div class="feature-item" data-tooltip-title="${feat.name}" data-tooltip-content="${description}"><span class="feature-name">${feat.name}</span></div>`; 
                });
                html += '</div></div>';
            }
            html += '</div>';

            html += '</div>'; // close character-sheet
            container.innerHTML = html;
            
            // If we had a portrait, restore it to prevent flickering
            if (shouldPreservePortrait && existingPortrait) {
                const newPortraitContainer = document.querySelector('.character-portrait');
                if (newPortraitContainer && existingPortrait) {
                    // Replace the newly created portrait with the preserved one
                    newPortraitContainer.parentNode.replaceChild(existingPortrait, newPortraitContainer);
                }
            }
            
            // Restore scroll position after updating
            if (scrollableContainer) {
                scrollableContainer.scrollTop = scrollPosition;
            }
            initializeAllTooltips();
        }
        
        // Display spells and magic items
        function displaySpellsAndMagic(data) {
            // Save scroll position before updating
            const scrollableContainer = document.getElementById('spells-tab');
            const scrollPosition = scrollableContainer ? scrollableContainer.scrollTop : 0;
            
            const container = document.getElementById('spells-content');
            if (!data) { container.innerHTML = '<div class="loading">No character data available</div>'; return; }
            let html = '<div class="spells-magic-sheet">';
            const hasSpellcasting = data.spellcasting && data.spellcasting.spells && Object.values(data.spellcasting.spells).some(s => Array.isArray(s) && s.length > 0);
            if (hasSpellcasting) {
                html += '<div class="spellcasting-section"><h3>SPELLCASTING</h3>';
                if (data.spellcasting.spellSaveDC || data.spellcasting.spellAttackBonus) { html += `<div class="spell-stats">${data.spellcasting.spellSaveDC ? `<span>Save DC: ${data.spellcasting.spellSaveDC}</span>` : ''}${data.spellcasting.spellAttackBonus ? `<span>Spell Attack: +${data.spellcasting.spellAttackBonus}</span>` : ''}</div>`; }
                const spellLevels = ['cantrips', 'level1', 'level2', 'level3', 'level4', 'level5', 'level6', 'level7', 'level8', 'level9'];
                const spellLevelNames = ['Cantrips', '1st Level', '2nd Level', '3rd Level', '4th Level', '5th Level', '6th Level', '7th Level', '8th Level', '9th Level'];
                spellLevels.forEach((level, index) => {
                    const spells = data.spellcasting.spells[level];
                    if (spells && spells.length > 0) {
                        html += `<div class="spell-level-group"><div class="spell-level-header"><span class="spell-level-name">${spellLevelNames[index]}</span>`;
                        if (index > 0 && data.spellcasting.spellSlots && data.spellcasting.spellSlots[`level${index}`]) {
                            const slots = data.spellcasting.spellSlots[`level${index}`];
                            const slotClass = slots.current === 0 ? 'exhausted' : slots.current <= slots.max * 0.5 ? 'low' : 'available';
                            html += `<span class="spell-slots ${slotClass}">${slots.current || 0}/${slots.max || 0} slots</span>`;
                        }
                        html += '</div><div class="spell-list">';
                        spells.forEach(spellName => {
                            html += `<div class="spell-item"><span class="spell-name">${spellName}</span><div class="spell-badges">${data.spellcasting.preparedSpells && data.spellcasting.preparedSpells.includes(spellName) ? '<span class="spell-badge prepared">P</span>' : ''}</div></div>`;
                        });
                        html += '</div></div>';
                    }
                });
                html += '</div>';
            } else {
                html += '<div class="no-spellcasting-message">This character does not have spellcasting abilities.</div>';
            }
            html += '<div class="magic-items-section">';
            const scrolls = data.equipment ? data.equipment.filter(i => i.item_subtype === 'scroll') : [];
            const potions = data.equipment ? data.equipment.filter(i => i.item_subtype === 'potion') : [];
            const magicalItems = data.equipment ? data.equipment.filter(i => i.magical && !['scroll', 'potion'].includes(i.item_subtype)) : [];
            if (scrolls.length > 0) {
                html += '<div class="magic-items-category"><h4>SCROLLS</h4>';
                scrolls.forEach(s => { 
                    const description = (s.description || 'No description available.').replace(/"/g, '&quot;');
                    html += `<div class="magic-item" data-tooltip-title="${s.item_name}" data-tooltip-content="${description}"><span class="magic-item-name">${s.item_name}</span>${s.spellLevel !== undefined ? `<span class="spell-badge">${s.spellLevel === 0 ? 'Cantrip' : `Level ${s.spellLevel}`}</span>` : ''}${s.quantity > 1 ? `<span class="magic-item-charges">×${s.quantity}</span>` : s.consumable ? '<span class="magic-item-charges consumable">[1x]</span>' : ''}</div>`; 
                });
                html += '</div>';
            }
            if (potions.length > 0) {
                html += '<div class="magic-items-category"><h4>POTIONS</h4>';
                potions.forEach(p => { 
                    const description = (p.description || 'No description available.').replace(/"/g, '&quot;');
                    html += `<div class="magic-item" data-tooltip-title="${p.item_name}" data-tooltip-content="${description}"><span class="magic-item-name">${p.item_name}</span>${p.quantity > 1 ? `<span class="magic-item-charges">×${p.quantity}</span>` : p.consumable ? '<span class="magic-item-charges consumable">[1x]</span>' : ''}</div>`; 
                });
                html += '</div>';
            }
            if (magicalItems.length > 0) {
                html += '<div class="magic-items-category"><h4>MAGIC ITEMS</h4>';
                magicalItems.forEach(item => {
                    let chargesHtml = '';
                    if (item.charges) {
                        const chargeClass = item.charges.current === 0 ? 'exhausted' : item.charges.current <= item.charges.max * 0.5 ? 'low' : 'available';
                        chargesHtml = `<span class="magic-item-charges ${chargeClass}">${item.charges.current || 0}/${item.charges.max || 0}</span>`;
                    }
                    const description = (item.description || 'No description available.').replace(/"/g, '&quot;');
                    html += `<div class="magic-item" data-tooltip-title="${item.item_name}" data-tooltip-content="${description}"><span class="magic-item-name">${item.item_name}</span>${chargesHtml}</div>`;
                });
                html += '</div>';
            }
            if (scrolls.length === 0 && potions.length === 0 && magicalItems.length === 0) {
                html += '<div class="magic-items-category"><h4>MAGIC ITEMS</h4><div class="magic-item"><span class="magic-item-name">No magical items found</span></div></div>';
            }
            html += '</div></div>';
            container.innerHTML = html;
            
            // Restore scroll position after updating
            if (scrollableContainer) {
                scrollableContainer.scrollTop = scrollPosition;
            }
            initializeAllTooltips();
        }
        
        // Display NPC information
        function displayNPCs(data) {
            // Save scroll position before updating
            const scrollableContainer = document.getElementById('npcs-tab');
            const scrollPosition = scrollableContainer ? scrollableContainer.scrollTop : 0;
            
            const container = document.getElementById('npcs-content');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No NPC data available</div>';
                return;
            }
            
            let html = '';
            data.forEach(npc => {
                const hpPercent = Math.max(0, (npc.hitPoints / npc.maxHitPoints) * 100);
                const hpClass = hpPercent > 75 ? 'healthy' : hpPercent > 50 ? 'injured' : hpPercent > 25 ? 'bloodied' : 'critical';
                
                html += `<div class="npc-character-sheet">`;
                
                html += `<div class="npc-header">`;
                html += `<div class="npc-header-main"><div class="npc-name">${npc.name}</div><div class="npc-details">${npc.race} ${npc.class} • Level ${npc.level} • ${capitalizeWords(npc.alignment)}</div></div>`;
                
                if (npc.experience_points !== undefined && npc.exp_required_for_next_level !== undefined) {
                    html += `<div class="npc-header-xp">
                                <div class="xp-label">XP</div>
                                <div class="xp-value">${npc.experience_points} / ${npc.exp_required_for_next_level}</div>
                             </div>`;
                }

                if (npc.currency) {
                    html += `<div class="npc-header-currency"><div class="currency-grid"><div class="currency-item"><span class="currency-amount">${npc.currency.gold || 0}</span><span class="currency-type">GP</span></div><div class="currency-item"><span class="currency-amount">${npc.currency.silver || 0}</span><span class="currency-type">SP</span></div><div class="currency-item"><span class="currency-amount">${npc.currency.copper || 0}</span><span class="currency-type">CP</span></div></div></div>`;
                }
                html += `</div>`;
                
                if (npc.abilities) {
                    html += '<div class="npc-abilities">';
                    html += `<div class="ability-score npc-combat-stat"><div class="ability-name">HP</div><div class="ability-value">${npc.hitPoints}/${npc.maxHitPoints}</div><div class="hp-bar"><div class="hp-fill ${hpClass}" style="width: ${hpPercent}%"></div></div></div>`;
                    html += `<div class="ability-score npc-combat-stat npc-no-circle"><div class="ability-name">AC</div><div class="ability-value">${npc.armorClass}</div></div>`;
                    html += `<div class="ability-score npc-combat-stat npc-no-circle"><div class="ability-name">INIT</div><div class="ability-value">${npc.initiative >= 0 ? '+' : ''}${npc.initiative}</div></div>`;
                    
                    const allAbilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
                    allAbilities.forEach(ability => {
                        if (npc.abilities[ability]) {
                            const score = npc.abilities[ability];
                            const modifier = Math.floor((score - 10) / 2);
                            html += `<div class="ability-score"><div class="ability-name">${ability.substr(0, 3).toUpperCase()}</div><div class="ability-value">${score}</div><div class="ability-modifier">${modifier >= 0 ? `+${modifier}` : modifier}</div></div>`;
                        }
                    });
                    html += '</div>';
                }
                
                html += '<div class="npc-skills-saves-container">';
                
                if (npc.savingThrows && npc.savingThrows.length > 0) {
                    const savesData = ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'].map(save => {
                        const isProficient = npc.savingThrows.includes(save);
                        const abilityMod = npc.abilities ? Math.floor((npc.abilities[save.toLowerCase()] - 10) / 2) : 0;
                        const bonus = isProficient ? abilityMod + (npc.proficiencyBonus || 3) : abilityMod;
                        return { name: save, proficient: isProficient, bonus: bonus >= 0 ? `+${bonus}` : `${bonus}` };
                    });
                    html += `<button class="npc-detail-button" onclick="showNPCSaves('${npc.name}', ${JSON.stringify(savesData).replace(/"/g, '&quot;')})">Saving Throw</button>`;
                }
                
                if (npc.skills) {
                    let skillsData = Object.entries(npc.skills).map(([skill, value]) => ({ name: skill, bonus: value >= 0 ? `+${value}` : `${value}` }));
                    html += `<button class="npc-detail-button" onclick="showNPCSkills('${npc.name}', ${JSON.stringify(skillsData).replace(/"/g, '&quot;')})">Skills</button>`;
                }
                
                if (npc.equipment && npc.equipment.length > 0) {
                    html += `<button class="npc-detail-button" onclick="showNPCInventory('${npc.name}', ${JSON.stringify(npc.equipment).replace(/"/g, '&quot;')})">Inventory</button>`;
                }

                if (npc.classFeatures && npc.classFeatures.length > 0) {
                    const featuresData = npc.classFeatures.map(f => ({ name: f.name, detail: f.description || '' }));
                    html += `<button class="npc-detail-button" onclick="showNPCDetailList('${npc.name}', 'Key Abilities', ${JSON.stringify(featuresData).replace(/"/g, '&quot;')})">Key Abilities</button>`;
                }

                if (npc.racialTraits && npc.racialTraits.length > 0) {
                    const traitsData = npc.racialTraits.map(t => ({ name: t.name, detail: t.description || '' }));
                    html += `<button class="npc-detail-button" onclick="showNPCDetailList('${npc.name}', 'Racial Traits', ${JSON.stringify(traitsData).replace(/"/g, '&quot;')})">Racial Traits</button>`;
                }

                if (npc.backgroundFeature && npc.backgroundFeature.name) {
                    const backgroundData = [{ name: npc.backgroundFeature.name, detail: npc.backgroundFeature.description || '' }];
                    html += `<button class="npc-detail-button" onclick="showNPCDetailList('${npc.name}', 'Background', ${JSON.stringify(backgroundData).replace(/"/g, '&quot;')})">Background</button>`;
                }
                
                if (npc.spellcasting && Object.keys(npc.spellcasting).length > 0) {
                    html += `<button class="npc-detail-button" onclick="showNPCSpells('${npc.name}', ${JSON.stringify(npc.spellcasting).replace(/"/g, '&quot;')})">Spells</button>`;
                }

                // Add a blank, disabled button to fill the grid if needed.
                html += `<button class="npc-detail-button" disabled style="background-color: #2c2c2c; cursor: default;"></button>`;
                
                html += '</div>';
                
                if (npc.status !== 'alive' || npc.condition !== 'none') {
                    html += `<div class="npc-status"><div class="status-item">Status: <span class="status-value ${npc.status}">${npc.status}</span></div>`;
                    if (npc.condition !== 'none') { html += `<div class="status-item">Condition: <span class="condition-value">${npc.condition}</span></div>`; }
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
            
            // Restore scroll position after updating
            if (scrollableContainer) {
                scrollableContainer.scrollTop = scrollPosition;
            }
        }
        
        function displayLocationData(data) {
            const locationName = document.getElementById('location-name');
            const locationDetails = document.getElementById('location-details');
            if (!data) {
                locationName.textContent = 'Location Unknown';
                locationDetails.textContent = '';
                return;
            }
            locationName.textContent = `${data.currentLocation} (${data.currentArea})`;
            const timeStr = data.time ? `${data.day} ${data.month} ${data.year} - ${data.time}` : 'Time Unknown';
            const idStr = data.currentLocationId ? `[${data.currentAreaId}:${data.currentLocationId}]` : '';
            locationDetails.textContent = `${timeStr} ${idStr}`;
            
            // Update time-of-day image based on game time
            updateTimeOfDayImage(data.time);
        }
        
        function updateTimeOfDayImage(timeStr) {
            if (!timeStr) return;
            
            const timeBackground = document.getElementById('time-background');
            if (!timeBackground) return;
            
            // Parse the time string (format: "HH:MM:SS")
            const timeParts = timeStr.split(':');
            const hour = parseInt(timeParts[0]);
            
            let imageName = 'midday.jpg'; // Default
            
            // Determine which image to use based on hour
            if (hour >= 5 && hour < 9) {
                imageName = 'sunrise.jpg';  // 5am-8:59am
            } else if (hour >= 9 && hour < 17) {
                imageName = 'midday.jpg';   // 9am-4:59pm
            } else if (hour >= 17 && hour < 21) {
                imageName = 'sunset.jpg';    // 5pm-8:59pm
            } else {
                imageName = 'nightfall.jpg'; // 9pm-4:59am
            }
            
            // Update the image source if it's different
            const newSrc = `/static/media/environment/${imageName}`;
            if (timeBackground.src !== newSrc && !timeBackground.src.endsWith(imageName)) {
                timeBackground.src = newSrc;
            }
        }
        
        socket.on('player_data_response', (response) => {
            if (response.dataType === 'inventory') {
                const activeTab = document.querySelector('.tab-button.active')?.textContent.toLowerCase();
                if (activeTab === 'spells & magic') {
                    displaySpellsAndMagic(response.data);
                } else {
                    displayInventory(response.data);
                }
            } else if (response.dataType === 'stats') {
                // Capture player name when stats are loaded
                if (response.data && response.data.name) {
                    playerName = response.data.name;
                }
                displayCharacterStats(response.data);
            } else if (response.dataType === 'spells') {
                displaySpellsAndMagic(response.data);
            } else if (response.dataType === 'npcs') {
                displayNPCs(response.data);
            }
        });
        
        socket.on('location_data_response', (response) => { displayLocationData(response.data); });
        
        // Socket listener for initiative data
        socket.on('initiative_data_response', (response) => {
            const container = document.getElementById('initiative-tracker-container');
            const partyContainer = document.getElementById('party-display-container');
            const headerLabel = document.getElementById('panel-header-label');
            const combatRoundBox = document.getElementById('combat-round-box');
            const adventureBox = document.getElementById('adventure-box');
            const combatRoundNumber = document.getElementById('combat-round-number');
            
            if (!response || !response.active || !response.combatants || response.combatants.length === 0) {
                container.style.display = 'none'; // Hide tracker if combat is not active
                partyContainer.style.display = 'flex'; // Show party display when not in combat
                initiativeOrder = [];
                // When not in combat, hide combat box and show adventure box
                headerLabel.style.display = 'none'; // Hide label when showing adventure box
                if (combatRoundBox) combatRoundBox.style.display = 'none';
                if (adventureBox) adventureBox.style.display = 'flex';
                // Request party data to refresh display
                requestPartyData();
                return;
            }

            // Check if we're hovering or video is playing - if so, skip update
            const videoPopup = document.getElementById('video-popup');
            if (isHoveringInitiative || (videoPopup && videoPopup.style.display === 'block')) {
                // Either hovering (might show video soon) or video is playing, don't update
                return;
            }

            initiativeOrder = response.combatants; // Store the order for later use
            container.style.display = 'flex'; // Show the tracker
            partyContainer.style.display = 'none'; // Hide party display during combat
            container.innerHTML = ''; // Clear any old items
            
            // When in combat, hide the adventure box and show combat box
            headerLabel.style.display = 'none';
            if (adventureBox) adventureBox.style.display = 'none';
            if (combatRoundBox) {
                combatRoundBox.style.display = 'flex';
                if (combatRoundNumber) {
                    combatRoundNumber.textContent = response.round || 1;
                }
            }

            // Loop through the combatants and create a box for each one
            initiativeOrder.forEach(combatant => {
                const item = document.createElement('div');
                item.classList.add('initiative-item', combatant.type);
                item.dataset.name = combatant.name; // Use a data attribute for easy selection
                
                // Preserve hover state if this was the previously hovered item
                if (currentlyHoveredName === combatant.name) {
                    item.classList.add('preserve-hover');
                    // Simulate mouse enter to maintain tooltip
                    setTimeout(() => {
                        const event = new MouseEvent('mouseenter', {
                            view: window,
                            bubbles: true,
                            cancelable: true
                        });
                        item.dispatchEvent(event);
                    }, 10);
                }
                
                // Extract monster type from name (e.g., "Skeleton_1" -> "Skeleton")
                let displayName = combatant.name.replace(/_/g, ' ');
                
                // For enemies and NPCs, extract just the creature type (remove numbers)
                if (combatant.type === 'enemy' || combatant.type === 'npc') {
                    // Remove trailing numbers and spaces (e.g., "Skeleton 1" -> "Skeleton")
                    displayName = displayName.replace(/\s*\d+\s*$/, '').trim();
                    
                    // For multi-word types, keep them as is for wrapping
                    // e.g., "Dire Wolf" stays as "Dire Wolf"
                }
                
                // Show HP if available in tooltip
                let hpText = '';
                if (combatant.currentHp !== undefined && combatant.maxHp !== undefined) {
                    hpText = ` - HP: ${combatant.currentHp}/${combatant.maxHp}`;
                }
                
                // Add special handling for enemy monsters with media assets
                if (combatant.type === 'enemy' && combatant.monsterType) {
                    // Use the monsterType field for lookup
                    const monsterType = combatant.monsterType.toLowerCase();
                    // Use new smart media endpoint that checks module folder first
                    const monsterThumbUrl = `/media/monsters/${monsterType}_thumb.jpg`;
                    const monsterVideoUrl = `/media/monsters/${monsterType}_video.mp4`;
                    
                    // Set thumbnail - try JPG first, then PNG
                    item.style.backgroundSize = 'cover';
                    const thumbImg = new Image();
                    thumbImg.onload = () => {
                        item.style.backgroundImage = `url('${monsterThumbUrl}')`;
                    };
                    thumbImg.onerror = () => {
                        // Try PNG instead
                        const pngUrl = `/media/monsters/${monsterType}_thumb.png`;
                        const pngImg = new Image();
                        pngImg.onload = () => {
                            item.style.backgroundImage = `url('${pngUrl}')`;
                        };
                        pngImg.onerror = () => {
                            // Try with/without 's' at the end
                            const altName = monsterType.endsWith('s') ? 
                                monsterType.slice(0, -1) : monsterType + 's';
                            const altUrl = `/media/monsters/${altName}_thumb.jpg`;
                            const altImg = new Image();
                            altImg.onload = () => {
                                item.style.backgroundImage = `url('${altUrl}')`;
                            };
                            altImg.onerror = () => {
                                // Try alt name with PNG
                                const altPngUrl = `/media/monsters/${altName}_thumb.png`;
                                const altPngImg = new Image();
                                altPngImg.onload = () => {
                                    item.style.backgroundImage = `url('${altPngUrl}')`;
                                };
                                altPngImg.onerror = () => {
                                    // No thumbnail available
                                    item.style.cursor = 'default';
                                };
                                altPngImg.src = altPngUrl;
                            };
                            altImg.src = altUrl;
                        };
                        pngImg.src = pngUrl;
                    };
                    thumbImg.src = monsterThumbUrl;
                    item.style.backgroundPosition = 'center';
                    item.style.color = 'white';
                    item.style.textShadow = '1px 1px 2px black, -1px -1px 2px black';
                    item.style.cursor = 'pointer';
                    
                    // NEW: Show stats on hover, media on click (using smart attachment)
                    attachTooltipListeners(item);
                    item.addEventListener('click', function() {
                        // On click, check for video first. If it exists, show it.
                        // If not, fall back to showing the full-size image.
                        const video = document.createElement('video');
                        video.src = monsterVideoUrl;
                        video.onloadedmetadata = () => showVideoPopup(item, monsterVideoUrl);
                        video.onerror = () => {
                            // Video failed, try full-size JPG image
                            const imgJpg = new Image();
                            imgJpg.src = `/media/monsters/${monsterType}.jpg`;
                            imgJpg.onload = () => showImagePopup(item, imgJpg.src);
                            imgJpg.onerror = () => {
                                // JPG failed, try PNG image
                                const imgPng = new Image();
                                imgPng.src = `/media/monsters/${monsterType}.png`;
                                imgPng.onload = () => showImagePopup(item, imgPng.src);
                                imgPng.onerror = () => {
                                    // No media available, show the thumbnail if it exists
                                    if (item.style.backgroundImage) {
                                        // Extract the URL from the background-image style
                                        const bgUrl = item.style.backgroundImage.slice(5, -2);
                                        showImagePopup(item, bgUrl);
                                    }
                                };
                            };
                        };
                    });
                }
                
                // Add special handling for player characters - set portrait image directly
                if (combatant.type === 'player') {
                    // Clean the character name for the filename
                    const cleanName = combatant.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    const portraitUrl = `/static/portraits/${cleanName}.png`;
                    
                    // Set the portrait directly (same as skeleton approach)
                    item.style.backgroundImage = `url('${portraitUrl}')`;
                    item.style.backgroundSize = 'cover';
                    item.style.backgroundPosition = 'center';
                    item.style.color = 'white';
                    item.style.textShadow = '1px 1px 2px black, -1px -1px 2px black';
                    
                    // Add error handler for missing images
                    const img = new Image();
                    img.onerror = () => {
                        // If portrait doesn't exist, remove the background image
                        item.style.backgroundImage = '';
                    };
                    img.src = portraitUrl;
                }
                
                // Add special handling for NPCs
                if (combatant.type === 'npc') {
                    // Convert NPC name to filename format (e.g., "Scout Kira" -> "scout_kira")
                    const npcFilename = combatant.name.toLowerCase().replace(/\s+/g, '_');
                    const nameLower = combatant.name.toLowerCase();
                    
                    // First try NPC-specific thumbnail (static approach to avoid flicker)
                    // Assume if there's a thumbnail, there might be a video
                    // Use new smart media endpoint that checks module folder first
                    let portraitUrl = `/media/npcs/${npcFilename}_thumb.jpg`;
                    let fallbackPortrait = '/static/media/class_portraits/default_npc.png';
                    
                    // Determine class-based fallback portrait
                    if (nameLower.includes('ranger')) {
                        fallbackPortrait = '/static/media/class_portraits/ranger.png';
                    } else if (nameLower.includes('scout')) {
                        fallbackPortrait = '/static/media/class_portraits/rogue.png';
                    } else if (nameLower.includes('cleric')) {
                        fallbackPortrait = '/static/media/class_portraits/cleric.png';
                    } else if (nameLower.includes('druid')) {
                        fallbackPortrait = '/static/media/class_portraits/druid.png';
                    } else if (nameLower.includes('paladin')) {
                        fallbackPortrait = '/static/media/class_portraits/paladin.png';
                    } else if (nameLower.includes('rogue')) {
                        fallbackPortrait = '/static/media/class_portraits/rogue.png';
                    } else if (nameLower.includes('fighter')) {
                        fallbackPortrait = '/static/media/class_portraits/fighter.png';
                    } else if (nameLower.includes('barbarian')) {
                        fallbackPortrait = '/static/media/class_portraits/barbarian.png';
                    } else if (nameLower.includes('monk')) {
                        fallbackPortrait = '/static/media/class_portraits/monk.png';
                    } else if (nameLower.includes('bard')) {
                        fallbackPortrait = '/static/media/class_portraits/bard.png';
                    } else if (nameLower.includes('wizard') || nameLower.includes('sorcerer') || 
                               nameLower.includes('warlock') || nameLower.includes('mage')) {
                        fallbackPortrait = '/static/media/class_portraits/wizard.png';
                    }
                    
                    // Set portrait immediately (try NPC thumb first)
                    item.style.backgroundImage = `url('${portraitUrl}')`;
                    item.style.backgroundSize = 'cover';
                    item.style.backgroundPosition = 'center';
                    item.style.color = 'white';
                    item.style.textShadow = '1px 1px 2px black, -1px -1px 2px black';
                    
                    // Always try to add video hover for NPCs (will silently fail if no video)
                    item.style.cursor = 'pointer';
                    const npcVideoUrl = `/media/npcs/${npcFilename}_video.mp4`;
                    
                    // NEW: Always add stats tooltip on hover (using smart attachment)
                    attachTooltipListeners(item);
                    
                    // Check if video exists by trying to load it
                    const videoTest = document.createElement('video');
                    videoTest.src = npcVideoUrl;
                    videoTest.onloadedmetadata = () => {
                        // Video exists, add click handler for video
                        item.addEventListener('click', (event) => {
                            showVideoPopup(event.currentTarget, npcVideoUrl);
                        });
                    };
                    videoTest.onerror = () => {
                        // No video, clicking will do nothing
                        item.style.cursor = 'default';
                    };
                    
                    // Silent image validation for fallback
                    const img = new Image();
                    img.onerror = () => {
                        // NPC thumb doesn't exist, use class-based fallback
                        item.style.backgroundImage = `url('${fallbackPortrait}')`;
                    };
                    img.src = portraitUrl;
                }
                
                // Create text element with dynamic sizing
                const textSpan = document.createElement('span');
                textSpan.classList.add('initiative-item-text');
                textSpan.textContent = displayName;
                
                // Dynamic font sizing based on text length
                if (displayName.length <= 6) {
                    textSpan.style.fontSize = '11px';
                } else if (displayName.length <= 10) {
                    textSpan.style.fontSize = '9px';
                } else {
                    textSpan.style.fontSize = '8px';
                }
                
                item.appendChild(textSpan);
                
                // Store stats data for tooltip
                item.dataset.stats = JSON.stringify(combatant);
                
                container.appendChild(item);
            });

            // This ensures the highlight is correct as soon as the tracker is drawn.
            highlightCurrentTurn();
            
            // Setup the custom scroll arrows
            setupScrollers();
        });
        
        // Socket listener for party data (non-combat display)
        socket.on('party_data_response', (response) => {
            const partyContainer = document.getElementById('party-display-container');
            const initiativeContainer = document.getElementById('initiative-tracker-container');
            
            // Only show party display if not in combat
            if (initiativeContainer.style.display === 'none' || !initiativeContainer.children.length) {
                const videoPopup = document.getElementById('media-popup');
                if (isHoveringInitiative || (videoPopup && videoPopup.classList.contains('visible'))) {
                    return;
                }
                
                partyContainer.innerHTML = '';
                partyContainer.style.display = 'flex';
                
                if (!response || ((!response.members || response.members.length === 0) && 
                    (!response.location_npcs || response.location_npcs.length === 0))) {
                    partyContainer.style.display = 'none';
                    return;
                }
                
                const renderMember = (member, isLocationNpc = false) => {
                    const item = document.createElement('div');
                    item.classList.add(isLocationNpc ? 'location-npc-item' : 'party-member-item', member.type);
                    
                    // Preserve hover state if this was the previously hovered item
                    if (currentlyHoveredName === member.name) {
                        item.classList.add('preserve-hover');
                        // Simulate mouse enter to maintain tooltip
                        setTimeout(() => {
                            const event = new MouseEvent('mouseenter', {
                                view: window,
                                bubbles: true,
                                cancelable: true
                            });
                            item.dispatchEvent(event);
                        }, 10);
                    }
                    
                    const cleanName = member.name.toLowerCase().replace(/\s+/g, '_').replace(/'/g, "");
                    const basePath = member.type === 'player' ? `/static/portraits/${cleanName}` : `/media/npcs/${cleanName}`;
                    const thumbUrl = member.type === 'player' ? `${basePath}.png` : `${basePath}_thumb.jpg`;
                    const videoUrl = `${basePath}_video.mp4`;

                    item.style.backgroundImage = `url('${thumbUrl}')`;
                    item.style.backgroundSize = 'cover';
                    item.style.backgroundPosition = 'center';
                    item.style.color = 'white';
                    item.style.textShadow = '1px 1px 2px black, -1px -1px 2px black';
                    item.style.cursor = 'pointer';

                    const textSpan = document.createElement('span');
                    textSpan.classList.add('initiative-item-text');
                    textSpan.textContent = member.name;

                    if (member.name.length <= 6) textSpan.style.fontSize = '11px';
                    else if (member.name.length <= 10) textSpan.style.fontSize = '9px';
                    else textSpan.style.fontSize = '8px';
                    
                    item.appendChild(textSpan);

                    let hpText = isLocationNpc ? ' (In Location)' : '';
                    if (member.currentHp !== undefined && member.maxHp !== undefined) {
                        hpText += ` - HP: ${member.currentHp}/${member.maxHp}`;
                    }
                    
                    // Store stats data for tooltip
                    item.dataset.stats = JSON.stringify(member);

                    // NEW: Show stats on hover, media on click (using smart attachment)
                    attachTooltipListeners(item);

                    item.addEventListener('click', function() {
                        // On click, check for video first. If it exists, show it.
                        // If not, fall back to showing the full-size image.
                        const video = document.createElement('video');
                        video.src = videoUrl;
                        video.onloadedmetadata = () => showVideoPopup(item, videoUrl);
                        video.onerror = () => {
                            // Video failed, try JPG image
                            const imgJpg = new Image();
                            imgJpg.src = basePath + '.jpg';
                            imgJpg.onload = () => showImagePopup(item, imgJpg.src);
                            imgJpg.onerror = () => {
                                // JPG failed, try PNG image
                                const imgPng = new Image();
                                imgPng.src = basePath + '.png';
                                imgPng.onload = () => showImagePopup(item, imgPng.src);
                            };
                        };
                    });

                    partyContainer.appendChild(item);

                    const img = new Image();
                    img.onerror = () => item.style.backgroundImage = '';
                    img.src = thumbUrl;
                };

                if (response.members) response.members.forEach(member => renderMember(member, false));
                if (response.location_npcs) response.location_npcs.forEach(npc => renderMember(npc, true));
            } else {
                // Hide party display during combat
                partyContainer.style.display = 'none';
            }
            
            // Setup the custom scroll arrows
            setupScrollers();
        });
        
        setInterval(() => {
            loadLocationData();
            requestInitiativeData(); // Refresh initiative tracker periodically
            requestPartyData(); // Refresh party display periodically
            const activeTab = document.querySelector('.tab-button.active')?.textContent.toLowerCase();
            if (activeTab === 'inventory') loadInventory();
            else if (activeTab === 'character') loadCharacterStats();
            else if (activeTab === 'spells & magic') loadSpellsAndMagic();
            else if (activeTab === 'npcs') loadNPCs();
        }, 5000);
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('user-input').focus();
            loadLocationData();
            requestInitiativeData(); // Load initiative tracker on page load
            requestPartyData(); // Load party display on page load
            if (connected) {
                loadCharacterStats();
            }
            
            // Initialize image generation toggle from localStorage
            const imageToggle = document.getElementById('image-generation-toggle');
            const savedImageGenState = localStorage.getItem('imageGenerationEnabled');
            if (savedImageGenState !== null) {
                imageToggle.checked = savedImageGenState === 'true';
            }

            // Handle toggle changes
            imageToggle.addEventListener('change', function() {
                localStorage.setItem('imageGenerationEnabled', this.checked);
                // Update visibility of existing buttons
                updateImageButtonVisibility();
            });
            
            // Initialize model toggle
            const modelToggle = document.getElementById('model-toggle');
            const modelToggleText = document.getElementById('model-toggle-text');
            const modelToggleLabel = document.getElementById('model-toggle-label');
            
            // Create model tooltip
            const modelTooltip = document.createElement('div');
            modelTooltip.className = 'model-tooltip';
            modelTooltip.innerHTML = `
                <div class="model-tooltip-header">GPT-5 Model Information</div>
                <div class="model-tooltip-content">
                    <strong>Testing as GPT-4.1 replacement</strong><br>
                    • Significant cost savings in token usage<br>
                    • Slower response times (especially full model)<br>
                    • More accurate and detailed responses<br>
                    • Very structured, may break immersion
                </div>
                <div class="model-tooltip-warning">
                    Warning: Untested - may have unpredictable results
                </div>
            `;
            document.body.appendChild(modelTooltip);
            
            // Show tooltip on hover
            modelToggleLabel.addEventListener('mouseenter', function(e) {
                const rect = this.getBoundingClientRect();
                modelTooltip.style.left = rect.left + 'px';
                modelTooltip.style.top = (rect.bottom + 5) + 'px';
                modelTooltip.classList.add('visible');
            });
            
            modelToggleLabel.addEventListener('mouseleave', function() {
                modelTooltip.classList.remove('visible');
            });
            
            // Handle model toggle changes
            modelToggle.addEventListener('change', function() {
                const useGPT5 = this.checked;
                
                // Show warning when enabling GPT-5
                if (useGPT5) {
                    const hasSeenWarning = localStorage.getItem('gpt5WarningShown');
                    if (!hasSeenWarning) {
                        showGPT5Warning();
                        localStorage.setItem('gpt5WarningShown', 'true');
                    }
                }
                
                modelToggleText.textContent = useGPT5 ? 'GPT-5' : 'GPT-4.1';
                
                // Send toggle state to backend
                socket.emit('toggle_model', { use_gpt5: useGPT5 });
                
                // Log the change
                console.log('Model toggled to:', useGPT5 ? 'GPT-5' : 'GPT-4.1');
            });
            
            // Listen for model toggle confirmation from server
            socket.on('model_toggled', function(data) {
                console.log('Model toggle confirmed:', data);
                modelToggle.checked = data.use_gpt5;
                modelToggleText.textContent = data.use_gpt5 ? 'GPT-5' : 'GPT-4.1';
            });
            
            // Listen for module creation progress updates
            socket.on('module_creation_progress', function(data) {
                console.log('Module creation progress:', data);
                const modal = document.getElementById('module-progress-modal');
                modal.style.display = 'block';
                
                // Update progress display
                document.getElementById('current-stage').textContent = data.stage || 0;
                document.getElementById('total-stages').textContent = data.total_stages || 9;
                document.getElementById('stage-name').textContent = data.stage_name || 'Processing...';
                document.getElementById('module-progress-bar').style.width = (data.percentage || 0) + '%';
                document.getElementById('progress-percentage').textContent = (data.percentage || 0) + '%';
                document.getElementById('progress-message').textContent = data.message || 'Working...';
                
                // Hide modal when complete
                if (data.percentage >= 100) {
                    setTimeout(() => {
                        modal.style.display = 'none';
                        // Show success message in game output
                        addMessage({
                            type: 'system',
                            content: 'Module creation completed successfully!'
                        });
                    }, 3000); // Show completion for 3 seconds
                }
            });
            
            // --- START: Additions for Robust Media Popup Closing ---
            const mediaPopup = document.getElementById('media-popup');
            mediaPopup.addEventListener('click', (event) => {
                // This ensures we only hide the popup if the user clicks on the dark
                // overlay itself, not on the video/image content.
                if (event.target === mediaPopup) {
                    hideVideoPopup();
                }
            });
            // --- END: Additions for Robust Media Popup Closing ---
        });
        
        // Function to update image button visibility
        function updateImageButtonVisibility() {
            const isEnabled = document.getElementById('image-generation-toggle').checked;
            const imageButtons = document.querySelectorAll('.image-generation-button');
            imageButtons.forEach(button => {
                button.style.display = isEnabled ? 'inline-block' : 'none';
            });
        }
        
        function showNPCDetailList(npcName, modalTitle, itemsData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');

            title.textContent = `${npcName}'s ${modalTitle}`;
            
            let html = '';
            if (itemsData && itemsData.length > 0) {
                itemsData.forEach(item => {
                    const detailText = item.detail ? `title="${item.detail.replace(/"/g, '&quot;')}"` : '';
                    html += `<div class="npc-details-item" ${detailText}><span class="npc-details-name">${item.name}</span></div>`;
                });
            } else {
                html = `<div class="npc-details-item">No ${modalTitle.toLowerCase()} available.</div>`;
            }
            
            body.innerHTML = html;
            modal.style.display = 'block';
        }

        function showNPCInventory(npcName, equipment) {
            const modal = document.getElementById('npc-inventory-modal');
            const title = document.getElementById('npc-inventory-title');
            const body = document.getElementById('npc-inventory-body');
            title.textContent = `${npcName}'s Inventory`;
            let html = '';
            if (equipment && equipment.length > 0) {
                equipment.forEach(item => {
                    html += `<div class="npc-inventory-item"><div class="npc-inventory-item-header"><div class="npc-inventory-item-name">${item.item_name}</div><div class="npc-inventory-item-quantity">x${item.quantity || 1}</div></div><div class="npc-inventory-item-details">${item.item_type}</div>`;
                    if (item.description) { html += `<div class="npc-inventory-item-description">${item.description}</div>`; }
                    html += '</div>';
                });
            } else { html = '<div class="npc-inventory-item">No items in inventory.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function closeNPCInventory() { document.getElementById('npc-inventory-modal').style.display = 'none'; }
        
        function showNPCSkills(npcName, skillsData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');
            title.textContent = `${npcName}'s Skills`;
            let html = '';
            if (skillsData && skillsData.length > 0) {
                skillsData.forEach(skill => { html += `<div class="npc-details-item"><span class="npc-details-name">${skill.name}</span><span class="npc-details-bonus">${skill.bonus}</span></div>`; });
            } else { html = '<div class="npc-details-item">No skills available.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function showNPCSaves(npcName, savesData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');
            title.textContent = `${npcName}'s Saving Throws`;
            let html = '';
            if (savesData && savesData.length > 0) {
                savesData.forEach(save => { html += `<div class="npc-details-item"><span class="npc-details-name">${save.name} ${save.proficient ? '●' : '○'}</span><span class="npc-details-bonus">${save.bonus}</span></div>`; });
            } else { html = '<div class="npc-details-item">No saving throws available.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function showNPCSpells(npcName, spellsData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');
            title.textContent = `${npcName}'s Spellcasting`;
            let html = '';
            if (spellsData.spellSaveDC || spellsData.spellAttackBonus) { html += `<div class="npc-spell-info">${spellsData.spellSaveDC ? `<span class="npc-spell-stat">Save DC: ${spellsData.spellSaveDC}</span>` : ''}${spellsData.spellAttackBonus ? `<span class="npc-spell-stat">Attack: +${spellsData.spellAttackBonus}</span>` : ''}</div>`; }
            if (spellsData && spellsData.spellsByLevel && spellsData.spellsByLevel.length > 0) {
                spellsData.spellsByLevel.forEach(levelData => {
                    html += `<div class="npc-spell-level"><div class="npc-spell-level-header"><span class="npc-spell-level-name">${levelData.level}</span>`;
                    if (levelData.levelNum > 0 && levelData.slots) {
                        const slotClass = levelData.slots.current === 0 ? 'exhausted' : levelData.slots.current <= levelData.slots.max * 0.5 ? 'low' : 'available';
                        html += `<span class="npc-spell-slots ${slotClass}">${levelData.slots.current || 0}/${levelData.slots.max || 0} slots</span>`;
                    }
                    html += `</div><div class="npc-spell-list">`;
                    levelData.spells.forEach(spell => { html += `<div class="npc-spell-item">${spell}</div>`; });
                    html += `</div></div>`;
                });
            } else { html = '<div class="npc-details-item">No spells available.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function closeNPCDetails() { document.getElementById('npc-details-modal').style.display = 'none'; }
        
        // Full image display functions
        function showGPT5Warning() {
            document.getElementById('gpt5-warning-modal').style.display = 'block';
        }
        
        function closeGPT5Warning() {
            document.getElementById('gpt5-warning-modal').style.display = 'none';
        }
        
        function showNPCSpells(npcName, spellsData) {
            const modal = document.getElementById('npc-spells-modal');
            const title = document.getElementById('npc-spells-modal-title');
            const body = document.getElementById('npc-spells-modal-body');

            title.textContent = `${npcName}'s Spellcasting`;

            let html = '';
            const hasSpellcasting = spellsData && spellsData.spells && Object.values(spellsData.spells).some(s => Array.isArray(s) && s.length > 0);

            if (hasSpellcasting) {
                html += '<div class="spellcasting-section">';
                if (spellsData.spellSaveDC || spellsData.spellAttackBonus) {
                    html += `<div class="spell-stats">
                                ${spellsData.spellSaveDC ? `<span>Save DC: ${spellsData.spellSaveDC}</span>` : ''}
                                ${spellsData.spellAttackBonus ? `<span>Spell Attack: +${spellsData.spellAttackBonus}</span>` : ''}
                             </div>`;
                }

                const spellLevels = ['cantrips', 'level1', 'level2', 'level3', 'level4', 'level5', 'level6', 'level7', 'level8', 'level9'];
                const spellLevelNames = ['Cantrips', '1st Level', '2nd Level', '3rd Level', '4th Level', '5th Level', '6th Level', '7th Level', '8th Level', '9th Level'];

                spellLevels.forEach((level, index) => {
                    const spells = spellsData.spells[level];
                    if (spells && spells.length > 0) {
                        html += `<div class="spell-level-group"><div class="spell-level-header"><span class="spell-level-name">${spellLevelNames[index]}</span>`;
                        if (index > 0 && spellsData.spellSlots && spellsData.spellSlots[`level${index}`]) {
                            const slots = spellsData.spellSlots[`level${index}`];
                            const slotClass = slots.current === 0 ? 'exhausted' : slots.current <= slots.max * 0.5 ? 'low' : 'available';
                            html += `<span class="spell-slots ${slotClass}">${slots.current || 0}/${slots.max || 0} slots</span>`;
                        }
                        html += '</div><div class="spell-list">';
                        spells.forEach(spellName => {
                            html += `<div class="spell-item"><span>${spellName}</span></div>`;
                        });
                        html += '</div></div>';
                    }
                });
                html += '</div>';
            } else {
                html = '<div class="no-spellcasting-message">This character does not have spellcasting abilities.</div>';
            }

            body.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeNPCSpells() {
            document.getElementById('npc-spells-modal').style.display = 'none';
        }
        
        // Open Module Toolkit in new window
        function openToolkit() {
            window.open('/toolkit', 'ModuleToolkit', 'width=1400,height=900');
        }
        
        let diceRolls = { d20: [], damage: [] };
        function rollDice(sides) {
            // Use rejection sampling to avoid modulo bias
            const maxValid = Math.floor(4294967296 / sides) * sides;
            let result;
            do {
                const array = new Uint32Array(1);
                crypto.getRandomValues(array);
                result = array[0];
            } while (result >= maxValid);
            
            result = (result % sides) + 1;
            
            if (sides === 20) { diceRolls.d20.push(result); } 
            else { diceRolls.damage.push({sides: sides, result: result}); }
            updateDiceDisplay();
        }
        function updateDiceDisplay() {
            const resultsDiv = document.getElementById('dice-results');
            let html = '';
            if (diceRolls.d20.length > 0) { html += '<span class="dice-result-item">d20: ' + diceRolls.d20.join(', d20: ') + '</span>'; }
            if (diceRolls.damage.length > 0) {
                if (html) html += ' | ';
                html += '<span class="dice-result-item">' + diceRolls.damage.map(r => `d${r.sides}: ${r.result}`).join(', ') + '</span>';
                html += '<span class="dice-total">Total: ' + diceRolls.damage.reduce((sum, r) => sum + r.result, 0) + '</span>';
            }
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = html ? 'block' : 'none';
        }
        function clearDiceResults() { diceRolls.d20 = []; diceRolls.damage = []; updateDiceDisplay(); }
        
        let currentSearchTerm = '', currentFilter = '', filtersActive = false, currentSort = 'name-asc';
        function applyFiltersAndSort() {
            if (!originalInventoryData) return;
            let data = JSON.parse(JSON.stringify(originalInventoryData));
            if (data.equipment && currentSort) {
                data.equipment.sort((a, b) => {
                    switch (currentSort) {
                        case 'name-asc': return a.item_name.localeCompare(b.item_name);
                        case 'name-desc': return b.item_name.localeCompare(a.item_name);
                        case 'type': return a.item_type.localeCompare(b.item_type) || a.item_name.localeCompare(b.item_name);
                        case 'quantity': return (b.quantity || 1) - (a.quantity || 1) || a.item_name.localeCompare(b.item_name);
                        default: return 0;
                    }
                });
            }
            if (data.equipment) {
                data.equipment = data.equipment.filter(item => {
                    const search = !currentSearchTerm || item.item_name.toLowerCase().includes(currentSearchTerm) || (item.description && item.description.toLowerCase().includes(currentSearchTerm)) || item.item_type.toLowerCase().includes(currentSearchTerm);
                    let filter = true;
                    if (currentFilter) {
                        switch (currentFilter) {
                            case 'weapon': filter = item.item_type === 'weapon'; break;
                            case 'armor': filter = item.item_type === 'armor'; break;
                            case 'consumable': filter = item.item_type === 'consumable' || item.consumable; break;
                            case 'magical': filter = item.magical; break;
                            case 'equipped': filter = item.equipped; break;
                        }
                    }
                    return search && filter;
                });
            }
            displayInventory(data, true);
        }
        function sortInventory() { currentSort = document.getElementById('inventory-sort').value; filtersActive = true; applyFiltersAndSort(); }
        function changeFilter() { currentFilter = document.getElementById('filter-dropdown').value; filtersActive = true; applyFiltersAndSort(); }
        function openSearchPopup() { document.getElementById('search-popup').style.display = 'block'; document.getElementById('search-popup-input').focus(); }
        function closeSearchPopup() { document.getElementById('search-popup').style.display = 'none'; }
        function performSearch() { currentSearchTerm = document.getElementById('search-popup-input').value.toLowerCase(); filtersActive = true; applyFiltersAndSort(); }
        function clearAllFilters() {
            currentSearchTerm = ''; currentFilter = ''; currentSort = 'name-asc'; filtersActive = false;
            document.getElementById('search-popup-input').value = '';
            document.getElementById('filter-dropdown').value = '';
            const sortDropdown = document.getElementById('inventory-sort');
            if (sortDropdown) sortDropdown.value = 'name-asc';
            applyFiltersAndSort();
        }
        
        window.onclick = function(event) {
            if (event.target === document.getElementById('npc-inventory-modal')) closeNPCInventory();
            if (event.target === document.getElementById('npc-details-modal')) closeNPCDetails();
            if (event.target === document.getElementById('npc-spells-modal')) closeNPCSpells();
            if (event.target === document.getElementById('search-popup')) closeSearchPopup();
            if (event.target === document.getElementById('storage-modal')) closeStorageView();
            if (event.target === document.getElementById('reset-dialog-overlay')) closeResetDialog();
        };
        
        window.onkeydown = function(event) {
            if (event.key === 'Escape') {
                // Check and close media popup if visible
                if (document.getElementById('media-popup').classList.contains('visible')) {
                    hideVideoPopup();
                }
                if (document.getElementById('search-popup').style.display === 'block') closeSearchPopup();
                if (document.getElementById('reset-dialog-overlay').style.display === 'flex') closeResetDialog();
            }
        };
    </script>
    
    <div id="npc-inventory-modal" class="npc-inventory-modal"><div class="npc-inventory-modal-content"><div class="npc-inventory-header"><div id="npc-inventory-title" class="npc-inventory-title"></div><span class="npc-inventory-close" onclick="closeNPCInventory()">&times;</span></div><div id="npc-inventory-body" class="npc-inventory-body"></div></div></div>
    <div id="npc-details-modal" class="npc-details-modal"><div class="npc-details-modal-content"><div class="npc-details-header"><div id="npc-details-title" class="npc-details-title"></div><span class="npc-details-close" onclick="closeNPCDetails()">&times;</span></div><div id="npc-details-body" class="npc-details-body"></div></div></div>
    <div id="npc-spells-modal" class="npc-inventory-modal"><div class="npc-inventory-modal-content"><div class="npc-inventory-header"><div id="npc-spells-modal-title" class="npc-inventory-title">NPC Spells</div><span class="npc-inventory-close" onclick="closeNPCSpells()">&times;</span></div><div id="npc-spells-modal-body" class="npc-inventory-body"></div></div></div>
    
    <!-- Module Creation Progress Modal -->
    <div id="module-progress-modal" class="npc-details-modal" style="display: none;">
        <div class="npc-details-modal-content" style="max-width: 800px; min-height: 500px; position: relative; overflow: hidden;">
            <!-- Dwarf Smith Video Background -->
            <video id="dwarf-smith-video" 
                   style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.25; z-index: 0;" 
                   autoplay loop muted playsinline>
                <source src="/static/media/videos/dwarf_smith_compressed.mp4" type="video/mp4">
            </video>
            <div style="position: relative; z-index: 1; text-align: center; padding: 15px;">
                <div style="display: inline-block; background-color: rgba(44, 44, 44, 0.85); padding: 12px 25px; border-radius: 8px;">
                    <div class="npc-details-title" style="color: #4CAF50; font-size: 22px;">Aye! Forgin' Yer Adventure - Won't Be But a Moment...</div>
                </div>
            </div>
            <div class="npc-details-body" style="padding: 30px; position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: flex-end; min-height: 400px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="display: inline-block; background-color: rgba(28, 28, 28, 0.75); padding: 8px 15px; border-radius: 5px; margin-bottom: 8px;">
                        <span style="font-size: 18px; color: #FFA500; text-shadow: 2px 2px 4px rgba(0,0,0,0.9);">
                            Stage <span id="current-stage">0</span> of <span id="total-stages">9</span>
                        </span>
                    </div>
                    <br>
                    <div style="display: inline-block; background-color: rgba(28, 28, 28, 0.75); padding: 6px 12px; border-radius: 5px;">
                        <span style="font-size: 16px; color: #d4d4d4; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.9);" id="stage-name">Forging module...</span>
                    </div>
                </div>
                <div style="width: 80%; height: 25px; background-color: rgba(44, 44, 44, 0.6); border: 2px solid #4CAF50; border-radius: 4px; overflow: hidden; margin: 20px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                    <div id="module-progress-bar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #66BB6A); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);"></div>
                </div>
                <div style="text-align: center;">
                    <div style="display: inline-block; background-color: rgba(28, 28, 28, 0.75); padding: 8px 20px; border-radius: 5px; margin-bottom: 10px;">
                        <span style="font-size: 28px; color: #4CAF50; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.9);" id="progress-percentage">0%</span>
                    </div>
                    <br>
                    <div style="display: inline-block; background-color: rgba(28, 28, 28, 0.7); padding: 5px 15px; border-radius: 5px;">
                        <span style="color: #a0a0a0; font-style: italic; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.9);" id="progress-message">The forge awakens...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GPT-5 Warning Modal -->
    <div id="gpt5-warning-modal" class="npc-details-modal" style="display: none;">
        <div class="npc-details-modal-content" style="max-width: 600px;">
            <div class="npc-details-header" style="border-bottom: 2px solid #FF6B35;">
                <div class="npc-details-title" style="color: #FFA500;">GPT-5 Model Warning</div>
                <span class="npc-details-close" onclick="closeGPT5Warning()">&times;</span>
            </div>
            <div class="npc-details-body" style="padding: 20px; line-height: 1.6;">
                <p style="color: #4CAF50; font-weight: bold; margin-bottom: 15px;">
                    GPT-5 mini is being tested as a replacement for GPT-4.1
                </p>
                <p style="margin-bottom: 15px;">
                    This experimental model offers <strong style="color: #4CAF50;">significant cost savings</strong> in token utilization while potentially maintaining comparable performance.
                </p>
                <div style="background-color: #3a3a3a; padding: 15px; border-radius: 5px; border-left: 3px solid #4CAF50; margin: 15px 0;">
                    <p style="color: #4CAF50; font-weight: bold; margin-bottom: 10px;">
                        Performance Characteristics:
                    </p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>Slower response times</strong> than GPT-4.1 (especially when using full model)</li>
                        <li><strong>More accurate</strong> and detailed responses expected</li>
                        <li>Please be patient while responses generate</li>
                    </ul>
                </div>
                <div style="background-color: #3a3a3a; padding: 15px; border-radius: 5px; border-left: 3px solid #FFA500; margin: 15px 0;">
                    <p style="color: #FFA500; font-weight: bold; margin-bottom: 10px;">
                        IMPORTANT NOTICE:
                    </p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>This model is currently <strong>UNTESTED</strong> in production</li>
                        <li>May produce <strong>unpredictable results</strong></li>
                        <li>Combat and complex interactions may behave differently</li>
                        <li>GPT-5 is very structured and may <strong>talk out of DM turn</strong>, breaking immersion</li>
                        <li>Use at your own risk during this testing phase</li>
                    </ul>
                </div>
                <p style="margin-top: 15px; text-align: center;">
                    <button onclick="closeGPT5Warning()" style="background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        I Understand - Proceed
                    </button>
                </p>
            </div>
        </div>
    </div>
    <div id="search-popup" class="search-popup"><div class="search-popup-content"><div class="search-popup-header"><div class="search-popup-title">Search Inventory</div><span class="search-popup-close" onclick="closeSearchPopup()">&times;</span></div><input type="text" class="search-popup-input" id="search-popup-input" placeholder="Search items..." onkeyup="performSearch()"></div></div>
    <div id="save-dialog-overlay" class="save-dialog-overlay">
        <div class="save-dialog enhanced-save-dialog">
            <h3>Save Game</h3>
            <div class="save-form">
                <label for="save-description">Description (optional):</label>
                <textarea id="save-description" placeholder="Enter a brief description of your current progress..."></textarea>
                
                <label for="save-mode">Save Type:</label>
                <div class="save-mode-container">
                    <select id="save-mode" onchange="updateSaveModeInfo()">
                        <option value="essential">Game State - Complete Save (Recommended)</option>
                        <option value="full">Archive Edition - Includes Historical Data</option>
                    </select>
                    
                    <div id="save-mode-info" class="save-mode-info">
                        <div class="save-mode-details" id="essential-details">
                            <div class="save-mode-title">
                                <span class="save-icon">💾</span>
                                <strong>Game State Save</strong>
                                <span class="recommended-badge">RECOMMENDED</span>
                            </div>
                            <div class="save-mode-description">
                                Complete game restoration with all essential data:
                                <ul>
                                    <li>✅ Character progress and inventory</li>
                                    <li>✅ Story progress and quest states</li>
                                    <li>✅ Party location and module data</li>
                                    <li>✅ All conversation history</li>
                                    <li>✅ Active encounters and game state</li>
                                </ul>
                                <div class="save-note">Perfect for regular gameplay saves. Faster and smaller file size.</div>
                            </div>
                        </div>
                        
                        <div class="save-mode-details" id="full-details" style="display: none;">
                            <div class="save-mode-title">
                                <span class="save-icon">📚</span>
                                <strong>Archive Edition Save</strong>
                                <span class="archive-badge">COMPLETE ARCHIVE</span>
                            </div>
                            <div class="save-mode-description">
                                Everything from Game State Save plus:
                                <ul>
                                    <li>📜 Extended conversation archives</li>
                                    <li>⚔️ Detailed combat logs and analysis</li>
                                    <li>🗃️ Campaign transition summaries</li>
                                    <li>🤖 Multi-AI conversation tracking</li>
                                    <li>📊 Historical data for review</li>
                                </ul>
                                <div class="save-note">Ideal for DMs, campaign analysis, or long-term archival. Larger file size.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dialog-buttons">
                <button class="dialog-button secondary" onclick="closeSaveDialog()">Cancel</button>
                <button class="dialog-button primary" onclick="performSave()">
                    <span class="button-icon">💾</span>
                    Save Game
                </button>
            </div>
        </div>
    </div>
    <div id="load-dialog-overlay" class="save-dialog-overlay">
        <div class="save-dialog">
            <h3>Load Saved Game</h3>
            <div id="save-list" class="save-list"></div>
            <div class="dialog-buttons">
                <button class="dialog-button secondary" onclick="closeLoadDialog()">Cancel</button>
                <button class="dialog-button danger" onclick="deleteSelectedSave()" id="delete-save-button" disabled>Delete</button>
                <button class="dialog-button primary" onclick="performLoad()" id="load-save-button" disabled>Load Game</button>
            </div>
        </div>
    </div>
    
    <!-- NEW STORAGE MODAL -->
    <div id="storage-modal" class="npc-inventory-modal">
        <div class="npc-inventory-modal-content large-modal-content">
            <div class="npc-inventory-header">
                <div id="storage-modal-title" class="npc-inventory-title">Player Storage</div>
                <span class="npc-inventory-close" onclick="closeStorageView()">&times;</span>
            </div>
            <div id="storage-modal-body" class="npc-inventory-body">
                <!-- Storage content will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- NEW RESET MODAL -->
    <div id="reset-dialog-overlay" class="save-dialog-overlay">
        <div class="save-dialog reset-dialog">
            <h3><span style="color: #f44336;">⚠️</span> CAMPAIGN RESET <span style="color: #f44336;">⚠️</span></h3>
            <div class="reset-warning-container">
                <div class="reset-warning-box">
                    <strong>🔥 WARNING: Complete Campaign Wipe</strong>
                    <p>This will permanently delete your current game progress and return to a fresh campaign start.</p>
                </div>
                
                <div class="reset-info-box">
                    <h4>📋 What This Reset Does:</h4>
                    <ul class="reset-action-list">
                        <li>✅ Creates timestamped backup of your current progress</li>
                        <li>🗑️ Deletes all characters, conversations, and game state</li>
                        <li>🔄 Restores modules from clean system templates</li>
                        <li>🏁 Returns game to first-time startup state</li>
                        <li>🔒 Preserves system files and module templates</li>
                    </ul>
                </div>
                
                <div class="reset-note-box">
                    <strong>💡 Note:</strong> Your current progress will be backed up to <code>modules/backups/campaign_backup_[timestamp]</code> before reset. Module restore points (BU files) are protected and remain intact.
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <p style="color: #ccc;">To confirm, please type the following code into the box below:</p>
                <p id="reset-confirmation-code" style="font-size: 24px; font-weight: bold; color: #4CAF50; letter-spacing: 5px; margin: 10px 0; user-select: none; background: #1a1a1a; padding: 5px; border-radius: 3px;"></p>
                <input type="text" id="reset-code-input" class="save-form input" placeholder="Enter code here" style="width: 100%; text-align: center; font-size: 18px;" oninput="validateResetCode()">
            </div>
            <div class="dialog-buttons">
                <button class="dialog-button secondary" onclick="closeResetDialog()">Cancel</button>
                <button class="dialog-button danger" id="confirm-reset-button" onclick="performCampaignReset()" disabled>Confirm Reset</button>
            </div>
        </div>
    </div>


    <script>
        let selectedSaveFolder = null;
        function openSaveDialog() { document.getElementById('save-dialog-overlay').style.display = 'flex'; document.getElementById('save-description').focus(); }
        function closeSaveDialog() { 
            document.getElementById('save-dialog-overlay').style.display = 'none'; 
            document.getElementById('save-description').value = ''; 
            document.getElementById('save-mode').value = 'essential'; 
            updateSaveModeInfo(); // Reset to default display
        }

        function updateSaveModeInfo() {
            const saveMode = document.getElementById('save-mode').value;
            const essentialDetails = document.getElementById('essential-details');
            const fullDetails = document.getElementById('full-details');
            
            if (saveMode === 'essential') {
                essentialDetails.style.display = 'block';
                fullDetails.style.display = 'none';
            } else {
                essentialDetails.style.display = 'none';
                fullDetails.style.display = 'block';
            }
        }
        function openLoadDialog() { document.getElementById('load-dialog-overlay').style.display = 'flex'; loadSaveGameList(); }
        function closeLoadDialog() { document.getElementById('load-dialog-overlay').style.display = 'none'; selectedSaveFolder = null; updateLoadButtons(); }
        function loadSaveGameList() { const saveList = document.getElementById('save-list'); saveList.innerHTML = 'Loading...'; socket.emit('action', { action: 'listSaves', parameters: {} }); }
        function selectSaveGame(saveFolder, element) { document.querySelectorAll('.save-item').forEach(item => { item.classList.remove('selected'); }); element.classList.add('selected'); selectedSaveFolder = saveFolder; updateLoadButtons(); }
        function updateLoadButtons() {
            const disabled = !selectedSaveFolder;
            document.getElementById('load-save-button').disabled = disabled;
            document.getElementById('delete-save-button').disabled = disabled;
        }
        function performSave() {
            const description = document.getElementById('save-description').value;
            const saveMode = document.getElementById('save-mode').value;
            socket.emit('action', { action: 'saveGame', parameters: { description: description, saveMode: saveMode } });
            closeSaveDialog();
        }
        function performLoad() {
            if (!selectedSaveFolder) return;
            if (confirm('This will restore the selected save and restart the server. Your current progress will be lost. Continue?')) {
                socket.emit('action', { action: 'restoreGame', parameters: { saveFolder: selectedSaveFolder } });
                closeLoadDialog();
            }
        }
        function deleteSelectedSave() {
            if (!selectedSaveFolder) return;
            if (confirm('Delete this save? This cannot be undone.')) {
                socket.emit('action', { action: 'deleteSave', parameters: { saveFolder: selectedSaveFolder } });
                setTimeout(() => loadSaveGameList(), 500);
                selectedSaveFolder = null;
                updateLoadButtons();
            }
        }
        socket.on('save_list_response', (saveGames) => {
            const saveList = document.getElementById('save-list');
            if (saveGames.length === 0) { 
                saveList.innerHTML = '<div style="padding: 40px; text-align: center; color: #999; font-size: 16px;">No save games found.</div>'; 
                return; 
            }
            let html = '';
            saveGames.forEach(save => {
                const modeClass = save.save_mode === 'full' ? 'full' : 'essential';
                const modeBadge = save.save_mode ? `<span class="save-mode-badge ${modeClass}">${save.save_mode}</span>` : '';
                html += `
                    <div class="save-item" onclick="selectSaveGame('${save.save_folder}', this)">
                        <div class="save-item-header">
                            ${save.save_folder}
                            ${modeBadge}
                        </div>
                        <div class="save-item-details">
                            <div class="save-detail-row">
                                <span class="save-detail-label">Date:</span>
                                <span class="save-detail-value date">${save.save_date_readable || 'Unknown'}</span>
                            </div>
                            <div class="save-detail-row">
                                <span class="save-detail-label">Module:</span>
                                <span class="save-detail-value module">${save.module || 'Unknown Module'}</span>
                            </div>
                            <div class="save-detail-row">
                                <span class="save-detail-label">Location:</span>
                                <span class="save-detail-value location">${save.game_state?.current_location || 'Unknown Location'}</span>
                            </div>
                            ${save.description ? `
                            <div class="save-detail-row">
                                <span class="save-detail-label">Notes:</span>
                                <span class="save-detail-value description">${save.description}</span>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            });
            saveList.innerHTML = html;
        });

        function switchCharacterDetailTab(containerId, tabName) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const panes = container.querySelectorAll(".tab-pane");
            panes.forEach(pane => pane.classList.remove("active"));
            const buttons = container.querySelectorAll(".tab-button");
            buttons.forEach(button => button.classList.remove("active"));
            const selectedPane = container.querySelector(`[data-tab="${tabName}"]`);
            const selectedButton = container.querySelector(`[data-tab-btn="${tabName}"]`);
            if (selectedPane) selectedPane.classList.add("active");
            if (selectedButton) selectedButton.classList.add("active");
        }

        // --- UNIVERSAL TOOLTIP SYSTEM ---
        let spellData = null;
        let currentTooltip = null;

        // Load spell data once and cache it
        fetch('/spell-data')
            .then(response => response.json())
            .then(data => { spellData = data; })
            .catch(error => { console.warn('Could not load spell data:', error); spellData = {}; });

        function normalizeSpellName(spellName) {
            return spellName.toLowerCase().replace(/['\s/-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
        }
        
        // 1. Generic Tooltip Creator for Items/Features
        function createGenericTooltip(title, content) {
            const tooltip = document.createElement('div');
            tooltip.className = 'spell-tooltip'; // Reuse the great style
            
            let html = `<div class="spell-tooltip-header">${title}</div>`;
            html += `<div class="spell-tooltip-description">${content}</div>`;
            
            tooltip.innerHTML = html;
            return tooltip;
        }

        // 2. Specialized Tooltip Creator for Spells
        function createSpellTooltip(spellInfo) {
            const tooltip = document.createElement('div');
            tooltip.className = 'spell-tooltip';
            
            let html = `<div class="spell-tooltip-header">${spellInfo.name}</div>`;
            
            const components = [];
            if (spellInfo.components?.verbal) components.push('V');
            if (spellInfo.components?.somatic) components.push('S');
            if (spellInfo.components?.material) components.push('M');
            
            const levelText = spellInfo.level === 0 ? 'Cantrip' : `Level ${spellInfo.level}`;
            html += `<div class="spell-tooltip-meta">${levelText} ${spellInfo.school} • ${spellInfo.casting_time} • ${components.join(', ')}</div>`;
            html += `<div class="spell-tooltip-description">${spellInfo.description}</div>`;
            
            if (spellInfo.classes && spellInfo.classes.length > 0) {
                html += `<div class="spell-tooltip-classes">Classes: ${spellInfo.classes.join(', ')}</div>`;
            }
            
            tooltip.innerHTML = html;
            return tooltip;
        }

        // 3. Centralized Positioning and Hiding Logic
        function positionTooltip(targetElement, tooltipElement) {
            const rect = targetElement.getBoundingClientRect();
            const tooltipRect = tooltipElement.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            let top = rect.top - tooltipRect.height - 8;
            if (top < 8) { top = rect.bottom + 8; }

            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            if (left < 8) { left = 8; } 
            else if (left + tooltipRect.width > viewportWidth - 8) {
                left = viewportWidth - tooltipRect.width - 8;
            }

            tooltipElement.style.left = `${left}px`;
            tooltipElement.style.top = `${top}px`;

            setTimeout(() => {
                if (tooltipElement) {
                    tooltipElement.classList.add('visible');
                }
            }, 10);
        }

        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }

        // 4. Event Handlers
        function showGenericTooltip(event) {
            hideTooltip();
            const target = event.currentTarget;
            const title = target.getAttribute('data-tooltip-title');
            const content = target.getAttribute('data-tooltip-content');
            if (!content) return;
            currentTooltip = createGenericTooltip(title, content);
            document.body.appendChild(currentTooltip);
            positionTooltip(target, currentTooltip);
        }

        function showSpellTooltip(event) {
            if (!spellData) return;
            hideTooltip();
            const spellNameElement = event.currentTarget;
            const spellName = spellNameElement.textContent.trim();
            const normalizedName = normalizeSpellName(spellName);
            const spellInfo = spellData[normalizedName];
            if (!spellInfo) return;
            currentTooltip = createSpellTooltip(spellInfo);
            document.body.appendChild(currentTooltip);
            positionTooltip(spellNameElement, currentTooltip);
        }

        // 5. Master Initializer Function
        function initializeAllTooltips() {
            // Spells
            document.querySelectorAll('.spell-name').forEach(el => {
                el.removeEventListener('mouseenter', showSpellTooltip); // Prevent duplicates
                el.removeEventListener('mouseleave', hideTooltip);
                el.addEventListener('mouseenter', showSpellTooltip);
                el.addEventListener('mouseleave', hideTooltip);
            });

            // Generic items (features, inventory, etc.)
            document.querySelectorAll('[data-tooltip-content]').forEach(el => {
                el.removeEventListener('mouseenter', showGenericTooltip); // Prevent duplicates
                el.removeEventListener('mouseleave', hideTooltip);
                el.addEventListener('mouseenter', showGenericTooltip);
                el.addEventListener('mouseleave', hideTooltip);
            });
        }

        // --- NEW STORAGE FUNCTIONS ---
        // --- START: QUEST JOURNAL LOGIC ---

        // Get references to all the HTML elements we need to work with.
        const journalModal = document.getElementById('journal-modal');
        const journalBtn = document.getElementById('journal-btn');
        const closeBtn = document.querySelector('.close-btn');
        const leftPage = document.getElementById('journal-left-page').querySelector('.page-content');
        const rightPage = document.getElementById('journal-right-page').querySelector('.page-content');

        // --- Event Listeners to open and close the journal ---
        journalBtn.onclick = function() {
            journalModal.style.display = 'block';
            // Every time the journal is opened, ask the server for the latest quest data.
            socket.emit('request_plot_data');
        }
        closeBtn.onclick = function() {
            journalModal.style.display = 'none';
        }
        window.onclick = function(event) {
            // This allows the user to close the journal by clicking on the dark background.
            if (event.target == journalModal) {
                journalModal.style.display = 'none';
            }
        }

        // --- Listen for the server's response with quest data ---
        socket.on('plot_data_response', function(response) {
            if (response.error || !response.data || !response.data.plotPoints) {
                console.error('Error fetching plot data:', response.error || 'No plot data available.');
                leftPage.innerHTML = '<h2>Journal</h2><p>Could not load quest data.</p>';
                rightPage.innerHTML = '';
                return;
            }

            // Clear out the old content from the pages.
            leftPage.innerHTML = '';
            rightPage.innerHTML = '';

            // --- THIS IS THE KEY CHANGE ---
            // Filter out any quests that the player hasn't discovered yet.
            const allQuests = response.data.plotPoints.filter(q => q.status !== 'not started');

            // Now, separate the *discovered* quests into active and completed.
            const activeQuests = allQuests.filter(q => q.status !== 'completed');
            const completedQuests = allQuests.filter(q => q.status === 'completed');

            // --- A helper function to build the HTML for a list of quests ---
            function renderQuestsToHTML(quests) {
                let html = '';
                quests.forEach(point => {
                    // Determine the correct class based on completion status.
                    const itemClass = point.status === 'completed' ? 'quest-item completed' : 'quest-item';
                    
                    // Start building the HTML for this quest entry.
                    html += `<div class="${itemClass}">`;
                    html += `<h3 class="quest-title">${point.title}</h3>`;
                    html += `<p class="quest-description">${point.description}</p>`;

                    // If there are side quests, filter them as well before displaying.
                    if (point.sideQuests && point.sideQuests.length > 0) {
                        const discoveredSideQuests = point.sideQuests.filter(sq => sq.status !== 'not started');
                        
                        discoveredSideQuests.forEach(sq => {
                            const sqClass = sq.status === 'completed' ? 'quest-item side-quest-item completed' : 'quest-item side-quest-item';
                            html += `<div class="${sqClass}">`;
                            html += `<h4 class="quest-title">${sq.title}</h4>`;
                            html += `<p class="quest-description">${sq.description}</p>`;
                            html += `</div>`;
                        });
                    }
                    html += `</div>`; // Close the main quest-item div
                });
                return html;
            }

            // --- Populate the pages ---
            // Left Page: Active Quests
            leftPage.innerHTML = '<h2>Current Objectives</h2>' + renderQuestsToHTML(activeQuests);

            // Right Page: Completed Quests
            rightPage.innerHTML = '<h2>A Chronicle of Deeds</h2>' + renderQuestsToHTML(completedQuests);
        });

        // --- Automatically refresh data to keep the journal up to date ---
        // We need to make sure we ask for new quest data after the player does something.
        function requestPlotData() {
            socket.emit('request_plot_data');
        }

        // --- END: QUEST JOURNAL LOGIC ---
        
        function openStorageView() {
            const body = document.getElementById('storage-modal-body');
            body.innerHTML = '<div class="loading">Fetching storage data...</div>';
            document.getElementById('storage-modal').style.display = 'flex';
            socket.emit('request_storage_data');
        }

        function closeStorageView() {
            document.getElementById('storage-modal').style.display = 'none';
        }

        socket.on('storage_data_response', (response) => {
            const storageData = response.data;
            const body = document.getElementById('storage-modal-body');
            
            if (!storageData || !storageData.success || storageData.count === 0) {
                body.innerHTML = '<div class="loading">No player storage found.</div>';
                return;
            }

            let html = '';
            storageData.storage.forEach(container => {
                html += `<div class="storage-container">
                            <div class="storage-container-header">
                                <span class="storage-name">${container.name}</span>
                                <span class="storage-location">${container.location}</span>
                            </div>
                            <ul class="storage-item-list">`;
                
                if (container.contents && container.contents.length > 0) {
                    container.contents.forEach(item => {
                        html += `<li class="storage-item-entry">
                                    <span class="storage-item-name">${item.item_name}</span> 
                                    <span class="storage-item-quantity">(x${item.quantity})</span>
                                 </li>`;
                    });
                } else {
                    html += '<li class="storage-item-entry">This container is empty.</li>';
                }
                
                html += `   </ul>
                         </div>`;
            });

            body.innerHTML = html;
        });

        // --- NEW CAMPAIGN RESET FUNCTIONS ---
        let currentResetCode = '';

        function openResetDialog() {
            const overlay = document.getElementById('reset-dialog-overlay');
            if (!overlay) return;

            currentResetCode = Math.floor(10000 + Math.random() * 90000).toString();
            
            document.getElementById('reset-confirmation-code').textContent = currentResetCode;
            document.getElementById('reset-code-input').value = '';
            document.getElementById('confirm-reset-button').disabled = true;

            overlay.style.display = 'flex';
            document.getElementById('reset-code-input').focus();
        }

        function closeResetDialog() {
            const overlay = document.getElementById('reset-dialog-overlay');
            if (overlay) overlay.style.display = 'none';
            currentResetCode = '';
        }

        function validateResetCode() {
            const input = document.getElementById('reset-code-input').value;
            const confirmButton = document.getElementById('confirm-reset-button');
            confirmButton.disabled = (input !== currentResetCode);
        }

        function performCampaignReset() {
            const input = document.getElementById('reset-code-input').value;
            if (input !== currentResetCode) {
                alert('Confirmation code is incorrect.');
                return;
            }

            addMessage('game-output', { type: 'system', content: 'Campaign reset initiated... The application will become unresponsive and may require a manual restart after the process completes.' });
            socket.emit('action', { action: 'nuclearReset', parameters: {} });
            closeResetDialog();

            // Disable all controls as the backend is about to do something drastic
            document.getElementById('user-input').disabled = true;
            document.getElementById('send-button').disabled = true;
            document.querySelectorAll('.save-load-buttons button').forEach(b => b.disabled = true);
        }

        // --- NEW SOCKET LISTENERS FOR RESTORE/RESET ---
        socket.on('system_message', (data) => {
            addMessage('game-output', { type: 'system', content: data.content });
        });

        socket.on('restore_complete', (data) => {
            console.log('Restore complete signal received:', data.message);
            addMessage('game-output', { type: 'system', content: 'Game restored successfully. The page will now reload to sync with the new state.' });
            
            setTimeout(() => {
                window.location.reload();
            }, 2000); 
        });

        socket.on('reset_complete', (data) => {
            console.log('Reset complete signal received:', data.message);
            addMessage('game-output', { type: 'system', content: 'Campaign has been reset. The page will now reload.' });
            
            setTimeout(() => {
                window.location.reload();
            }, 2000); 
        });
        
        // Exit game functionality
        function exitGame() {
            // Show confirmation dialog
            const confirmExit = confirm('Are you sure you want to exit the game?');
            
            if (confirmExit) {
                // Notify server of intentional exit
                if (connected) {
                    socket.emit('user_exit');
                }
                
                // Try to close the window/tab
                const windowClosed = window.close();
                
                // If window.close() didn't work (common in modern browsers)
                if (!windowClosed) {
                    // Show a message to the user
                    const exitMessage = document.createElement('div');
                    exitMessage.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background-color: #2c2c2c;
                        border: 2px solid #8B0000;
                        padding: 30px;
                        border-radius: 10px;
                        text-align: center;
                        z-index: 10000;
                        box-shadow: 0 0 20px rgba(0,0,0,0.5);
                    `;
                    exitMessage.innerHTML = `
                        <h2 style="color: #4CAF50; margin-bottom: 20px;">Thank you for playing!</h2>
                        <p style="margin-bottom: 20px;">You can now safely close this browser tab.</p>
                        <p style="color: #888; font-size: 14px;">Due to browser security, we cannot close this tab automatically.</p>
                    `;
                    document.body.appendChild(exitMessage);
                    
                    // Optionally disable the game interface
                    document.getElementById('user-input').disabled = true;
                    document.getElementById('send-button').disabled = true;
                }
            }
        }

    </script>
    
    <!-- Unified Media Popup Modal -->
    <div id="media-popup" class="video-popup">
        <div class="video-popup-content">
            <video id="popup-video" style="display: none;" autoplay loop muted playsinline></video>
            <img id="popup-image" style="display: none; width: 100%; height: auto; border-radius: 5px;" src="" alt="Character Portrait"/>
        </div>
    </div>
    
</body>
</html>