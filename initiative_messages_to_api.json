[
  {
    "role": "system",
    "content": "@ROLE={you_are:\"INITIATIVE COORDINATOR tracking combat flow\",job:\"Track who acted and provide CLEAR INSTRUCTIONS for turn_window\"}\n\n@INPUT={\n  current_round:\"integer from combat_round field (use exactly as given)\",\n  player_name:\"CRITICAL: exact PC name from 'player_name:' field in ROUND INFO (e.g., 'Aldric', 'Bob', etc.)\",\n  initiative_order:\"list of ALL creatures with (Initiative) - may include (player) tags which you MUST remove\",\n  recent_conversation:\"narration showing who acted THIS ROUND\"\n}\n\n@OUTPUT_CONTRACT={\n  sections_in_order: [\n    \"--- ROUND INFO ---\",\n    \"combat_round: <int>\",\n    \"player_name: <exact PC name>\",\n    \"--- LIVE TRACKER ---\",\n    \"**Live Initiative Tracker:**\",\n    \"<acted/dead/waiting lines>\",\n    \"<EXACTLY ONE instruction block>\",\n    \"<OPTIONAL: --- NAME HINTS --->\"\n  ],\n  authoritative: \"The instruction block defines the turn_window the Combat Sim MUST consume\",\n  ascii_only: \"No curly quotes or em/en dashes\",\n  exactly_one_instruction_block: true\n}\n\n@INSTRUCTION_BLOCKS={\n  CASE_A_npcs_before_player: {\n    header: \">>> PROCESS ALL OF THESE IN ONE RESPONSE (Initiative Order):\",\n    list: [\"<Non-player or allied NPC 1>\", \"<...>\", \"<Non-player or allied NPC N>\"],\n    stop: \">>> THEN STOP AT: <player_name> (Player)\"\n  },\n\n  CASE_B_player_turn_now: {\n    header: \">>> CURRENT: <player_name> (<initiative>) - PLAYER TURN (await input)\"\n  },\n\n  CASE_C_finish_to_end_round: {\n    header: \">>> PROCESS TO END ROUND:\",\n    list: [\"<Remaining non-player/allied NPCs after player>\"],\n    footer: \">>> THEN: End Round <X>, Start Round <X+1>\"\n  },\n\n  CASE_D_round_complete: {\n    header: \">>> ROUND COMPLETE\",\n    footer: \"All creatures have acted. Increment combat_round.\"\n  }\n}\n\n@NAME_HINTS_SECTION={\n  header: \"--- NAME HINTS ---\",\n  example: [\n    \"Skeleton_5: the fifth skeleton\",\n    \"Skeleton_4: the shield-bearing skeleton\"\n  ]\n}\n\n@DECISION_LOGIC={\n  identify_player: \"Use EXACT name from 'player_name:' field in ROUND INFO (NOT from (player) tags)\",\n  non_player_definition: \"ALL creatures EXCEPT the one matching player_name field (monsters + allied NPCs)\",\n  compute_state: \"from tracker lines [X]/[>]/[ ]/[D]\",\n  choose_case: [\n    \"FIRST CHECK: If ALL living are [X] or [D] -> CASE_D_round_complete (takes precedence)\",\n    \"Else if next to act is player_name -> CASE_B_player_turn_now\",\n    \"Else if player_name not yet acted and non_players precede -> CASE_A_npcs_before_player\",\n    \"Else if player_name has acted and non_players remain -> CASE_C_finish_to_end_round\"\n  ],\n  preserve_tie_order: \"Maintain input order for same-initiative ties\",\n  critical_rule: \"NPCs with titles (Scout, Ranger, Guard, Captain, etc.) go in PROCESS ALL blocks, NOT player turns\"\n}\n\n@EXAMPLES={\n  example1_npcs_before_player: \"Initiative: Goblin(20), Orc(15), Wolf(12), Bob(10), Kobold(5)\\nBob is player. Goblin acted.\\n\\n**Live Initiative Tracker:**\\n- [X] Goblin (20) - Acted\\n\\n>>> PROCESS ALL OF THESE IN ONE RESPONSE (Initiative Order):\\n- Orc (15)\\n- Wolf (12)\\n>>> THEN STOP AT: Bob (Player)\\n\\n- [ ] Kobold (5) - After Player\\n\\n--- NAME HINTS ---\\nOrc: the brutish orc\\nWolf: the snarling wolf\",\n  \n  example2_player_turn: \"All monsters acted, now Bob's turn:\\n\\n**Live Initiative Tracker:**\\n- [X] Goblin (20) - Acted\\n- [X] Orc (15) - Acted\\n- [X] Wolf (12) - Acted\\n\\n>>> CURRENT: Bob (10) - PLAYER TURN (await input)\\n\\n- [ ] Kobold (5) - Waiting\",\n  \n  example3_ending_round: \"Bob just acted, Kobold remains:\\n\\n**Live Initiative Tracker:**\\n- [X] Goblin (20) - Acted\\n- [X] Orc (15) - Acted\\n- [X] Wolf (12) - Acted\\n- [X] Bob (10) - Acted\\n\\n>>> PROCESS TO END ROUND:\\n- Kobold (5)\\n>>> THEN: End Round 1, Start Round 2\",\n  \n  example4_round_complete: \"Everyone has acted:\\n\\n**Live Initiative Tracker:**\\n- [X] Goblin (20) - Acted\\n- [X] Orc (15) - Acted\\n- [X] Wolf (12) - Acted\\n- [X] Bob (10) - Acted\\n- [X] Kobold (5) - Acted\\n\\n>>> ROUND COMPLETE\\nAll creatures have acted. Increment combat_round.\",\n  \n  example5_npcs_with_titles: \"player_name: Aldric\\nInitiative with titled NPCs:\\n\\n**Live Initiative Tracker:**\\n- [D] Zombie_1 (20) - Dead\\n- [ ] Guard Marcus (20) - Waiting\\n- [ ] Goblin_2 (18) - Waiting\\n- [ ] Captain Vale (12) - Waiting\\n- [ ] Aldric (5) - Waiting\\n- [ ] Scout Jenna (4) - Waiting\\n\\n>>> PROCESS ALL OF THESE IN ONE RESPONSE (Initiative Order):\\n- Guard Marcus (20)\\n- Goblin_2 (18)\\n- Captain Vale (12)\\n>>> THEN STOP AT: Aldric (Player)\\n\\n- [ ] Scout Jenna (4) - After Player\"\n}\n\n@CRITICAL_RULES={\n  turn_window_is_authoritative: \"The PROCESS/FINISH block defines turn_window consumed by Combat Sim\",\n  include_all_non_players: \"Include all monsters + allied NPCs before the player in CASE_A\",\n  name_hints_optional: \"OPTIONAL: emit --- NAME HINTS --- as alias map for narration\",\n  no_CURRENT_TURN_section: \"NEVER emit a '--- CURRENT TURN ---' block (enforced)\",\n  use_exact_names_only: \"Use exact names from INPUT without role tags in tracker lines\",\n  no_role_tags_in_lines: \"DO NOT annotate names with '(player)' in initiative lines; only in instruction block\",\n  include_player_tag_only_in_instruction_block: true,\n  maintain_order: \"Maintain strict initiative order within process groups\",\n  skip_dead: \"Dead creatures marked [D] are skipped in processing lists\"\n}\n\n@ROUND_ADVANCEMENT={\n  tracker_signals_completion: [\n    \"If all living are [X] or [D] -> emit CASE_D '>>> ROUND COMPLETE'\",\n    \"If processing to end round -> emit CASE_C with 'End Round X, Start Round Y'\"\n  ],\n  never_premature: \"Never signal round complete until all living have acted\"\n}\n\n@LINE_FORMAT={\n  tracker_line_format: \"- [status] CreatureName (initiative) - State\",\n  correct_examples: [\n    \"- [X] Guard Marcus (20) - Acted\",\n    \"- [ ] Aldric (5) - Waiting\",\n    \"- [D] Zombie_1 (20) - Dead\"\n  ],\n  incorrect_examples: [\n    \"- [X] Aldric (player) (5) - Acted  // WRONG: has (player) tag\",\n    \"- [X] Guard Marcus (NPC) (20) - Acted  // WRONG: has role tag\"\n  ],\n  rule: \"STRIP ALL role tags like (player) from tracker lines - use clean names only\",\n  instruction_block_only: \"Player designation appears ONLY in instruction blocks: '>>> THEN STOP AT: [PlayerName] (Player)'\"\n}\n- The PROCESS ALL block defines the authoritative turn_window for the combat DM\n- Non-player = monsters + allied NPCs (they must be included in PROCESS ALL list before the player)"
  },
  {
    "role": "user",
    "content": "--- ROUND INFO ---\ncombat_round: 2\nplayer_name: Eirik Hearthwise\n\nINITIATIVE ORDER:\n- Sahuagin (17) - dead\n- Scout Elen (15) - alive\n- Ranger Thane (11) - alive\n- Scout Kira (7) - alive\n- Eirik Hearthwise (1) - alive\n\n--- RECENT COMBAT CONVERSATION ---\n\nDM: {\n  \"plan\": \"Player Eirik Hearthwise completes the final action of round 1 with a missed mace attack against the sahuagin. No HP or state changes occur. All living creatures have now acted in this round. End of round reached; combat_round will increment to 2 at the start of the next response.\",\n  \"narration\": \"You heft your mace and swing with force, but the battered sahuagin twists aside, your weapon smashing harmlessly into the warped dock. The blow sends a sharp crack through the planks and salt dust into the air. For a heartbeat, the only sounds are ragged breathing and the relentless crash of the sea below. The round draws to a close as your allies steady themselves for what comes next.\",\n  \"combat_round\": 1,\n  \"actions\": []\n}\n\nPlayer: --- ROUND INFO ---\ncombat_round: 1\nplayer_name: Eirik Hearthwise\n\n--- LIVE TRACKER ---\n**Live Initiative Tracker:**\n- [X] Sahuagin (17) - Acted\n- [X] Scout Elen (15) - Acted\n- [X] Ranger Thane (11) - Acted\n- [X] Scout Kira (7) - Acted\n- [X] Eirik Hearthwise (1) - Acted\n\n>>> ROUND COMPLETE\nAll creatures have acted. Increment combat_round.\n\n--- NAME HINTS ---\nScout Elen: your allied scout, bow drawn\nRanger Thane: your seasoned ranger companion\nScout Kira: the quick-footed scout\n--- CREATURE STATES ---\nEirik Hearthwise: HP 27/45, alive, Spell Slots: L1:1/4 L2:2/3 L3:0/2\nSahuagin: HP 1/22, alive\nScout Kira: HP 40/45, alive\nScout Elen: HP 33/36, alive, Spell Slots: L1:3/4 L2:2/2\nRanger Thane: HP 43/55, alive, Spell Slots: L1:4/4 L2:2/2\n\n--- DICE POOLS ---\nRules:\n- Player characters always roll their own dice\n- NPCs/monsters use pre-rolled dice pools exactly\n- Do not reuse dice; consume in order\n- For NPC/Monster ATTACK: use CREATURE ATTACKS list\n- For NPC/Monster SAVES: use SAVING THROWS list  \n- For damage/spells/other: use GENERIC DICE pool\n\nDM Note: COMBAT ROUND 1 - DICE AVAILABLE:\nPreroll Set ID: 1-7757 (Generated at round start)\n\nCRITICAL DICE USAGE:\n- For NPC/Monster ATTACKS, you MUST use a die from the \"CREATURE ATTACKS\" list for that specific creature.\n- For NPC/Monster SAVING THROWS, you MUST use a die from the \"SAVING THROWS\" list.\n- The \"GENERIC DICE\" pool is ONLY for damage rolls, spell effects, or other non-attack/non-save rolls.\n- FAILURE TO USE THE CORRECT POOL IS A CRITICAL ERROR.\n\n=== GENERIC DICE (use for spells, abilities, improvisation) ===\nd4: [4,4,3,4,3,2,3,2] | d6: [2,4,5,6,6,2,6,2] | d8: [1,3,6,1,6,6] | d10: [2,5,5,3,5,6] | d12: [2,9,5,12] | d20: [14,3,19,17,6,15,16,12,18,5]\n\n=== CREATURE ATTACKS (exact number per creature) ===\n[PLAYER: Eirik Hearthwise] Must make own rolls\nSahuagin: Attack[17], Attack[14], Attack[16], Attack[5], Attack[8] (5 attacks available: Multiattack, Bite, Claw, Spear (Melee), Spear (Ranged))\nScout Kira: Attack[8] (1 attack available: Shortbow Shot)\nScout Elen: Attack[8], Attack[3] (2 attacks available: Longbow, Shortsword)\nRanger Thane: Attack[18], Attack[19] (2 attacks available: Longbow, Shortsword)\n\n=== SAVING THROWS ===\nSahuagin: STR:1, DEX:9, CON:3, INT:11, WIS:14, CHA:16\nScout Kira: STR:8, DEX:16, CON:12, INT:5, WIS:4, CHA:3\nScout Elen: STR:18, DEX:1, CON:16, INT:16, WIS:5, CHA:12\nRanger Thane: STR:17, DEX:12, CON:1, INT:20, WIS:5, CHA:6\n\nIMPORTANT: Each creature can only make the number of attacks listed above.\nUse generic dice pool for damage rolls, spells, and other abilities.\nApply all appropriate modifiers (ability scores, proficiency, weapon bonuses, etc.).\nNote: Eirik Hearthwise must make their own rolls.\n\nCOMBAT TRACKING: You MUST include \"combat_round\" field in your JSON response.\nTrack combat rounds: increment ONLY when ALL alive creatures have completed their turns in initiative order.\nThese dice remain constant throughout the current round.\n\n--- RULES ---\n- Initiative must be followed strictly\n- Only increment combat_round after all alive creatures have acted\n- Status updates must be reflected in JSON \"actions\"\n- Do not narrate beyond current round\n\n--- PLAYER ACTION ---\nBe ready!\n\n--- REQUIRED RESPONSE ---\n1. Narrate and resolve actions for all NPCs/monsters in initiative order until:\n   - The LAST creature in this round has acted, OR\n   - Initiative returns to the player\n2. Stop narration at that point\n3. Return structured JSON with plan, narration, combat_round, and actions\n\nDM: {\n  \"plan\": \"End of round 1 reached. All living creatures have acted. Increment combat_round to 2 and stop. No actions to process this step.\",\n  \"narration\": \"As the echoes of battle fade, the dock creaks beneath your feet and a cold wind sweeps in from the sea. Blood and saltwater pool between the planks. Your allies tense, weapons ready, eyes fixed on the battered sahuagin still standing—barely. The moonlight glimmers on arrow shafts and the glistening scales of your foe. A new round begins.\",\n  \"combat_round\": 2,\n  \"actions\": []\n}\n\nPlayer: --- ROUND INFO ---\ncombat_round: 2\nplayer_name: Eirik Hearthwise\n\n--- LIVE TRACKER ---\n**Live Initiative Tracker:**\n- [ ] Sahuagin (17) - Waiting\n- [ ] Scout Elen (15) - Waiting\n- [ ] Ranger Thane (11) - Waiting\n- [ ] Scout Kira (7) - Waiting\n- [ ] Eirik Hearthwise (1) - Waiting\n\n>>> PROCESS ALL OF THESE IN ONE RESPONSE (Initiative Order):\n- Sahuagin (17)\n- Scout Elen (15)\n- Ranger Thane (11)\n- Scout Kira (7)\n>>> THEN STOP AT: Eirik Hearthwise (Player)\n\n--- NAME HINTS ---\nScout Elen: your allied scout, bow drawn\nRanger Thane: your seasoned ranger companion\nScout Kira: the quick-footed scout\n--- CREATURE STATES ---\nEirik Hearthwise: HP 27/45, alive, Spell Slots: L1:1/4 L2:2/3 L3:0/2\nSahuagin: HP 1/22, alive\nScout Kira: HP 40/45, alive\nScout Elen: HP 33/36, alive, Spell Slots: L1:3/4 L2:2/2\nRanger Thane: HP 43/55, alive, Spell Slots: L1:4/4 L2:2/2\n\n--- DICE POOLS ---\nRules:\n- Player characters always roll their own dice\n- NPCs/monsters use pre-rolled dice pools exactly\n- Do not reuse dice; consume in order\n- For NPC/Monster ATTACK: use CREATURE ATTACKS list\n- For NPC/Monster SAVES: use SAVING THROWS list  \n- For damage/spells/other: use GENERIC DICE pool\n\nDM Note: COMBAT ROUND 2 - DICE AVAILABLE:\nPreroll Set ID: 2-3216 (Generated at round start)\n\nCRITICAL DICE USAGE:\n- For NPC/Monster ATTACKS, you MUST use a die from the \"CREATURE ATTACKS\" list for that specific creature.\n- For NPC/Monster SAVING THROWS, you MUST use a die from the \"SAVING THROWS\" list.\n- The \"GENERIC DICE\" pool is ONLY for damage rolls, spell effects, or other non-attack/non-save rolls.\n- FAILURE TO USE THE CORRECT POOL IS A CRITICAL ERROR.\n\n=== GENERIC DICE (use for spells, abilities, improvisation) ===\nd4: [4,3,2,2,2,2,1,2] | d6: [1,2,1,5,5,4,1,6] | d8: [1,3,5,1,7,2] | d10: [3,3,2,1,9,8] | d12: [1,3,12,2] | d20: [16,9,15,7,15,4,15,13,9,9]\n\n=== CREATURE ATTACKS (exact number per creature) ===\n[PLAYER: Eirik Hearthwise] Must make own rolls\nSahuagin: Attack[2], Attack[7], Attack[4], Attack[17], Attack[7] (5 attacks available: Multiattack, Bite, Claw, Spear (Melee), Spear (Ranged))\nScout Kira: Attack[13] (1 attack available: Shortbow Shot)\nScout Elen: Attack[15], Attack[18] (2 attacks available: Longbow, Shortsword)\nRanger Thane: Attack[2], Attack[13] (2 attacks available: Longbow, Shortsword)\n\n=== SAVING THROWS ===\nSahuagin: STR:12, DEX:11, CON:2, INT:1, WIS:19, CHA:5\nScout Kira: STR:3, DEX:20, CON:1, INT:1, WIS:19, CHA:7\nScout Elen: STR:2, DEX:11, CON:18, INT:3, WIS:10, CHA:14\nRanger Thane: STR:17, DEX:16, CON:14, INT:6, WIS:10, CHA:13\n\nIMPORTANT: Each creature can only make the number of attacks listed above.\nUse generic dice pool for damage rolls, spells, and other abilities.\nApply all appropriate modifiers (ability scores, proficiency, weapon bonuses, etc.).\nNote: Eirik Hearthwise must make their own rolls.\n\nCOMBAT TRACKING: You MUST include \"combat_round\" field in your JSON response.\nTrack combat rounds: increment ONLY when ALL alive creatures have completed their turns in initiative order.\nThese dice remain constant throughout the current round.\n\n--- RULES ---\n- Initiative must be followed strictly\n- Only increment combat_round after all alive creatures have acted\n- Status updates must be reflected in JSON \"actions\"\n- Do not narrate beyond current round\n\n--- PLAYER ACTION ---\nAnyone need a heal yet?\n\n--- REQUIRED RESPONSE ---\n1. Narrate and resolve actions for all NPCs/monsters in initiative order until:\n   - The LAST creature in this round has acted, OR\n   - Initiative returns to the player\n2. Stop narration at that point\n3. Return structured JSON with plan, narration, combat_round, and actions\n\nDM: {\n  \"plan\": \"Processing turn_window: Sahuagin, Scout Elen, Ranger Thane, Scout Kira. 1. Sahuagin, at 1 HP, makes a desperate Multiattack: Bite at Ranger Thane (attack preroll [2]+3=5 vs AC 15, miss), Claw 1 at Scout Elen (attack preroll [7]+3=10 vs AC 16, miss), Claw 2 at Kira (attack preroll [4]+3=7 vs AC 16, miss). 2. Scout Elen attacks sahuagin with longbow: attack preroll [15]+6=21 vs AC 12 (hit), damage d8[1]+4=5. Expends 1 arrow. Sahuagin reduced to 0 HP and dies. 3. Ranger Thane and Scout Kira have no living enemy to target; their actions are withheld. Routing: Elen's ammo -> updateCharacterInfo; sahuagin HP/death -> updateEncounter. Stopping because next actor is Eirik Hearthwise (player).\",\n  \"narration\": \"The battered sahuagin, blood streaming from a dozen wounds, snarls and thrashes in a last frenzy. Its jaws snap at Thane, missing by a hand's breadth. Claws swish through empty air as Elen and Kira dart back, boots scraping across slick, salt-glazed planks. Elen doesn't hesitate—a single arrow whistles through the night, striking deep beneath the creature's jaw. With a guttural choke, the sahuagin collapses, its body thudding against the dock. The storm-tossed sea below seems to hush for a moment. No other foes remain.\",\n  \"combat_round\": 2,\n  \"actions\": [\n    {\n      \"action\": \"updateCharacterInfo\",\n      \"parameters\": {\n        \"characterName\": \"Scout Elen\",\n        \"changes\": \"Expended 1 arrow.\"\n      }\n    },\n    {\n      \"action\": \"updateEncounter\",\n      \"parameters\": {\n        \"encounterId\": \"L03-E4\",\n        \"changes\": \"Sahuagin takes 5 piercing from Elen's arrow (HP 1->0) and is now dead.\"\n      }\n    }\n  ]\n}\n"
  },
  {
    "role": "assistant",
    "content": "--- ROUND INFO ---\ncombat_round: 2\nplayer_name: Eirik Hearthwise\n\n--- LIVE TRACKER ---\n**Live Initiative Tracker:**\n- [X] Sahuagin (17) - Acted\n- [X] Scout Elen (15) - Acted\n- [X] Ranger Thane (11) - Acted\n- [X] Scout Kira (7) - Acted\n- [ ] Eirik Hearthwise (1) - Waiting\n\n>>> CURRENT: Eirik Hearthwise (1) - PLAYER TURN (await input)\n\n--- NAME HINTS ---\nScout Elen: your allied scout, bow drawn\nRanger Thane: your seasoned ranger companion\nScout Kira: the quick-footed scout"
  }
]